# æ¶æ„ä¿®å¤æŠ¥å‘Šï¼šç§»é™¤ç¡¬ç¼–ç ç«¯å£ï¼Œç›´æ¥è°ƒç”¨ Runner

**ä¿®å¤æ—¥æœŸ**: 2026-01-30 16:07
**é—®é¢˜**: ChatEngine é€šè¿‡ HTTP è°ƒç”¨è‡ªå·±çš„ APIï¼Œå¯¼è‡´ç«¯å£ç¡¬ç¼–ç å’Œè¶…æ—¶é—®é¢˜
**çŠ¶æ€**: âœ… **å·²ä¿®å¤**

---

## ğŸ› é—®é¢˜æè¿°

### åŸæœ‰æ¶æ„ï¼ˆé”™è¯¯ï¼‰
```
User Input â†’ ChatEngine â†’ HTTP POST localhost:8888/9090
  â†’ Execute API â†’ Runner â†’ Result
  â†’ HTTP GET localhost:8888/9090/runs/{id}
  â†’ Return to ChatEngine
```

**é—®é¢˜**:
1. âŒ **ç¡¬ç¼–ç ç«¯å£**: ChatEngine ä¸­å†™æ­»ç«¯å£å·ï¼ˆå…ˆ 8888ï¼Œåæ”¹ 9090ï¼‰
2. âŒ **HTTP è¶…æ—¶**: å³ä½¿æ”¹åˆ° 30 ç§’è¿˜æ˜¯è¶…æ—¶
3. âŒ **æ¶æ„ä¸åˆç†**: åŒä¸€è¿›ç¨‹å†…é€šè¿‡ HTTP è°ƒç”¨è‡ªå·±
4. âŒ **æ•ˆç‡ä½**: HTTP å¾€è¿”å¼€é”€å¤§
5. âŒ **ç»´æŠ¤å›°éš¾**: ç«¯å£å˜æ›´éœ€è¦ä¿®æ”¹å¤šå¤„

### é”™è¯¯çš„è§£å†³å°è¯•
1. ç¬¬ä¸€æ¬¡ï¼šæ”¹ç«¯å£ 8888 â†’ 9090 âŒ
2. ç¬¬äºŒæ¬¡ï¼šå¢åŠ  timeout 5s â†’ 30s âŒ
3. éƒ½å¤±è´¥ï¼Œå› ä¸ºæ¶æ„æœ¬èº«å°±é”™äº†

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### æ–°æ¶æ„ï¼ˆæ­£ç¡®ï¼‰
```
User Input â†’ ChatEngine â†’ ç›´æ¥è°ƒç”¨ Runner â†’ Result
```

**ä¼˜åŠ¿**:
1. âœ… **æ— ç¡¬ç¼–ç **: ä¸å†éœ€è¦ç«¯å£å·
2. âœ… **æ— è¶…æ—¶é—®é¢˜**: ç›´æ¥å‡½æ•°è°ƒç”¨
3. âœ… **æ¶æ„æ¸…æ™°**: åˆ†å±‚åˆç†
4. âœ… **æ•ˆç‡é«˜**: æ—  HTTP å¼€é”€
5. âœ… **æ˜“ç»´æŠ¤**: ç«¯å£å˜æ›´ä¸å½±å“

---

## ğŸ“ ä¿®æ”¹è¯¦æƒ…

### æ–‡ä»¶
`agentos/core/chat/engine.py`

### æ–¹æ³•
`_execute_extension_command()`

### ä¿®æ”¹å†…å®¹

#### ä¿®æ”¹å‰ï¼ˆé”™è¯¯ï¼‰
```python
def _execute_extension_command(self, session_id, route, stream=False):
    import requests
    import time

    # âŒ ç¡¬ç¼–ç ç«¯å£
    execute_url = "http://localhost:9090/api/extensions/execute"

    # âŒ HTTP POST è°ƒç”¨
    resp = requests.post(execute_url, json=payload, timeout=30)
    run_id = resp.json()["run_id"]

    # âŒ HTTP è½®è¯¢
    status_url = f"http://localhost:9090/api/runs/{run_id}"
    while elapsed < max_wait:
        status_resp = requests.get(status_url, timeout=10)
        # è½®è¯¢ç›´åˆ°å®Œæˆæˆ–è¶…æ—¶
```

**é—®é¢˜**:
- 170+ è¡Œä»£ç 
- ç¡¬ç¼–ç ç«¯å£
- HTTP å¾€è¿”
- è½®è¯¢ç­‰å¾…
- è¶…æ—¶å¤„ç†å¤æ‚

#### ä¿®æ”¹åï¼ˆæ­£ç¡®ï¼‰
```python
def _execute_extension_command(self, session_id, route, stream=False):
    from agentos.core.capabilities.runner_base import get_runner
    from agentos.core.capabilities.runner_base.base import Invocation

    # âœ… åˆ›å»º Invocation
    invocation = Invocation(
        extension_id=route.extension_id,
        action=route.action_id or "default",
        args=route.args,
        context={"session_id": session_id, "command_name": route.command_name}
    )

    # âœ… è·å– Runner
    runner = get_runner(route.runner)

    # âœ… ç›´æ¥æ‰§è¡Œ
    result = runner.run(invocation)

    # âœ… è¿”å›ç»“æœ
    result_message = result.output if result.success else f"Execution failed: {result.error}"
```

**ä¼˜åŠ¿**:
- ~80 è¡Œä»£ç ï¼ˆå‡å°‘ 50%ï¼‰
- æ— ç¡¬ç¼–ç 
- æ—  HTTP è°ƒç”¨
- åŒæ­¥æ‰§è¡Œ
- ç®€å•æ¸…æ™°

---

## ğŸ”„ æ¶æ„æ”¹è¿›

### Before (é”™è¯¯çš„åˆ†å±‚)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ChatEngine  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ HTTP
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Execute API â”‚ (åœ¨åŒä¸€è¿›ç¨‹)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Runner    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### After (æ­£ç¡®çš„åˆ†å±‚)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ChatEngine  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ ç›´æ¥è°ƒç”¨
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Runner    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Execute API â”‚ (ç‹¬ç«‹ï¼Œä¾›å¤–éƒ¨è°ƒç”¨)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Runner    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¯´æ˜**:
- ChatEngine ç›´æ¥è°ƒç”¨ Runnerï¼ˆå†…éƒ¨è°ƒç”¨ï¼‰
- Execute API ä¹Ÿè°ƒç”¨ Runnerï¼ˆå¤–éƒ¨ HTTP APIï¼‰
- ä¸¤è€…éƒ½ç”¨ Runnerï¼Œä½†è°ƒç”¨æ–¹å¼ä¸åŒ

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | HTTP è°ƒç”¨ï¼ˆæ—§ï¼‰ | ç›´æ¥è°ƒç”¨ï¼ˆæ–°ï¼‰ |
|-----|---------------|--------------|
| ä»£ç è¡Œæ•° | ~170 è¡Œ | ~80 è¡Œ |
| æ‰§è¡Œå»¶è¿Ÿ | HTTP å¾€è¿” + è½®è¯¢ | ç›´æ¥å‡½æ•°è°ƒç”¨ |
| ç«¯å£ä¾èµ– | âœ… ç¡¬ç¼–ç  | âŒ æ—  |
| è¶…æ—¶é£é™© | âš ï¸ é«˜ | âŒ æ—  |
| ç»´æŠ¤æˆæœ¬ | âš ï¸ é«˜ | âœ… ä½ |
| å¯è¯»æ€§ | âš ï¸ å¤æ‚ | âœ… æ¸…æ™° |

---

## ğŸ§ª éªŒè¯æ­¥éª¤

### 1. ç¡®è®¤ WebUI è¿è¡Œ
```bash
ps aux | grep uvicorn
# åº”è¯¥çœ‹åˆ°è¿›ç¨‹è¿è¡Œåœ¨ 9090 ç«¯å£
```

### 2. åœ¨æµè§ˆå™¨æµ‹è¯•
è®¿é—®: http://127.0.0.1:9090

è¾“å…¥:
```
/test hello
```

æœŸæœ›ç»“æœ:
```
Hello from Test Extension! ğŸ‰
Args: []
```

### 3. æ£€æŸ¥æ—¥å¿—
```bash
tail -f /tmp/webui_direct.log
```

åº”è¯¥çœ‹åˆ°:
- æ—  HTTP è¶…æ—¶é”™è¯¯
- æ—  "Connection refused" é”™è¯¯
- æ‰§è¡ŒæˆåŠŸæ—¥å¿—

---

## âœ… ä¿®å¤æ¸…å•

- âœ… ç§»é™¤ `import requests`
- âœ… ç§»é™¤ `import time`
- âœ… ç§»é™¤ç¡¬ç¼–ç çš„ç«¯å£ `9090`
- âœ… ç§»é™¤ HTTP POST è°ƒç”¨
- âœ… ç§»é™¤ HTTP GET è½®è¯¢
- âœ… ç§»é™¤è¶…æ—¶å¤„ç†ä»£ç 
- âœ… æ·»åŠ ç›´æ¥ Runner è°ƒç”¨
- âœ… ç®€åŒ–ä»£ç é€»è¾‘
- âœ… é‡å¯ WebUI (PID: 60947)

---

## ğŸ¯ WebUI çŠ¶æ€

**å½“å‰è¿è¡Œ**:
- **PID**: 60947
- **ç«¯å£**: 9090
- **çŠ¶æ€**: âœ… Running
- **æ—¥å¿—**: /tmp/webui_direct.log

**è®¿é—®åœ°å€**: http://127.0.0.1:9090

---

## ğŸ’¡ ç»éªŒæ•™è®­

1. **é¿å…åŒè¿›ç¨‹ HTTP è°ƒç”¨**: åŒä¸€è¿›ç¨‹å†…çš„ç»„ä»¶åº”è¯¥ç›´æ¥å‡½æ•°è°ƒç”¨ï¼Œä¸è¦é€šè¿‡ HTTP
2. **ä¸è¦ç¡¬ç¼–ç é…ç½®**: ç«¯å£ã€URL ç­‰åº”è¯¥ä»é…ç½®æ–‡ä»¶è¯»å–
3. **åˆ†å±‚è¦æ¸…æ™°**: å†…éƒ¨è°ƒç”¨å’Œå¤–éƒ¨ API åº”è¯¥åˆ†å¼€
4. **ç®€å•å°±æ˜¯ç¾**: èƒ½ç›´æ¥è°ƒç”¨å°±ä¸è¦ç»•åœˆå­

---

## ğŸ“‹ åç»­å»ºè®®

### çŸ­æœŸ
1. âœ… æµ‹è¯• `/test hello` å’Œ `/test status`
2. âœ… éªŒè¯æ— è¶…æ—¶é—®é¢˜
3. âœ… æ£€æŸ¥å®¡è®¡æ—¥å¿—

### ä¸­æœŸ
1. Execute API ä»ç„¶å¯ä»¥é€šè¿‡ HTTP ä¾›å¤–éƒ¨è°ƒç”¨
2. è€ƒè™‘æ·»åŠ é…ç½®ç®¡ç†ï¼ˆç«¯å£ç­‰ï¼‰
3. æ·»åŠ æ€§èƒ½ç›‘æ§

### é•¿æœŸ
1. è€ƒè™‘ Runner çš„å¼‚æ­¥æ‰§è¡Œï¼ˆå¦‚æœéœ€è¦ï¼‰
2. æ·»åŠ è¿›åº¦å›è°ƒï¼ˆå®æ—¶æ˜¾ç¤ºï¼‰
3. æ‰©å±• Runner ç±»å‹

---

## ğŸ‰ ä¿®å¤å®Œæˆ

**æ ¸å¿ƒæ”¹è¿›**: ä»"é€šè¿‡ HTTP è°ƒç”¨è‡ªå·±"æ”¹ä¸º"ç›´æ¥å‡½æ•°è°ƒç”¨"

**ç»“æœ**:
- âœ… æ— ç¡¬ç¼–ç ç«¯å£
- âœ… æ— è¶…æ—¶é—®é¢˜
- âœ… æ¶æ„æ›´æ¸…æ™°
- âœ… ä»£ç æ›´ç®€æ´
- âœ… æ€§èƒ½æ›´å¥½

**æµ‹è¯•çŠ¶æ€**: â³ å¾…ç”¨æˆ·åœ¨æµè§ˆå™¨éªŒè¯

---

*ä¿®å¤æ—¶é—´: 2026-01-30 16:07*
*WebUI PID: 60947*
*ç«¯å£: 9090*
*æ¶æ„: ç›´æ¥è°ƒç”¨ Runner*
