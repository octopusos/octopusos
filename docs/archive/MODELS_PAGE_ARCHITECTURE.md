# Models ç®¡ç†é¡µé¢ - æŠ€æœ¯æ¶æ„

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ·æµè§ˆå™¨                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ModelsView.js (è§†å›¾å±‚)                                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚   â”‚
â”‚  â”‚  â”‚ æ¨¡å‹åˆ—è¡¨    â”‚  â”‚ ä¸‹è½½ç®¡ç†    â”‚  â”‚ æœåŠ¡çŠ¶æ€    â”‚         â”‚   â”‚
â”‚  â”‚  â”‚ å±•ç¤º        â”‚  â”‚ è¿›åº¦è¿½è¸ª    â”‚  â”‚ ç›‘æ§        â”‚         â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â†• HTTP/WebSocket                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      AgentOS WebUI Server                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  models.py (FastAPI è·¯ç”±)                                 â”‚   â”‚
â”‚  â”‚                                                            â”‚   â”‚
â”‚  â”‚  GET  /api/models/list           â†’ list_models()         â”‚   â”‚
â”‚  â”‚  GET  /api/models/available      â†’ get_available()       â”‚   â”‚
â”‚  â”‚  POST /api/models/pull           â†’ pull_model()          â”‚   â”‚
â”‚  â”‚  GET  /api/models/pull/{id}      â†’ get_progress()        â”‚   â”‚
â”‚  â”‚  DEL  /api/models/{provider}/{m} â†’ delete_model()        â”‚   â”‚
â”‚  â”‚  GET  /api/models/status         â†’ get_status()          â”‚   â”‚
â”‚  â”‚                                                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â†•                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ProviderChecker (CLI å±‚)                                 â”‚   â”‚
â”‚  â”‚                                                            â”‚   â”‚
â”‚  â”‚  - check_ollama()         æ£€æŸ¥ Ollama æœåŠ¡çŠ¶æ€            â”‚   â”‚
â”‚  â”‚  - get_ollama_models()    è·å–å·²å®‰è£…æ¨¡å‹åˆ—è¡¨              â”‚   â”‚
â”‚  â”‚  - pull_ollama_model()    ä¸‹è½½æ¨¡å‹ (é˜»å¡è°ƒç”¨)             â”‚   â”‚
â”‚  â”‚  - start_ollama()         å¯åŠ¨ Ollama æœåŠ¡                â”‚   â”‚
â”‚  â”‚                                                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â†•                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Ollama / llama.cpp                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  Ollama Server       â”‚      â”‚  llama.cpp           â”‚         â”‚
â”‚  â”‚  (localhost:11434)   â”‚      â”‚  (æœ¬åœ°äºŒè¿›åˆ¶)        â”‚         â”‚
â”‚  â”‚                      â”‚      â”‚                      â”‚         â”‚
â”‚  â”‚  - API: /api/tags    â”‚      â”‚  - llama-server      â”‚         â”‚
â”‚  â”‚  - API: /api/pull    â”‚      â”‚  - llama-cli         â”‚         â”‚
â”‚  â”‚  - API: /api/delete  â”‚      â”‚                      â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ æ•°æ®æµå›¾

### 1. æŸ¥çœ‹æ¨¡å‹åˆ—è¡¨
```
ç”¨æˆ·æ‰“å¼€ Models é¡µé¢
    â†“
ModelsView.render()
    â†“
ModelsView.loadModels()
    â†“
GET /api/models/list â”€â”€â†’ models.list_models()
                             â†“
                         ProviderChecker.get_ollama_models()
                             â†“
                         GET http://localhost:11434/api/tags
                             â†“
                         è¿”å›æ¨¡å‹åˆ—è¡¨
    â†“
ModelsView.renderModelCard() Ã— N
    â†“
é¡µé¢æ˜¾ç¤ºæ¨¡å‹å¡ç‰‡
```

### 2. ä¸‹è½½æ¨¡å‹ï¼ˆæ ¸å¿ƒæµç¨‹ï¼‰
```
ç”¨æˆ·ç‚¹å‡» [Download Model]
    â†“
ModelsView.showDownloadModal()
    â†“
ç”¨æˆ·é€‰æ‹©æ¨¡å‹ "qwen2.5:7b"
    â†“
ModelsView.pullModel("qwen2.5:7b")
    â†“
POST /api/models/pull
    body: { "model_name": "qwen2.5:7b" }
    â†“
models.pull_model()
    â”œâ”€â†’ ç”Ÿæˆ pull_id = "pull_abc123"
    â”œâ”€â†’ è®°å½•åˆ° _pull_progress[pull_id]
    â””â”€â†’ å¯åŠ¨åå°çº¿ç¨‹: _pull_model_background()
    â†“
ç«‹å³è¿”å› { "pull_id": "pull_abc123", "status": "PULLING" }
    â†“
ModelsView.showPullProgress("pull_abc123")
    â”œâ”€â†’ æ˜¾ç¤ºè¿›åº¦æ¡ UI
    â””â”€â†’ å¼€å§‹è½®è¯¢: ModelsView.pollPullProgress()

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åå°çº¿ç¨‹ _pull_model_background("pull_abc123", ...)     â”‚
â”‚                                                          â”‚
â”‚  subprocess.Popen(["ollama", "pull", "qwen2.5:7b"])    â”‚
â”‚      â†“                                                   â”‚
â”‚  è§£æ stdout è¾“å‡º                                        â”‚
â”‚      â†“                                                   â”‚
â”‚  æ›´æ–° _pull_progress[pull_id]:                          â”‚
â”‚    - progress: 0 â†’ 25 â†’ 50 â†’ 75 â†’ 100                  â”‚
â”‚    - current_status: "pulling manifest" ...             â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯è½®è¯¢ (æ¯ 500ms)                                      â”‚
â”‚                                                          â”‚
â”‚  GET /api/models/pull/pull_abc123                       â”‚
â”‚      â†“                                                   â”‚
â”‚  models.get_pull_progress("pull_abc123")               â”‚
â”‚      â†“                                                   â”‚
â”‚  è¿”å› _pull_progress["pull_abc123"]                     â”‚
â”‚      â†“                                                   â”‚
â”‚  ModelsView.updateProgressBar(75%)                      â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¸‹è½½å®Œæˆ (status = "COMPLETED")
    â†“
åœæ­¢è½®è¯¢
    â†“
æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
    â†“
åˆ·æ–°æ¨¡å‹åˆ—è¡¨ (è‡ªåŠ¨æ˜¾ç¤ºæ–°æ¨¡å‹)
```

### 3. åˆ é™¤æ¨¡å‹
```
ç”¨æˆ·ç‚¹å‡» [Delete] æŒ‰é’®
    â†“
ModelsView.showDeleteConfirmModal()
    â†“
ç”¨æˆ·ç¡®è®¤åˆ é™¤
    â†“
ModelsView.deleteModel("qwen2.5:7b")
    â†“
DELETE /api/models/ollama/qwen2.5:7b
    â†“
models.delete_model("ollama", "qwen2.5:7b")
    â†“
ProviderChecker.delete_ollama_model()  (éœ€è¦å®ç°)
    â†“
æ‰§è¡Œ: ollama rm qwen2.5:7b
    â†“
è¿”å›åˆ é™¤ç»“æœ
    â†“
æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
    â†“
åˆ·æ–°æ¨¡å‹åˆ—è¡¨
```

## ğŸ“Š çŠ¶æ€ç®¡ç†

### å…¨å±€çŠ¶æ€ (åç«¯)
```python
# ä¸‹è½½è¿›åº¦è¿½è¸ª
_pull_progress = {
    "pull_abc123": {
        "pull_id": "pull_abc123",
        "model_name": "qwen2.5:7b",
        "status": "PULLING",  # PULLING, COMPLETED, FAILED
        "progress": 75,
        "current_layer": 3,
        "total_layers": 4,
        "downloaded_bytes": 3543891968,
        "total_bytes": 4726735872,
        "current_status": "pulling layer sha256:...",
        "started_at": "2024-01-15T10:30:00Z",
        "error": null
    }
}
```

### ç»„ä»¶çŠ¶æ€ (å‰ç«¯)
```javascript
class ModelsView {
    constructor() {
        this.currentModels = [];           // å½“å‰æ¨¡å‹åˆ—è¡¨
        this.activePulls = new Set();      // æ´»è·ƒçš„ä¸‹è½½ä»»åŠ¡
        this.pullIntervalId = null;        // è½®è¯¢å®šæ—¶å™¨
        this.statusCheckInterval = null;   // æœåŠ¡çŠ¶æ€æ£€æŸ¥å®šæ—¶å™¨
    }
}
```

## ğŸ¯ å…³é”®æŠ€æœ¯ç‚¹

### 1. åå°ä¸‹è½½è¿›åº¦è¿½è¸ª

**æŒ‘æˆ˜**: Ollama pull æ˜¯é˜»å¡è°ƒç”¨ï¼Œå¦‚ä½•å®æ—¶è·å–è¿›åº¦ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**: è§£æ stdout è¾“å‡º + åå°çº¿ç¨‹

```python
def _pull_model_background(pull_id: str, model_name: str):
    """åå°çº¿ç¨‹ä¸‹è½½æ¨¡å‹å¹¶è¿½è¸ªè¿›åº¦"""
    process = subprocess.Popen(
        ["ollama", "pull", model_name],
        stdout=subprocess.PIPE,
        stderr=subprocess.STDOUT,
        text=True,
        bufsize=1  # è¡Œç¼“å†²
    )

    total_layers = 0
    current_layer = 0

    for line in process.stdout:
        line = line.strip()

        # è§£æ Ollama è¾“å‡ºæ ¼å¼
        # pulling manifest
        # pulling sha256:abc123... 100% â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 1.2 GB/1.2 GB
        # verifying sha256:abc123...
        # writing manifest
        # success

        if "pulling" in line and "%" in line:
            # æå–ç™¾åˆ†æ¯”
            match = re.search(r'(\d+)%', line)
            if match:
                layer_progress = int(match.group(1))
                overall_progress = (current_layer * 100 + layer_progress) / total_layers

                _pull_progress[pull_id]["progress"] = int(overall_progress)
                _pull_progress[pull_id]["current_status"] = line

        elif "pulling sha256:" in line:
            current_layer += 1
            if "pulling manifest" not in line:
                total_layers = max(total_layers, current_layer)

    # å®Œæˆæˆ–å¤±è´¥
    if process.returncode == 0:
        _pull_progress[pull_id]["status"] = "COMPLETED"
        _pull_progress[pull_id]["progress"] = 100
    else:
        _pull_progress[pull_id]["status"] = "FAILED"
```

### 2. å‰ç«¯è½®è¯¢ä¼˜åŒ–

**æŒ‘æˆ˜**: å¦‚ä½•é¿å…è½®è¯¢é€ æˆçš„æ€§èƒ½é—®é¢˜ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**:
- ä»…åœ¨æœ‰æ´»è·ƒä¸‹è½½æ—¶è½®è¯¢
- ä¸‹è½½å®Œæˆåç«‹å³åœæ­¢è½®è¯¢
- ä½¿ç”¨è¾ƒçŸ­çš„è½®è¯¢é—´éš”ï¼ˆ500msï¼‰ä¿è¯å®æ—¶æ€§

```javascript
class ModelsView {
    async pullModel(modelName) {
        const response = await fetch('/api/models/pull', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ model_name: modelName })
        });

        const { pull_id } = await response.json();

        // è®°å½•æ´»è·ƒä¸‹è½½
        this.activePulls.add(pull_id);

        // æ˜¾ç¤ºè¿›åº¦ UI
        this.showPullProgress(pull_id, modelName);

        // å¼€å§‹è½®è¯¢ï¼ˆå¦‚æœå°šæœªå¯åŠ¨ï¼‰
        if (!this.pullIntervalId) {
            this.startPollingPulls();
        }
    }

    startPollingPulls() {
        this.pullIntervalId = setInterval(async () => {
            // æ‰¹é‡æŸ¥è¯¢æ‰€æœ‰æ´»è·ƒä¸‹è½½çš„è¿›åº¦
            for (const pullId of this.activePulls) {
                await this.updatePullProgress(pullId);
            }

            // å¦‚æœæ²¡æœ‰æ´»è·ƒä¸‹è½½ï¼Œåœæ­¢è½®è¯¢
            if (this.activePulls.size === 0) {
                clearInterval(this.pullIntervalId);
                this.pullIntervalId = null;
            }
        }, 500);
    }

    async updatePullProgress(pullId) {
        const response = await fetch(`/api/models/pull/${pullId}`);
        const data = await response.json();

        // æ›´æ–°è¿›åº¦ UI
        this.updateProgressBar(pullId, data.progress);

        // æ£€æŸ¥æ˜¯å¦å®Œæˆ
        if (data.status === 'COMPLETED' || data.status === 'FAILED') {
            this.activePulls.delete(pullId);
            this.handlePullComplete(pullId, data);
        }
    }
}
```

### 3. æœåŠ¡çŠ¶æ€ç›‘æ§

**æŒ‘æˆ˜**: å¦‚ä½•å®æ—¶æ˜¾ç¤º Ollama æœåŠ¡çŠ¶æ€ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**: å®šæ—¶è½®è¯¢ + å¥åº·æ£€æŸ¥

```javascript
class ModelsView {
    async render(container) {
        // ... æ¸²æŸ“é¡µé¢

        // å¯åŠ¨æœåŠ¡çŠ¶æ€æ£€æŸ¥
        this.startStatusCheck();
    }

    startStatusCheck() {
        // ç«‹å³æ£€æŸ¥ä¸€æ¬¡
        this.updateServiceStatus();

        // æ¯ 5 ç§’æ£€æŸ¥ä¸€æ¬¡
        this.statusCheckInterval = setInterval(async () => {
            await this.updateServiceStatus();
        }, 5000);
    }

    async updateServiceStatus() {
        try {
            const response = await fetch('/api/models/status');
            const data = await response.json();

            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            const ollamaIndicator = document.getElementById('ollama-status');
            if (data.ollama.running) {
                ollamaIndicator.className = 'status-indicator status-running';
                ollamaIndicator.title = `Running (${data.ollama.version})`;
            } else {
                ollamaIndicator.className = 'status-indicator status-stopped';
                ollamaIndicator.title = 'Stopped';
            }
        } catch (error) {
            console.error('Failed to check service status:', error);
        }
    }

    destroy() {
        // æ¸…ç†å®šæ—¶å™¨
        if (this.statusCheckInterval) {
            clearInterval(this.statusCheckInterval);
        }
        if (this.pullIntervalId) {
            clearInterval(this.pullIntervalId);
        }
    }
}
```

## ğŸ”§ æ‰©å±•ç‚¹è®¾è®¡

### 1. æ”¯æŒå¤š Provider
```python
# æŠ½è±¡ Provider æ¥å£
class ModelProvider(ABC):
    @abstractmethod
    def list_models(self) -> List[Model]:
        pass

    @abstractmethod
    def pull_model(self, model_name: str) -> str:  # è¿”å› pull_id
        pass

    @abstractmethod
    def get_pull_progress(self, pull_id: str) -> PullProgress:
        pass

    @abstractmethod
    def delete_model(self, model_name: str) -> bool:
        pass

# å®ç°
class OllamaProvider(ModelProvider):
    ...

class LlamaCppProvider(ModelProvider):
    ...

# åœ¨ API ä¸­ä½¿ç”¨
providers = {
    "ollama": OllamaProvider(),
    "llama_cpp": LlamaCppProvider()
}

@router.post("/api/models/pull")
async def pull_model(request: PullRequest):
    provider = providers[request.provider]
    pull_id = provider.pull_model(request.model_name)
    return {"pull_id": pull_id}
```

### 2. WebSocket å®æ—¶æ¨é€ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰

æ›¿ä»£è½®è¯¢ï¼Œä½¿ç”¨ WebSocket å®æ—¶æ¨é€è¿›åº¦ï¼š

```python
# åç«¯
@router.websocket("/ws/models/pull/{pull_id}")
async def pull_progress_ws(websocket: WebSocket, pull_id: str):
    await websocket.accept()
    try:
        while True:
            progress = _pull_progress.get(pull_id)
            if progress:
                await websocket.send_json(progress)

                if progress["status"] in ["COMPLETED", "FAILED"]:
                    break

            await asyncio.sleep(0.5)
    finally:
        await websocket.close()
```

```javascript
// å‰ç«¯
async pullModel(modelName) {
    const response = await fetch('/api/models/pull', { ... });
    const { pull_id } = await response.json();

    // ä½¿ç”¨ WebSocket æ¥æ”¶è¿›åº¦
    const ws = new WebSocket(`ws://localhost:8000/ws/models/pull/${pull_id}`);

    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        this.updateProgressBar(pull_id, data.progress);

        if (data.status === 'COMPLETED') {
            ws.close();
            this.handlePullComplete(pull_id, data);
        }
    };
}
```

## ğŸ“¦ æ¨èçš„é¡¹ç›®ç»“æ„

```
agentos/
â”œâ”€â”€ webui/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ models.py              # Models API è·¯ç”± (æ–°å¢)
â”‚   â”‚   â”œâ”€â”€ extensions.py          # Extensions API (å‚è€ƒ)
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ static/
â”‚   â”‚   â”œâ”€â”€ css/
â”‚   â”‚   â”‚   â”œâ”€â”€ models.css         # Models æ ·å¼ (æ–°å¢)
â”‚   â”‚   â”‚   â”œâ”€â”€ extensions.css     # Extensions æ ·å¼ (å‚è€ƒ)
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â””â”€â”€ js/
â”‚   â”‚       â””â”€â”€ views/
â”‚   â”‚           â”œâ”€â”€ ModelsView.js       # Models è§†å›¾ (æ–°å¢)
â”‚   â”‚           â”œâ”€â”€ ExtensionsView.js   # Extensions è§†å›¾ (å‚è€ƒ)
â”‚   â”‚           â””â”€â”€ ...
â”‚   â””â”€â”€ templates/
â”‚       â””â”€â”€ index.html             # ä¸»é¡µé¢ (ä¿®æ”¹)
â”œâ”€â”€ cli/
â”‚   â””â”€â”€ provider_checker.py        # Provider æ£€æµ‹ (æ‰©å±•)
â””â”€â”€ core/
    â””â”€â”€ models/                     # å¯é€‰ï¼šæ¨¡å‹ç®¡ç†æ ¸å¿ƒé€»è¾‘
        â”œâ”€â”€ __init__.py
        â”œâ”€â”€ base.py                # Provider æŠ½è±¡æ¥å£
        â”œâ”€â”€ ollama.py              # Ollama Provider
        â””â”€â”€ llamacpp.py            # llama.cpp Provider
```

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•
```python
# tests/unit/api/test_models_api.py
def test_list_models_empty():
    """æµ‹è¯•ç©ºæ¨¡å‹åˆ—è¡¨"""
    # Mock ProviderChecker.get_ollama_models() è¿”å› []
    response = client.get("/api/models/list")
    assert response.json() == {"models": []}

def test_pull_model_creates_background_task():
    """æµ‹è¯•ä¸‹è½½æ¨¡å‹å¯åŠ¨åå°ä»»åŠ¡"""
    response = client.post("/api/models/pull", json={
        "model_name": "test:model"
    })
    assert "pull_id" in response.json()
```

### é›†æˆæµ‹è¯•
```python
# tests/integration/test_models_e2e.py
@pytest.mark.asyncio
async def test_pull_model_e2e():
    """ç«¯åˆ°ç«¯æµ‹è¯•æ¨¡å‹ä¸‹è½½"""
    # 1. å‘èµ·ä¸‹è½½
    pull_response = client.post("/api/models/pull", json={
        "model_name": "llama3.2:1b"
    })
    pull_id = pull_response.json()["pull_id"]

    # 2. è½®è¯¢è¿›åº¦ç›´åˆ°å®Œæˆ
    for _ in range(60):  # æœ€å¤šç­‰å¾… 60 ç§’
        progress_response = client.get(f"/api/models/pull/{pull_id}")
        data = progress_response.json()

        if data["status"] == "COMPLETED":
            break

        await asyncio.sleep(1)

    # 3. éªŒè¯æ¨¡å‹å‡ºç°åœ¨åˆ—è¡¨ä¸­
    list_response = client.get("/api/models/list")
    models = list_response.json()["models"]
    assert any(m["name"] == "llama3.2:1b" for m in models)
```

### å‰ç«¯æµ‹è¯• (Playwright)
```javascript
// tests/e2e/test_models_page.spec.js
test('download model from UI', async ({ page }) => {
    // 1. æ‰“å¼€ Models é¡µé¢
    await page.goto('http://localhost:8000');
    await page.click('a[data-view="models"]');

    // 2. ç‚¹å‡»ä¸‹è½½æŒ‰é’®
    await page.click('#btnDownloadModel');

    // 3. é€‰æ‹©æ¨¡å‹
    await page.click('input[value="llama3.2:1b"]');
    await page.click('button:has-text("Download")');

    // 4. ç­‰å¾…è¿›åº¦æ¡å‡ºç°
    await page.waitForSelector('.download-progress');

    // 5. ç­‰å¾…ä¸‹è½½å®Œæˆ
    await page.waitForSelector('.model-card:has-text("llama3.2:1b")', {
        timeout: 120000  // 2 åˆ†é’Ÿè¶…æ—¶
    });
});
```

## ğŸš€ éƒ¨ç½²å’Œç›‘æ§

### å¥åº·æ£€æŸ¥
```python
@router.get("/api/models/health")
async def health_check():
    """å¥åº·æ£€æŸ¥ç«¯ç‚¹"""
    ollama_ok, _ = ProviderChecker().check_ollama()
    return {
        "status": "healthy" if ollama_ok else "degraded",
        "providers": {
            "ollama": ollama_ok
        }
    }
```

### æ—¥å¿—è®°å½•
```python
import logging

logger = logging.getLogger(__name__)

@router.post("/api/models/pull")
async def pull_model(request: PullRequest):
    logger.info(f"Starting model pull: {request.model_name}")

    try:
        pull_id = await _start_pull(request.model_name)
        logger.info(f"Model pull started successfully: {pull_id}")
        return {"pull_id": pull_id}
    except Exception as e:
        logger.error(f"Failed to start model pull: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=str(e))
```

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### ç›®æ ‡æ€§èƒ½
- é¡µé¢åŠ è½½æ—¶é—´: < 2 ç§’
- æ¨¡å‹åˆ—è¡¨åˆ·æ–°: < 500ms
- è¿›åº¦æ›´æ–°å»¶è¿Ÿ: < 1 ç§’
- å¹¶å‘ä¸‹è½½æ”¯æŒ: >= 2 ä¸ªæ¨¡å‹

### ç›‘æ§æŒ‡æ ‡
```python
from prometheus_client import Counter, Histogram

# ä¸‹è½½è®¡æ•°å™¨
model_pull_counter = Counter(
    'models_pull_total',
    'Total number of model pulls',
    ['model_name', 'status']
)

# ä¸‹è½½æ—¶é•¿åˆ†å¸ƒ
model_pull_duration = Histogram(
    'models_pull_duration_seconds',
    'Model pull duration in seconds',
    ['model_name']
)
```

---

**æ€»ç»“**: æœ¬æ¶æ„è®¾è®¡éµå¾ª "ç®€å•ä¼˜å…ˆ" åŸåˆ™ï¼Œæ ¸å¿ƒåŠŸèƒ½ä½¿ç”¨è½®è¯¢å®ç°ï¼Œæ˜“äºç†è§£å’Œè°ƒè¯•ã€‚åç»­å¯æ ¹æ®éœ€è¦ä¼˜åŒ–ä¸º WebSocket æ¨é€ã€‚
