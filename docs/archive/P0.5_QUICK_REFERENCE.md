# P0.5 Quick Reference: Coverage Validity Gate

## Quick Commands

```bash
# Run enhanced coverage script
bash scripts/coverage_scope_task.sh

# Check coverage validity
python3 scripts/gate_coverage_valid.py
```

---

## What Changed

### 1. Enhanced Script Output
`scripts/coverage_scope_task.sh` now shows:
- **Measured Files Count**: Total number of Python files measured
- **Sample Files**: First 5 measured files with full paths
- **Pytest Exit Code**: Success (0) or failure (non-0)
- **Validity Status**: Whether coverage data is trustworthy

### 2. New Validity Gate
`scripts/gate_coverage_valid.py` determines:
- ‚úÖ **Valid Coverage**: Tests passed (exit 0) ‚Üí Data trustworthy
- ‚ùå **Invalid Coverage**: Tests failed (exit non-0) ‚Üí Data untrustworthy

---

## Output Format

### Enhanced Script Section
```
===== Scope Coverage Measurement =====
Measured Files Count: 31

Sample Files:
   1. agentos/core/task/__init__.py
   2. agentos/core/task/artifact_service.py
   3. agentos/core/task/artifact_service_v31.py
   4. agentos/core/task/audit_service.py
   5. agentos/core/task/binding_service.py

Pytest Exit Code: 0
Status: ‚úÖ Tests passed - coverage data is VALID
=======================================
```

### Gate Output (PASS)
```
‚úÖ GATE PASSED: Coverage Data is VALID

üìã Diagnosis:
   - Pytest completed successfully (exit code 0)
   - All tests passed
   - Coverage measurements are trustworthy
   - Coverage data can be used for quality gates
```

### Gate Output (FAIL)
```
‚ùå GATE FAILED: Coverage Data is INVALID

üìã Diagnosis:
   - Pytest failed (exit code 1)
   - Some tests failed or errors occurred
   - Coverage measurements are NOT trustworthy
   - Coverage data should NOT be used for quality gates
```

---

## Typical Workflow

```bash
# 1. Run coverage with enhanced output
bash scripts/coverage_scope_task.sh

# 2. Check validity
python3 scripts/gate_coverage_valid.py

# 3a. If gate passes (exit 0):
#     ‚Üí Coverage data is trustworthy
#     ‚Üí Proceed to threshold gates

# 3b. If gate fails (exit 1):
#     ‚Üí Fix failing tests
#     ‚Üí Re-run step 1
```

---

## Gate Integration

### Recommended Gate Order
```bash
# Pre-requisite: Validity Check
python3 scripts/gate_coverage_valid.py || exit 1

# Only proceed if coverage is valid:
python3 scripts/gate_coverage_scope.py || exit 1
python3 scripts/gate_coverage_project.py || exit 1
```

---

## Exit Codes

### Coverage Script
- Always exits 0 (even if tests fail)
- Saves pytest exit code to `.pytest_scope_exit_code`

### Validity Gate
- Exit 0: Coverage valid (tests passed)
- Exit 1: Coverage invalid (tests failed or file missing)

---

## Files

### Modified
- `scripts/coverage_scope_task.sh` (95 lines)

### Created
- `scripts/gate_coverage_valid.py` (118 lines)
- `.pytest_scope_exit_code` (1 line, auto-generated)

---

## Key Features

1. **Self-Proving**: Shows exactly which files were measured
2. **Validity Detection**: Distinguishes trustworthy vs untrustworthy coverage
3. **Non-Blocking**: Script continues even if tests fail
4. **Clear Diagnostics**: Actionable error messages
5. **CI/CD Ready**: Fast execution (< 0.1s for gate)

---

## Example Use Cases

### Use Case 1: CI Pipeline Gate
```yaml
# .github/workflows/test.yml
- name: Run scope coverage
  run: bash scripts/coverage_scope_task.sh

- name: Validate coverage data
  run: python3 scripts/gate_coverage_valid.py

- name: Check thresholds (only if valid)
  run: python3 scripts/gate_coverage_scope.py
```

### Use Case 2: Pre-Merge Check
```bash
# Run before creating PR
bash scripts/coverage_scope_task.sh
python3 scripts/gate_coverage_valid.py && \
  python3 scripts/gate_coverage_scope.py && \
  echo "‚úÖ Ready for PR"
```

### Use Case 3: Debug Invalid Coverage
```bash
# If gate fails, see detailed output
python3 scripts/gate_coverage_valid.py

# Fix failing tests, then re-run
bash scripts/coverage_scope_task.sh
python3 scripts/gate_coverage_valid.py
```

---

## Troubleshooting

### Gate says "file not found"
```bash
# Solution: Run coverage script first
bash scripts/coverage_scope_task.sh
```

### Gate says "coverage invalid"
```bash
# Check which tests failed
bash scripts/coverage_scope_task.sh | grep FAILED

# Fix tests, then re-run
bash scripts/coverage_scope_task.sh
```

### Want to see all measured files (not just 5)
```bash
# Extract from XML
grep '<class name=' coverage-scope.xml | \
  grep -o 'filename="[^"]*"' | \
  sed 's/filename="//;s/"$//'
```

---

**Last Updated**: 2026-01-30
**Task**: P0.5 - Coverage Scope Enhancement
