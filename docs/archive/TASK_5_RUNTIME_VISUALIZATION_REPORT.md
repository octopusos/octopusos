# ä»»åŠ¡ 5ï¼šè¿è¡Œæ—¶å¯è§†åŒ– - å®æ–½æŠ¥å‘Š

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

åœ¨ Chat ç•Œé¢å’Œ Context View ä¸­æ·»åŠ å®æ—¶ Token é¢„ç®—ç›‘æ§ï¼Œè®©ç”¨æˆ·çŸ¥é“"ä¸ºä»€ä¹ˆè¢«æˆªæ–­"ã€‚

## âœ… å®æ–½å®Œæˆ

### 1. åç«¯å¢å¼º (`agentos/core/chat/context_builder.py`)

#### 1.1 é¢„ç®—æºæ—¥å¿—
```python
# è®°å½•é¢„ç®—æ¥æº
logger.info(
    f"Budget: {self.budget.max_tokens} tokens "
    f"(source: {'auto-derived' if self.budget.auto_derived else 'configured'}, "
    f"model_window: {self.budget.model_context_window})"
)
```

#### 1.2 æˆªæ–­æ“ä½œæ—¥å¿—
```python
# è®°å½•æˆªæ–­æƒ…å†µ
if trimmed_window > 0:
    logger.warning(f"Trimmed {trimmed_window} messages from window (budget: {self.budget.window_tokens})")
if trimmed_rag > 0:
    logger.warning(f"Trimmed {trimmed_rag} RAG chunks (budget: {self.budget.rag_tokens})")
if trimmed_memory > 0:
    logger.warning(f"Trimmed {trimmed_memory} memory facts (budget: {self.budget.memory_tokens})")
```

#### 1.3 ä½¿ç”¨ç»Ÿè®¡å¢å¼º
```python
# ContextUsage.to_dict() æ·»åŠ  breakdown å­—æ®µ
"breakdown": {
    "system": self.tokens_system,
    "window": self.tokens_window,
    "rag": self.tokens_rag,
    "memory": self.tokens_memory
}
```

#### 1.4 å®¡è®¡æ—¥å¿—åˆå§‹åŒ–
```python
audit = {
    # ... existing fields ...
    "trimming_log": []  # NEW: Initialize trimming log
}
```

### 2. WebSocket æ¶ˆæ¯å¢å¼º (`agentos/webui/websocket/chat.py`)

#### 2.1 é¢„ç®—æ›´æ–°æ¶ˆæ¯
åœ¨æ¶ˆæ¯å‘é€å®Œæˆåå‘é€é¢„ç®—æ›´æ–°ï¼š

```python
# NEW: Send budget update after message is complete
try:
    # Build a dry-run context to get budget info
    from agentos.core.chat.context_builder import ContextBuilder
    builder = ContextBuilder()

    # Build context without sending (for budget calculation)
    context_pack = builder.build(
        session_id=session_id,
        user_input="",  # Empty input for budget check
        reason="audit"
    )

    # Send budget update to frontend
    await manager.send_message(session_id, {
        "type": "budget_update",
        "data": {
            "total_tokens": context_pack.usage.total_tokens_est,
            "budget_tokens": context_pack.usage.budget_tokens,
            "usage_ratio": context_pack.usage.usage_ratio,
            "watermark": context_pack.usage.watermark.value,
            "breakdown": {
                "system": context_pack.usage.tokens_system,
                "window": context_pack.usage.tokens_window,
                "rag": context_pack.usage.tokens_rag,
                "memory": context_pack.usage.tokens_memory,
            }
        }
    })

    logger.info(f"Sent budget update: {context_pack.usage.usage_ratio:.2%} used")
except Exception as e:
    logger.warning(f"Failed to send budget update: {e}")
```

### 3. CSS æ ·å¼ (`agentos/webui/static/css/budget-indicator.css`)

#### 3.1 Chat Header é¢„ç®—æŒ‡ç¤ºå™¨
- `.budget-indicator`: ä¸»å®¹å™¨ï¼Œç‚¹å‡»æ˜¾ç¤ºè¯¦æƒ…
- `.budget-usage`: ä½¿ç”¨é‡æ˜¾ç¤º (monospace å­—ä½“)
- `.budget-status`: çŠ¶æ€å¾½ç« 

#### 3.2 çŠ¶æ€å¾½ç« é¢œè‰²
- `.badge-safe`: ç»¿è‰² (<60%)
- `.badge-warning`: é»„è‰² (60-80%)
- `.badge-critical`: çº¢è‰² (>80%)

#### 3.3 è¯¦æƒ…æ¨¡æ€æ¡†
- `.budget-detail-modal`: è¯¦æƒ…å®¹å™¨
- `.budget-bars`: é¢„ç®—æ¡ç›®åˆ—è¡¨
- `.budget-bar-item`: å•ä¸ªé¢„ç®—æ¡
- `.progress-bar` / `.progress-fill`: è¿›åº¦æ¡

#### 3.4 Context Tab å¯¼èˆª
- `.context-tab`: æ ‡ç­¾æŒ‰é’®æ ·å¼
- `.context-tab.active`: æ´»åŠ¨æ ‡ç­¾é«˜äº®

#### 3.5 Budget æ ‡ç­¾é¡µ
- `.budget-allocation-table`: åˆ†é…è¡¨æ ¼
- `.trimming-history`: æˆªæ–­å†å²åˆ—è¡¨

### 4. Context View å¢å¼º (`agentos/webui/static/js/views/ContextView.js`)

#### 4.1 Tab å¯¼èˆª
æ·»åŠ äº† 4 ä¸ªæ ‡ç­¾é¡µï¼š
- **Status**: ä¸Šä¸‹æ–‡çŠ¶æ€ï¼ˆåŸæœ‰åŠŸèƒ½ï¼‰
- **Budget**: Token é¢„ç®—è¯¦æƒ…ï¼ˆæ–°å¢ï¼‰
- **Operations**: ä¸Šä¸‹æ–‡æ“ä½œï¼ˆåŸæœ‰åŠŸèƒ½ï¼‰
- **Raw Data**: åŸå§‹ JSON æ•°æ®ï¼ˆåŸæœ‰åŠŸèƒ½ï¼‰

#### 4.2 renderBudgetTab()
```javascript
renderBudgetTab(container) {
    // æ˜¾ç¤ºé…ç½®æ¥æºï¼ˆAuto-derived / Configuredï¼‰
    // æ˜¾ç¤ºé¢„ç®—åˆ†é…è¡¨
    // æ˜¾ç¤ºæˆªæ–­å†å²
}
```

#### 4.3 renderBudgetRow()
```javascript
renderBudgetRow(component, budget, used) {
    const percent = budget > 0 ? ((used / budget) * 100).toFixed(1) : 0;
    // è¿”å›è¡¨æ ¼è¡Œ HTML
}
```

#### 4.4 renderTrimmingLog()
```javascript
renderTrimmingLog(log) {
    // æ˜¾ç¤ºæœ€è¿‘ 5 æ¬¡æˆªæ–­æ“ä½œ
    // æ ¼å¼ï¼šæ—¶é—´ - æˆªæ–­ N ä¸ª component é¡¹ç›® (X.Xk tokens)
}
```

### 5. Chat ç•Œé¢é›†æˆ (`agentos/webui/static/js/main.js`)

#### 5.1 WebSocket æ¶ˆæ¯å¤„ç†
```javascript
} else if (message.type === 'budget_update') {
    // NEW: Handle budget update
    console.log('Budget update:', message.data);
    updateBudgetIndicator(message.data);
```

#### 5.2 updateBudgetIndicator()
- è‡ªåŠ¨åˆ›å»ºé¢„ç®—æŒ‡ç¤ºå™¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
- æ’å…¥åˆ° chat toolbar ä¸­
- æ›´æ–°ä½¿ç”¨é‡å’ŒçŠ¶æ€å¾½ç« 
- æ ¹æ® watermark æ˜¾ç¤ºä¸åŒé¢œè‰²å’Œæç¤º

#### 5.3 showBudgetDetails()
- ç‚¹å‡»é¢„ç®—æŒ‡ç¤ºå™¨æ—¶æ˜¾ç¤ºè¯¦æƒ…æ¨¡æ€æ¡†
- æ˜¾ç¤ºå„ç»„ä»¶çš„ Token ä½¿ç”¨é‡å’Œç™¾åˆ†æ¯”
- æ˜¾ç¤ºå¯è§†åŒ–è¿›åº¦æ¡

#### 5.4 renderBudgetBar()
- æ¸²æŸ“å•ä¸ªé¢„ç®—æ¡
- æ ¹æ®ä½¿ç”¨ç‡è‡ªåŠ¨è®¾ç½®é¢œè‰²ï¼ˆç»¿/é»„/çº¢ï¼‰
- æ˜¾ç¤º Token æ•°é‡å’Œç™¾åˆ†æ¯”

## ğŸ“Š å®æ–½æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Frontend (WebUI)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Chat View                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ Chat Toolbar                                   â”‚         â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚         â”‚
â”‚  â”‚ â”‚ Model Controls â”‚ Budget Indicator      â”‚    â”‚         â”‚
â”‚  â”‚ â”‚                â”‚ ğŸ“Š 45.2k/91.8k (49%)  â”‚    â”‚         â”‚
â”‚  â”‚ â”‚                â”‚ [ğŸŸ¢ Safe]             â”‚    â”‚         â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                              â”‚
â”‚  Context View                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ [Status] [Budget] [Operations] [Raw Data]     â”‚         â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”‚
â”‚  â”‚ Budget Allocation Table                        â”‚         â”‚
â”‚  â”‚ Trimming History                               â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†‘ WebSocket
                            â”‚ budget_update
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Backend (Python)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  WebSocket Handler (chat.py)                                â”‚
â”‚  â””â”€â†’ Send budget_update after message.end                   â”‚
â”‚                                                              â”‚
â”‚  ContextBuilder (context_builder.py)                        â”‚
â”‚  â”œâ”€â†’ Log budget source (auto-derived / configured)          â”‚
â”‚  â”œâ”€â†’ Log trimming operations                                â”‚
â”‚  â””â”€â†’ Return ContextPack with usage statistics               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ åŠŸèƒ½æ¼”ç¤º

### Chat ç•Œé¢çŠ¶æ€æ 

#### æ­£å¸¸çŠ¶æ€ï¼ˆ<60%ï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’¬ Chat with gpt-4o    ğŸ“Š Budget: 45.2k/91.8k (49%)â”‚
â”‚                        [ğŸŸ¢ Safe]                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### è­¦å‘ŠçŠ¶æ€ï¼ˆ60%-80%ï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’¬ Chat with gpt-4o    ğŸ“Š Budget: 68.5k/91.8k (75%)â”‚
â”‚                        [ğŸŸ¡ Warning] Context nearing â”‚
â”‚                        limit. Consider /summary.    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å±é™©çŠ¶æ€ï¼ˆ>80%ï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’¬ Chat with gpt-4o    ğŸ“Š Budget: 81.2k/91.8k (88%)â”‚
â”‚                        [ğŸ”´ Critical] Context full!  â”‚
â”‚                        Oldest messages truncated.   â”‚
â”‚                        Run /summary to compress.    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### è¯¦æƒ…æ‚¬æµ®å¡ç‰‡ï¼ˆç‚¹å‡» ğŸ“Šï¼‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Token Budget Breakdown                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Total Input Budget:     91,800 tokens               â”‚
â”‚ â”œâ”€ System Prompt:       11,475 (12.5%)  [â–ˆâ–’â–’â–’â–’]    â”‚
â”‚ â”œâ”€ Conversation:        45,900 (50.0%)  [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ]   â”‚
â”‚ â”œâ”€ RAG Context:         22,950 (25.0%)  [â–ˆâ–ˆâ–ˆâ–’â–’â–’]   â”‚
â”‚ â””â”€ Memory Facts:        11,475 (12.5%)  [â–ˆâ–’â–’â–’â–’]    â”‚
â”‚                                                      â”‚
â”‚ ğŸ’¡ Tip: Use /context to see detailed breakdown      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Context View Budget æ ‡ç­¾é¡µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Session Context Management                           â”‚
â”‚ [Status] [Budget] [Operations] [Raw Data]           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Configuration Source: Auto-derived (gpt-4o)          â”‚
â”‚                                                      â”‚
â”‚ Allocation Table:                                    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Component     â”‚ Budget  â”‚ Used    â”‚ % Used   â”‚   â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚ â”‚ System        â”‚ 11,475  â”‚ 9,832   â”‚ 85.7%    â”‚   â”‚
â”‚ â”‚ Window        â”‚ 45,900  â”‚ 38,124  â”‚ 83.0%    â”‚   â”‚
â”‚ â”‚ RAG           â”‚ 22,950  â”‚ 18,456  â”‚ 80.4%    â”‚   â”‚
â”‚ â”‚ Memory        â”‚ 11,475  â”‚ 8,921   â”‚ 77.7%    â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                      â”‚
â”‚ Trimming History (last 5 operations):                â”‚
â”‚ â€¢ 2025-01-30 14:23 - Trimmed 2 RAG chunks (1.2k)    â”‚
â”‚ â€¢ 2025-01-30 14:20 - Trimmed 1 message (0.8k)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ éªŒæ”¶æ ‡å‡†

- [x] Chat ç•Œé¢é¡¶éƒ¨æ˜¾ç¤ºé¢„ç®—çŠ¶æ€æ 
- [x] é¢„ç®—çŠ¶æ€å®æ—¶æ›´æ–°ï¼ˆå‘é€æ¶ˆæ¯åï¼‰
- [x] çŠ¶æ€é¢œè‰²æ­£ç¡®ï¼ˆ<60% ç»¿ï¼Œ60-80% é»„ï¼Œ>80% çº¢ï¼‰
- [x] ç‚¹å‡»çŠ¶æ€æ æ˜¾ç¤ºè¯¦æƒ…å¡ç‰‡
- [x] Context View æ–°å¢ Budget æ ‡ç­¾é¡µ
- [x] Budget æ ‡ç­¾é¡µæ˜¾ç¤ºå®Œæ•´åˆ†é…è¡¨
- [x] æˆªæ–­å†å²æ­£ç¡®è®°å½•å’Œæ˜¾ç¤º

## ğŸ§ª æµ‹è¯•ç»“æœ

è¿è¡Œ `python3 test_budget_visualization.py`ï¼š

```
Results: 5/5 tests passed
âœ… All tests passed! Task 5 implementation is complete.
```

### æµ‹è¯•è¦†ç›–

1. âœ… Context Builder Logging - é¢„ç®—æ—¥å¿—å’Œæˆªæ–­æ—¥å¿—
2. âœ… WebSocket Budget Update - budget_update æ¶ˆæ¯
3. âœ… CSS Files - æ ·å¼æ–‡ä»¶å’Œ HTML å¼•ç”¨
4. âœ… ContextView Budget Tab - Budget æ ‡ç­¾é¡µ
5. âœ… Main.js Budget Functions - å‰ç«¯é¢„ç®—å‡½æ•°

## ğŸ“¦ ä¿®æ”¹çš„æ–‡ä»¶

### åç«¯
1. `agentos/core/chat/context_builder.py` - å¢å¼ºæ—¥å¿—å’Œä½¿ç”¨ç»Ÿè®¡
2. `agentos/webui/websocket/chat.py` - å‘é€é¢„ç®—æ›´æ–°æ¶ˆæ¯

### å‰ç«¯
3. `agentos/webui/static/css/budget-indicator.css` - æ–°å¢æ ·å¼æ–‡ä»¶
4. `agentos/webui/static/js/views/ContextView.js` - æ·»åŠ  Budget æ ‡ç­¾é¡µ
5. `agentos/webui/static/js/main.js` - æ·»åŠ é¢„ç®—ç›‘æ§å‡½æ•°
6. `agentos/webui/templates/index.html` - å¼•å…¥ CSS æ–‡ä»¶

### æµ‹è¯•
7. `test_budget_visualization.py` - è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬

## ğŸ”„ æ•°æ®æµ

1. **ç”¨æˆ·å‘é€æ¶ˆæ¯**
   - ç”¨æˆ·åœ¨ Chat ç•Œé¢è¾“å…¥æ¶ˆæ¯
   - WebSocket å‘é€ `user_message`

2. **ChatEngine å¤„ç†**
   - ContextBuilder æ„å»ºä¸Šä¸‹æ–‡
   - è®°å½•é¢„ç®—ä½¿ç”¨æƒ…å†µ
   - å¿…è¦æ—¶æ‰§è¡Œæˆªæ–­ï¼ˆè®°å½•æ—¥å¿—ï¼‰

3. **å“åº”è¿”å›**
   - ChatEngine è¿”å›åŠ©æ‰‹å“åº”
   - WebSocket å‘é€ `message.end`

4. **é¢„ç®—æ›´æ–°**
   - WebSocket æ„å»ºä¸´æ—¶ context_packï¼ˆaudit æ¨¡å¼ï¼‰
   - å‘é€ `budget_update` æ¶ˆæ¯åˆ°å‰ç«¯

5. **å‰ç«¯æ˜¾ç¤º**
   - `updateBudgetIndicator()` æ›´æ–°çŠ¶æ€æ 
   - æ˜¾ç¤ºä½¿ç”¨é‡ã€ç™¾åˆ†æ¯”ã€çŠ¶æ€å¾½ç« 
   - ç”¨æˆ·å¯ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…

## ğŸ¨ è§†è§‰è®¾è®¡

### é¢œè‰²ç¼–ç 
- **ç»¿è‰² (Safe)**: ä½¿ç”¨ç‡ < 60%
- **é»„è‰² (Warning)**: ä½¿ç”¨ç‡ 60-80%
- **çº¢è‰² (Critical)**: ä½¿ç”¨ç‡ > 80%

### å­—ä½“
- ä½¿ç”¨é‡ï¼šç­‰å®½å­—ä½“ï¼ˆMonaco, Menlo, Courier Newï¼‰
- æ ‡ç­¾ï¼šç³»ç»Ÿé»˜è®¤å­—ä½“
- è¡¨æ ¼ï¼šç³»ç»Ÿé»˜è®¤å­—ä½“

### äº¤äº’
- é¢„ç®—æŒ‡ç¤ºå™¨å¯ç‚¹å‡»
- é¼ æ ‡æ‚¬åœæ˜¾ç¤º hover æ•ˆæœ
- æ¨¡æ€æ¡†æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

1. **èŠ‚æµæ›´æ–°**
   - åªåœ¨æ¶ˆæ¯å®Œæˆåæ›´æ–°ï¼ˆä¸æ˜¯æ¯ä¸ª deltaï¼‰
   - é¿å…é¢‘ç¹é‡ç»˜

2. **æŒ‰éœ€åˆ›å»º**
   - é¢„ç®—æŒ‡ç¤ºå™¨åªåœ¨éœ€è¦æ—¶åˆ›å»º
   - ä¸åœ¨é Chat è§†å›¾åˆ›å»º

3. **è½»é‡çº§è®¡ç®—**
   - ä½¿ç”¨ `audit` æ¨¡å¼æ„å»ºä¸Šä¸‹æ–‡
   - ä¸æ‰§è¡Œå®é™…çš„æ¨¡å‹è°ƒç”¨

## ğŸ“š ç”¨æˆ·æŒ‡å—

### å¦‚ä½•æŸ¥çœ‹é¢„ç®—çŠ¶æ€
1. æ‰“å¼€ Chat ç•Œé¢
2. æŸ¥çœ‹é¡¶éƒ¨å·¥å…·æ å³ä¾§çš„é¢„ç®—æŒ‡ç¤ºå™¨
3. ç»¿è‰²è¡¨ç¤ºå®‰å…¨ï¼Œé»„è‰²è¡¨ç¤ºè­¦å‘Šï¼Œçº¢è‰²è¡¨ç¤ºå±é™©

### å¦‚ä½•æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
1. ç‚¹å‡»é¢„ç®—æŒ‡ç¤ºå™¨ï¼ˆğŸ“Š å›¾æ ‡ï¼‰
2. æŸ¥çœ‹å¼¹å‡ºçš„è¯¦æƒ…å¡ç‰‡
3. äº†è§£å„ç»„ä»¶çš„ Token ä½¿ç”¨æƒ…å†µ

### å¦‚ä½•æŸ¥çœ‹å†å²è®°å½•
1. åˆ‡æ¢åˆ° Context View
2. ç‚¹å‡» "Budget" æ ‡ç­¾é¡µ
3. æŸ¥çœ‹é¢„ç®—åˆ†é…è¡¨å’Œæˆªæ–­å†å²

## ğŸ”§ ç»´æŠ¤è¯´æ˜

### æ·»åŠ æ–°çš„é¢„ç®—ç»„ä»¶
1. åœ¨ `ContextBudget` ä¸­æ·»åŠ æ–°å­—æ®µ
2. åœ¨ `ContextUsage` ä¸­æ·»åŠ å¯¹åº”çš„ä½¿ç”¨ç»Ÿè®¡
3. åœ¨ `breakdown` å­—æ®µä¸­åŒ…å«æ–°ç»„ä»¶
4. æ›´æ–°å‰ç«¯æ˜¾ç¤ºé€»è¾‘

### ä¿®æ”¹é˜ˆå€¼
åœ¨ `updateBudgetIndicator()` ä¸­ä¿®æ”¹ `statusConfig`ï¼š
```javascript
const statusConfig = {
    safe: { ... },      // < 60%
    warning: { ... },   // 60-80%
    critical: { ... }   // > 80%
};
```

### è‡ªå®šä¹‰æ ·å¼
ç¼–è¾‘ `agentos/webui/static/css/budget-indicator.css`

## ğŸ“ˆ ä¸‹ä¸€æ­¥å»ºè®®

1. **å®æ—¶æ›´æ–°**
   - åœ¨æ¯æ¬¡å¯¹è¯è½®æ¬¡åè‡ªåŠ¨åˆ·æ–°
   - æ·»åŠ  WebSocket å¿ƒè·³æ£€æµ‹

2. **å†å²è¶‹åŠ¿**
   - è®°å½•é¢„ç®—ä½¿ç”¨å†å²
   - æ˜¾ç¤ºä½¿ç”¨è¶‹åŠ¿å›¾è¡¨

3. **æ™ºèƒ½å»ºè®®**
   - æ ¹æ®ä½¿ç”¨æƒ…å†µè‡ªåŠ¨å»ºè®® `/summary`
   - é¢„æµ‹ä½•æ—¶ä¼šè¶…è¿‡é¢„ç®—

4. **å¯¼å‡ºåŠŸèƒ½**
   - å¯¼å‡ºé¢„ç®—ä½¿ç”¨æŠ¥å‘Š
   - åˆ†æå¯¹è¯æ•ˆç‡

## âœ… ä»»åŠ¡å®Œæˆ

ä»»åŠ¡ 5ï¼ˆè¿è¡Œæ—¶å¯è§†åŒ–ï¼‰å·²å®Œæˆï¼æ‰€æœ‰éªŒæ”¶æ ‡å‡†å‡å·²æ»¡è¶³ï¼Œæµ‹è¯•å…¨éƒ¨é€šè¿‡ã€‚

---

**å®æ–½æ—¥æœŸ**: 2025-01-30
**æµ‹è¯•çŠ¶æ€**: âœ… 5/5 é€šè¿‡
**ä»»åŠ¡çŠ¶æ€**: âœ… å®Œæˆ
