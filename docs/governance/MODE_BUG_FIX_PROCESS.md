# Mode ç³»ç»Ÿ Bug ä¿®å¤æµç¨‹

**ç‰ˆæœ¬**: 1.0.0
**ç”Ÿæ•ˆæ—¥æœŸ**: 2026-01-30
**é€‚ç”¨èŒƒå›´**: Mode ç³»ç»Ÿå†»ç»“æœŸé—´çš„ Bug ä¿®å¤
**çŠ¶æ€**: Active

---

## ç›®å½•

1. [Bug ä¸¥é‡çº§åˆ«å®šä¹‰](#1-bug-ä¸¥é‡çº§åˆ«å®šä¹‰)
2. [Bug æŠ¥å‘Šæµç¨‹](#2-bug-æŠ¥å‘Šæµç¨‹)
3. [Bug ä¿®å¤æµç¨‹](#3-bug-ä¿®å¤æµç¨‹)
4. [Bug ä¿®å¤æœ€ä½³å®è·µ](#4-bug-ä¿®å¤æœ€ä½³å®è·µ)
5. [è´¨é‡ä¿è¯](#5-è´¨é‡ä¿è¯)
6. [é™„å½•](#6-é™„å½•)

---

## 1. Bug ä¸¥é‡çº§åˆ«å®šä¹‰

### 1.1 Critical (P0) - è‡´å‘½çº§

#### å®šä¹‰
ç³»ç»Ÿçº§æ•…éšœï¼Œå¯¼è‡´æ ¸å¿ƒåŠŸèƒ½å®Œå…¨ä¸å¯ç”¨ï¼Œéœ€è¦ç«‹å³å“åº”ã€‚

#### SLA
- **å“åº”æ—¶é—´**: 1 å°æ—¶å†…å“åº”
- **ä¿®å¤æ—¶é—´**: 24 å°æ—¶å†…ä¿®å¤
- **å·¥ä½œæ–¹å¼**: 7Ã—24 å…¨å¤©å€™å“åº”

#### è¯†åˆ«æ ‡å‡†
- âœ… ç³»ç»Ÿå´©æºƒæˆ–æ— æ³•å¯åŠ¨
- âœ… æ•°æ®ä¸¢å¤±æˆ–æ•°æ®æŸå
- âœ… ä¸¥é‡å®‰å…¨æ¼æ´ï¼ˆCVE >= 9.0ï¼‰
- âœ… æ ¸å¿ƒåŠŸèƒ½å®Œå…¨ä¸å¯ç”¨
- âœ… å½±å“ > 80% ç”¨æˆ·

#### ç¤ºä¾‹

```markdown
ğŸš¨ **ç¤ºä¾‹ 1: ç³»ç»Ÿå´©æºƒ**
- **ç°è±¡**: Mode policy åŠ è½½æ—¶è§¦å‘ segfaultï¼Œå¯¼è‡´æ•´ä¸ª AgentOS è¿›ç¨‹å´©æºƒ
- **å½±å“**: æ‰€æœ‰ç”¨æˆ·æ— æ³•ä½¿ç”¨ç³»ç»Ÿ
- **é‡ç°ç‡**: 100%

ğŸš¨ **ç¤ºä¾‹ 2: æ•°æ®ä¸¢å¤±**
- **ç°è±¡**: Mode çŠ¶æ€æ›´æ–°æ—¶æ•°æ®åº“äº‹åŠ¡å›æ»šï¼Œå¯¼è‡´ä»»åŠ¡çŠ¶æ€ä¸¢å¤±
- **å½±å“**: ç”¨æˆ·ä»»åŠ¡è¿›åº¦æ•°æ®æ°¸ä¹…ä¸¢å¤±
- **é‡ç°ç‡**: 50%

ğŸš¨ **ç¤ºä¾‹ 3: å®‰å…¨æ¼æ´**
- **ç°è±¡**: Mode policy é…ç½®æ–‡ä»¶æœªéªŒè¯è¾“å…¥ï¼Œå­˜åœ¨è·¯å¾„éå†æ¼æ´
- **å½±å“**: æ”»å‡»è€…å¯è¯»å–ä»»æ„ç³»ç»Ÿæ–‡ä»¶
- **CVE è¯„åˆ†**: 9.3
```

#### å¤„ç†æµç¨‹
1. **ç«‹å³å“åº”**: æ”¶åˆ°æŠ¥å‘Šå 1 å°æ—¶å†…ç¡®è®¤
2. **ç´§æ€¥ä¿®å¤**: å¯åŠ¨ç´§æ€¥ä¿®å¤æµç¨‹
3. **ä¸´æ—¶ç¼“è§£**: å¦‚æ— æ³•ç«‹å³ä¿®å¤ï¼Œå…ˆéƒ¨ç½²ä¸´æ—¶ç¼“è§£æªæ–½
4. **æ ¹å› åˆ†æ**: ä¿®å¤åè¿›è¡Œå®Œæ•´çš„æ ¹å› åˆ†æ
5. **Postmortem**: å‘å¸ƒäº‹æ•…æŠ¥å‘Š

---

### 1.2 High (P1) - é«˜çº§

#### å®šä¹‰
æ ¸å¿ƒåŠŸèƒ½ä¸å¯ç”¨æˆ–ä¸¥é‡æ€§èƒ½ä¸‹é™ï¼Œéœ€è¦ä¼˜å…ˆå¤„ç†ã€‚

#### SLA
- **å“åº”æ—¶é—´**: 4 å°æ—¶å†…å“åº”
- **ä¿®å¤æ—¶é—´**: 3 å¤©å†…ä¿®å¤
- **å·¥ä½œæ–¹å¼**: å·¥ä½œæ—¶é—´ä¼˜å…ˆå¤„ç†

#### è¯†åˆ«æ ‡å‡†
- âœ… æ ¸å¿ƒåŠŸèƒ½ä¸å¯ç”¨ä½†ç³»ç»Ÿå¯è¿è¡Œ
- âœ… æ€§èƒ½ä¸¥é‡ä¸‹é™ï¼ˆ> 50% é€€åŒ–ï¼‰
- âœ… å½±å“ 30-80% ç”¨æˆ·
- âœ… ä¸­ç­‰å®‰å…¨æ¼æ´ï¼ˆCVE 7.0-8.9ï¼‰
- âœ… æ•°æ®ä¸€è‡´æ€§é—®é¢˜

#### ç¤ºä¾‹

```markdown
âš ï¸ **ç¤ºä¾‹ 1: æ ¸å¿ƒåŠŸèƒ½ä¸å¯ç”¨**
- **ç°è±¡**: Mode å†³ç­–é€»è¾‘é”™è¯¯ï¼Œé”™è¯¯åœ°æ‹¦æˆªæ‰€æœ‰ "write" æ“ä½œ
- **å½±å“**: ç”¨æˆ·æ— æ³•æ‰§è¡Œä»»ä½•å†™æ“ä½œä»»åŠ¡
- **é‡ç°ç‡**: 100%
- **ç¼“è§£æªæ–½**: ä¸´æ—¶ç¦ç”¨ Mode ç­–ç•¥

âš ï¸ **ç¤ºä¾‹ 2: æ€§èƒ½ä¸¥é‡ä¸‹é™**
- **ç°è±¡**: Mode policy è¯„ä¼°æ—¶æœªä½¿ç”¨ç¼“å­˜ï¼Œæ¯æ¬¡éƒ½é‡æ–°è§£æé…ç½®æ–‡ä»¶
- **å½±å“**: ä»»åŠ¡å¯åŠ¨æ—¶é—´ä» 100ms å¢åŠ åˆ° 2000msï¼ˆ20x é€€åŒ–ï¼‰
- **é‡ç°ç‡**: 100%

âš ï¸ **ç¤ºä¾‹ 3: å‘Šè­¦ç³»ç»Ÿå¤±æ•ˆ**
- **ç°è±¡**: Mode alerts å‘é€å¤±è´¥ï¼Œä½†æœªè®°å½•é”™è¯¯æ—¥å¿—
- **å½±å“**: ç”¨æˆ·æ— æ³•æ”¶åˆ°é‡è¦å‘Šè­¦é€šçŸ¥
- **é‡ç°ç‡**: 30%
```

#### å¤„ç†æµç¨‹
1. **å¿«é€Ÿå“åº”**: 4 å°æ—¶å†…ç¡®è®¤å’Œåˆ†ç±»
2. **ä¼˜å…ˆä¿®å¤**: æ’å…¥å½“å‰ Sprintï¼Œä¼˜å…ˆå¤„ç†
3. **è¿›åº¦è·Ÿè¸ª**: æ¯æ—¥æ›´æ–°è¿›åº¦
4. **å……åˆ†æµ‹è¯•**: å®Œæ•´çš„å›å½’æµ‹è¯•
5. **å‘å¸ƒè¯´æ˜**: åœ¨ Release Notes ä¸­è¯´æ˜

---

### 1.3 Medium (P2) - ä¸­çº§

#### å®šä¹‰
åŠŸèƒ½éƒ¨åˆ†ä¸å¯ç”¨æˆ–æœ‰æ˜æ˜¾é”™è¯¯ï¼Œä¸å½±å“æ ¸å¿ƒæµç¨‹ã€‚

#### SLA
- **å“åº”æ—¶é—´**: 1 å‘¨å†…å“åº”
- **ä¿®å¤æ—¶é—´**: 2 å‘¨å†…ä¿®å¤
- **å·¥ä½œæ–¹å¼**: æ­£å¸¸æ’æœŸå¤„ç†

#### è¯†åˆ«æ ‡å‡†
- âœ… éæ ¸å¿ƒåŠŸèƒ½ä¸å¯ç”¨
- âœ… æ¬¡è¦æ€§èƒ½é—®é¢˜ï¼ˆ10-50% é€€åŒ–ï¼‰
- âœ… å½±å“ < 30% ç”¨æˆ·
- âœ… ä½é£é™©å®‰å…¨é—®é¢˜ï¼ˆCVE 4.0-6.9ï¼‰
- âœ… é”™è¯¯æç¤ºä¸å‡†ç¡®

#### ç¤ºä¾‹

```markdown
ğŸ“Œ **ç¤ºä¾‹ 1: éæ ¸å¿ƒåŠŸèƒ½é”™è¯¯**
- **ç°è±¡**: Mode ç›‘æ§é¢æ¿æ˜¾ç¤ºçš„ç»Ÿè®¡æ•°æ®æœ‰æ—¶ä¸å‡†ç¡®
- **å½±å“**: ä¸å½±å“æ ¸å¿ƒåŠŸèƒ½ï¼Œä»…å½±å“ç›‘æ§å¯è§†åŒ–
- **é‡ç°ç‡**: 20%

ğŸ“Œ **ç¤ºä¾‹ 2: é”™è¯¯æç¤ºä¸å‡†ç¡®**
- **ç°è±¡**: Mode policy åŠ è½½å¤±è´¥æ—¶ï¼Œé”™è¯¯ä¿¡æ¯ä¸º "Unknown error"
- **å½±å“**: ç”¨æˆ·æ— æ³•å¿«é€Ÿè¯Šæ–­é—®é¢˜
- **é‡ç°ç‡**: 100%

ğŸ“Œ **ç¤ºä¾‹ 3: é…ç½®éªŒè¯ç¼ºå¤±**
- **ç°è±¡**: Mode é…ç½®æ–‡ä»¶ä¸­çš„æ— æ•ˆå­—æ®µæœªè¢«æ£€æµ‹
- **å½±å“**: é…ç½®é”™è¯¯ç›´åˆ°è¿è¡Œæ—¶æ‰å‘ç°
- **é‡ç°ç‡**: 100%
```

#### å¤„ç†æµç¨‹
1. **æ­£å¸¸å“åº”**: 1 å‘¨å†…ç¡®è®¤
2. **æ­£å¸¸æ’æœŸ**: çº³å…¥ä¸‹ä¸ª Sprint
3. **æ ‡å‡†æµ‹è¯•**: å®Œæˆå•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
4. **å‘å¸ƒè¯´æ˜**: åœ¨ CHANGELOG ä¸­è¯´æ˜

---

### 1.4 Low (P3) - ä½çº§

#### å®šä¹‰
å°é—®é¢˜ã€UI ç‘•ç–µã€æ–‡æ¡£é”™è¯¯ï¼Œä¸å½±å“åŠŸèƒ½ä½¿ç”¨ã€‚

#### SLA
- **å“åº”æ—¶é—´**: 2 å‘¨å†…å“åº”
- **ä¿®å¤æ—¶é—´**: ä¸‹ä¸ªç‰ˆæœ¬ä¿®å¤
- **å·¥ä½œæ–¹å¼**: ç§¯å‹å¤„ç†

#### è¯†åˆ«æ ‡å‡†
- âœ… UI/UX å°é—®é¢˜
- âœ… æ–‡æ¡£é”™è¯¯æˆ–é—æ¼
- âœ… æ—¥å¿—æ ¼å¼é—®é¢˜
- âœ… ä»£ç é£æ ¼é—®é¢˜
- âœ… éå…³é”®æ€§èƒ½ä¼˜åŒ–

#### ç¤ºä¾‹

```markdown
ğŸ’¡ **ç¤ºä¾‹ 1: UI ç‘•ç–µ**
- **ç°è±¡**: Mode ç›‘æ§é¢æ¿çš„å›¾è¡¨æ ‡é¢˜å¯¹é½ä¸ä¸€è‡´
- **å½±å“**: ä¸å½±å“åŠŸèƒ½ï¼Œä»…è§†è§‰æ•ˆæœä¸ä½³
- **é‡ç°ç‡**: 100%

ğŸ’¡ **ç¤ºä¾‹ 2: æ–‡æ¡£é”™è¯¯**
- **ç°è±¡**: README.md ä¸­çš„ API ç¤ºä¾‹ä»£ç æœ‰æ‹¼å†™é”™è¯¯
- **å½±å“**: ç”¨æˆ·å¯èƒ½éœ€è¦è°ƒè¯•ï¼Œä½†ä¸å½±å“å®é™…åŠŸèƒ½
- **é‡ç°ç‡**: N/A

ğŸ’¡ **ç¤ºä¾‹ 3: æ—¥å¿—æ ¼å¼**
- **ç°è±¡**: Mode æ—¥å¿—ä¸­æ—¶é—´æˆ³æ ¼å¼ä¸ç»Ÿä¸€
- **å½±å“**: ä¸å½±å“åŠŸèƒ½ï¼Œä»…å½±å“æ—¥å¿—å¯è¯»æ€§
- **é‡ç°ç‡**: 100%
```

#### å¤„ç†æµç¨‹
1. **æ ‡è®°å¾…åŠ**: æ·»åŠ åˆ° Backlog
2. **æ‰¹é‡å¤„ç†**: ç§¯ç´¯åæ‰¹é‡ä¿®å¤
3. **åŸºæœ¬æµ‹è¯•**: åŸºæœ¬åŠŸèƒ½éªŒè¯
4. **å‘å¸ƒè¯´æ˜**: å¯é€‰

---

## 2. Bug æŠ¥å‘Šæµç¨‹

### 2.1 Bug æŠ¥å‘Šæ¨¡æ¿

è¯·ä½¿ç”¨ä»¥ä¸‹æ¨¡æ¿æŠ¥å‘Š Mode ç³»ç»Ÿçš„ Bugï¼š

```markdown
## Bug æŠ¥å‘Š

### åŸºæœ¬ä¿¡æ¯
- **æŠ¥å‘Šäºº**: [å§“å/ç”¨æˆ·å]
- **æŠ¥å‘Šæ—¥æœŸ**: [YYYY-MM-DD]
- **ç‰ˆæœ¬**: [AgentOS ç‰ˆæœ¬å·]
- **ç¯å¢ƒ**: [ç”Ÿäº§/æµ‹è¯•/å¼€å‘]
- **ä¸¥é‡çº§åˆ«**: [P0/P1/P2/P3]

### é—®é¢˜æè¿°

#### ç®€è¦æè¿°
[ä¸€å¥è¯æè¿°é—®é¢˜]

#### è¯¦ç»†æè¿°
[è¯¦ç»†è¯´æ˜é—®é¢˜ç°è±¡ã€å½±å“èŒƒå›´ã€é‡ç°ç‡ç­‰]

#### é¢„æœŸè¡Œä¸º
[æè¿°æ­£ç¡®çš„è¡Œä¸ºåº”è¯¥æ˜¯ä»€ä¹ˆ]

#### å®é™…è¡Œä¸º
[æè¿°å®é™…è§‚å¯Ÿåˆ°çš„é”™è¯¯è¡Œä¸º]

### é‡ç°æ­¥éª¤

1. [æ­¥éª¤ 1]
2. [æ­¥éª¤ 2]
3. [æ­¥éª¤ 3]
...

**é‡ç°ç‡**: [100% / ç»å¸¸ / å¶å°” / ç½•è§]

### ç¯å¢ƒä¿¡æ¯

- **æ“ä½œç³»ç»Ÿ**: [Linux/macOS/Windows + ç‰ˆæœ¬]
- **Python ç‰ˆæœ¬**: [3.x.x]
- **AgentOS ç‰ˆæœ¬**: [x.x.x]
- **Mode é…ç½®**: [default/dev/strict/custom]

### æ—¥å¿—å’Œæˆªå›¾

#### é”™è¯¯æ—¥å¿—
\```
[ç²˜è´´ç›¸å…³æ—¥å¿—]
\```

#### æˆªå›¾
[å¦‚æœé€‚ç”¨ï¼Œæ·»åŠ æˆªå›¾]

### å½±å“èŒƒå›´

- **å½±å“çš„æ¨¡å—**: [mode_policy/mode_alerts/mode_monitoring/...]
- **å½±å“çš„ç”¨æˆ·**: [å…¨éƒ¨/éƒ¨åˆ†ï¼ˆä¼°è®¡ç™¾åˆ†æ¯”ï¼‰]
- **å½±å“çš„åŠŸèƒ½**: [æ ¸å¿ƒåŠŸèƒ½/è¾…åŠ©åŠŸèƒ½]

### å¯èƒ½çš„åŸå› 

[å¦‚æœæœ‰åˆæ­¥åˆ†æï¼Œè¯·æä¾›å¯èƒ½çš„åŸå› ]

### ä¸´æ—¶ç¼“è§£æªæ–½

[å¦‚æœæ‰¾åˆ°äº†ä¸´æ—¶è§„é¿æ–¹æ³•ï¼Œè¯·è¯´æ˜]
```

### 2.2 æäº¤æ–¹å¼

#### GitHub Issuesï¼ˆæ¨èï¼‰
1. è®¿é—® [GitHub Issues](https://github.com/your-org/agentos/issues)
2. ç‚¹å‡» "New Issue"
3. é€‰æ‹© "Bug Report" æ¨¡æ¿
4. æ·»åŠ æ ‡ç­¾ï¼š
   - `bug` - æ ‡è®°ä¸º Bug
   - `mode-system` - æ ‡è®°ä¸º Mode ç³»ç»Ÿç›¸å…³
   - `P0`/`P1`/`P2`/`P3` - æ ‡è®°ä¸¥é‡çº§åˆ«
5. å¡«å†™å®Œæ•´çš„ Bug æŠ¥å‘Š
6. æäº¤

#### å†…éƒ¨ Bug è¿½è¸ªç³»ç»Ÿ
- ç™»å½•å†…éƒ¨ç³»ç»Ÿ
- é€‰æ‹© "Mode System" ç»„ä»¶
- å¡«å†™ Bug æŠ¥å‘Šè¡¨å•
- è‡ªåŠ¨åŒæ­¥åˆ° GitHub Issues

#### ç´§æ€¥æƒ…å†µè”ç³»
- **P0 çº§åˆ«**: ç›´æ¥æ‹¨æ‰“ç´§æ€¥çƒ­çº¿ `mode-emergency@company.com`
- **é‚®ä»¶ä¸»é¢˜**: `[P0] Mode System Critical Bug: [ç®€è¦æè¿°]`

### 2.3 Bug åˆ†ç±»å’Œåˆ†é…

#### è‡ªåŠ¨åˆ†ç±»
ç³»ç»Ÿä¼šæ ¹æ®å…³é”®è¯è‡ªåŠ¨åˆ†ç±»ï¼š
- åŒ…å« "crash", "segfault", "data loss" â†’ P0
- åŒ…å« "can't", "unable", "fails" â†’ P1
- åŒ…å« "incorrect", "wrong", "unexpected" â†’ P2
- åŒ…å« "typo", "UI", "cosmetic" â†’ P3

#### äººå·¥ç¡®è®¤
æŠ€æœ¯è´Ÿè´£äººä¼šåœ¨ SLA æ—¶é—´å†…ç¡®è®¤ä¸¥é‡çº§åˆ«ï¼š
- P0: 1 å°æ—¶å†…
- P1: 4 å°æ—¶å†…
- P2: 1 å‘¨å†…
- P3: 2 å‘¨å†…

#### åˆ†é…è´Ÿè´£äºº
æ ¹æ®é—®é¢˜ç±»å‹åˆ†é…ï¼š
- `mode_policy.py` ç›¸å…³ â†’ Policy ä¸“å®¶
- `mode_alerts.py` ç›¸å…³ â†’ Alerts ä¸“å®¶
- `mode_monitoring.py` ç›¸å…³ â†’ API ä¸“å®¶
- å‰ç«¯é—®é¢˜ â†’ å‰ç«¯ä¸“å®¶

---

## 3. Bug ä¿®å¤æµç¨‹

### 3.1 éªŒè¯å’Œåˆ†ç±»

#### æ­¥éª¤ 1: éªŒè¯ Bug å¯é‡ç°
```bash
# 1. æ£€å‡ºç›¸å…³ä»£ç 
git checkout master
cd agentos/core/mode

# 2. åˆ›å»ºæµ‹è¯•ç¯å¢ƒ
python -m venv venv_bugfix
source venv_bugfix/bin/activate
pip install -e .[dev]

# 3. æŒ‰ç…§ Bug æŠ¥å‘Šé‡ç°é—®é¢˜
python test_bug_reproduction.py

# 4. è®°å½•é‡ç°ç»“æœ
# - æ˜¯å¦å¯é‡ç°ï¼Ÿ
# - é‡ç°ç‡æ˜¯å¤šå°‘ï¼Ÿ
# - æ˜¯å¦ä¸æŠ¥å‘Šä¸€è‡´ï¼Ÿ
```

#### æ­¥éª¤ 2: ç¡®è®¤ä¸¥é‡çº§åˆ«
æ ¹æ®å®é™…éªŒè¯ç»“æœï¼Œç¡®è®¤æˆ–è°ƒæ•´ä¸¥é‡çº§åˆ«ï¼š
- å®é™…å½±å“æ˜¯å¦ä¸æŠ¥å‘Šä¸€è‡´ï¼Ÿ
- æ˜¯å¦æœ‰ç¼“è§£æªæ–½ï¼Ÿ
- æ˜¯å¦å½±å“æ ¸å¿ƒåŠŸèƒ½ï¼Ÿ

#### æ­¥éª¤ 3: åˆ†é…ç»™è´Ÿè´£äºº
- åœ¨ GitHub Issue ä¸­ @è´Ÿè´£äºº
- è®¾ç½® Milestoneï¼ˆå¦‚ v1.0.1ï¼‰
- è®¾ç½®é¢„æœŸå®Œæˆæ—¶é—´

### 3.2 ä¿®å¤å¼€å‘

#### æ­¥éª¤ 1: åˆ›å»º Bug ä¿®å¤åˆ†æ”¯
```bash
# åˆ†æ”¯å‘½åè§„èŒƒ: fix/mode-{issue-number}-{short-description}
git checkout master
git pull origin master
git checkout -b fix/mode-123-policy-crash
```

#### æ­¥éª¤ 2: ç¼–å†™ä¿®å¤ä»£ç 

**åŸåˆ™ï¼šæœ€å°åŒ–å˜æ›´**
```python
# âŒ ä¸å¥½çš„ä¿®å¤ï¼šé‡å†™æ•´ä¸ªæ–¹æ³•
def evaluate_policy(self, mode: str) -> bool:
    # å®Œå…¨é‡å†™äº†æ–¹æ³•é€»è¾‘
    ...

# âœ… å¥½çš„ä¿®å¤ï¼šåªä¿®æ”¹é”™è¯¯çš„éƒ¨åˆ†
def evaluate_policy(self, mode: str) -> bool:
    # åŸæœ‰é€»è¾‘ä¿æŒä¸å˜
    if not mode:
        return False

    # ä¿®å¤ï¼šæ·»åŠ  None æ£€æŸ¥ï¼ˆåŸæ¥ç¼ºå°‘è¿™ä¸ªæ£€æŸ¥ï¼‰
    if self.rules is None:
        return False

    # åŸæœ‰é€»è¾‘ä¿æŒä¸å˜
    return self._check_rules(mode)
```

#### æ­¥éª¤ 3: æ·»åŠ å›å½’æµ‹è¯•
```python
# tests/unit/mode/test_mode_policy_bugfix.py

def test_evaluate_policy_with_none_rules():
    """
    å›å½’æµ‹è¯•ï¼šä¿®å¤ Issue #123
    å½“ rules ä¸º None æ—¶ï¼Œevaluate_policy åº”è¯¥è¿”å› False è€Œä¸æ˜¯å´©æºƒ
    """
    policy = ModePolicy(rules=None)

    # ä¿®å¤å‰ï¼šä¼šæŠ›å‡º AttributeError
    # ä¿®å¤åï¼šåº”è¯¥è¿”å› False
    assert policy.evaluate_policy("read") == False

def test_evaluate_policy_with_empty_mode():
    """
    å›å½’æµ‹è¯•ï¼šä¿®å¤ Issue #123
    å½“ mode ä¸ºç©ºå­—ç¬¦ä¸²æ—¶ï¼Œevaluate_policy åº”è¯¥è¿”å› False
    """
    policy = ModePolicy(rules=[...])
    assert policy.evaluate_policy("") == False
    assert policy.evaluate_policy(None) == False
```

#### æ­¥éª¤ 4: é€šè¿‡æ‰€æœ‰ç°æœ‰æµ‹è¯•
```bash
# è¿è¡Œ Mode ç³»ç»Ÿæ‰€æœ‰æµ‹è¯•
pytest tests/unit/mode/ -v
pytest tests/integration/mode/ -v

# è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶ï¼ˆç¡®ä¿ä¸å½±å“å…¶ä»–æ¨¡å—ï¼‰
pytest tests/ -v

# æ£€æŸ¥ä»£ç é£æ ¼
flake8 agentos/core/mode/
mypy agentos/core/mode/
```

### 3.3 ä»£ç å®¡æŸ¥

#### å®¡æŸ¥æ¸…å•

**åŠŸèƒ½å®¡æŸ¥**
- [ ] æ˜¯å¦ä¿®å¤äº†æŠ¥å‘Šçš„ Bugï¼Ÿ
- [ ] æ˜¯å¦æ·»åŠ äº†å›å½’æµ‹è¯•ï¼Ÿ
- [ ] æ˜¯å¦é€šè¿‡æ‰€æœ‰ç°æœ‰æµ‹è¯•ï¼Ÿ
- [ ] æ˜¯å¦æœ‰æ–°çš„ Bug å¼•å…¥ï¼Ÿ

**å†»ç»“è§„èŒƒå®¡æŸ¥**
- [ ] æ˜¯å¦ç¬¦åˆå†»ç»“è§„èŒƒï¼Ÿ
- [ ] æ˜¯å¦åªä¿®å¤ Bugï¼Œæœªæ·»åŠ æ–°åŠŸèƒ½ï¼Ÿ
- [ ] æ˜¯å¦æ”¹å˜äº†å…¬å…± APIï¼Ÿï¼ˆåº”è¯¥ï¼šå¦ï¼‰
- [ ] æ˜¯å¦æ”¹å˜äº†é…ç½®æ–‡ä»¶æ ¼å¼ï¼Ÿï¼ˆåº”è¯¥ï¼šå¦ï¼‰
- [ ] æ˜¯å¦å‘åå…¼å®¹ï¼Ÿï¼ˆåº”è¯¥ï¼šæ˜¯ï¼‰

**ä»£ç è´¨é‡å®¡æŸ¥**
- [ ] ä»£ç æ˜¯å¦æ¸…æ™°æ˜“æ‡‚ï¼Ÿ
- [ ] æ˜¯å¦æœ‰å……åˆ†çš„æ³¨é‡Šï¼Ÿ
- [ ] æ˜¯å¦éµå¾ªä»£ç è§„èŒƒï¼Ÿ
- [ ] æ˜¯å¦æœ‰å®‰å…¨é—®é¢˜ï¼Ÿ

**æ–‡æ¡£å®¡æŸ¥**
- [ ] æ˜¯å¦æ›´æ–°äº†ç›¸å…³æ–‡æ¡£ï¼Ÿ
- [ ] æ˜¯å¦æ›´æ–°äº† CHANGELOGï¼Ÿ
- [ ] æ˜¯å¦æ›´æ–°äº† API æ–‡æ¡£ï¼ˆå¦‚æœ‰å¿…è¦ï¼‰ï¼Ÿ

#### å®¡æŸ¥æµç¨‹
1. **æäº¤ Pull Request**
   ```bash
   git push origin fix/mode-123-policy-crash
   # åœ¨ GitHub ä¸Šåˆ›å»º PR
   # æ ‡é¢˜ï¼šfix(mode): fix policy crash when rules is None (#123)
   # æè¿°ï¼šé“¾æ¥åˆ° Issueï¼Œè¯´æ˜ä¿®å¤å†…å®¹
   ```

2. **è‡³å°‘ 2 äººå®¡æŸ¥**
   - æŒ‡å®šè‡³å°‘ 2 åå®¡æŸ¥è€…
   - å…¶ä¸­è‡³å°‘ 1 äººå¿…é¡»æ˜¯ Mode ç³»ç»Ÿ Maintainer

3. **å®¡æŸ¥åé¦ˆ**
   - å®¡æŸ¥è€…æå‡ºæ„è§æˆ–æ‰¹å‡†
   - ä½œè€…ä¿®æ”¹ä»£ç å¹¶å›åº”
   - é‡å¤ç›´åˆ°æ‰€æœ‰å®¡æŸ¥è€…æ‰¹å‡†

### 3.4 åˆå¹¶å’Œå‘å¸ƒ

#### åˆå¹¶åˆ° master
```bash
# ç¡®ä¿æ‰€æœ‰å®¡æŸ¥è€…éƒ½æ‰¹å‡†
# ç¡®ä¿æ‰€æœ‰ CI æ£€æŸ¥é€šè¿‡
git checkout master
git pull origin master
git merge --no-ff fix/mode-123-policy-crash
git push origin master
```

#### åˆ›å»º Patch ç‰ˆæœ¬
```bash
# å¦‚æœæ˜¯ P0/P1 Bugï¼Œåˆ›å»º patch ç‰ˆæœ¬
# ä¾‹å¦‚ï¼šv1.0.0 â†’ v1.0.1

# 1. æ›´æ–°ç‰ˆæœ¬å·
echo "1.0.1" > VERSION

# 2. æ›´æ–° CHANGELOG
# æ·»åŠ åˆ° CHANGELOG.md:
## [1.0.1] - 2026-01-30

### Fixed
- **mode**: Fix policy crash when rules is None (#123)

# 3. åˆ›å»º Git Tag
git add VERSION CHANGELOG.md
git commit -m "chore: bump version to v1.0.1"
git tag -a v1.0.1 -m "Release v1.0.1: Fix mode policy crash"
git push origin master --tags

# 4. è§¦å‘å‘å¸ƒæµç¨‹
# CI/CD ä¼šè‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒ
```

#### æ›´æ–° CHANGELOG
```markdown
## [1.0.1] - 2026-01-30

### Fixed
- **mode-policy**: Fix crash when policy rules is None ([#123](https://github.com/your-org/agentos/issues/123))
  - **Impact**: P1 - Mode policy evaluation would crash the system when rules configuration was null
  - **Fix**: Added null check before accessing rules
  - **Regression Test**: Added test_evaluate_policy_with_none_rules()

### Changed
- None

### Added
- None
```

---

## 4. Bug ä¿®å¤æœ€ä½³å®è·µ

### 4.1 æœ€å°åŒ–å˜æ›´

**åŸåˆ™**: åªä¿®æ”¹å¿…è¦çš„ä»£ç ï¼Œä¸è¿›è¡Œä¸å¿…è¦çš„é‡æ„ã€‚

#### âœ… å¥½çš„ä¾‹å­
```python
# åªä¿®å¤å…·ä½“é—®é¢˜
def evaluate_policy(self, mode: str) -> bool:
    # æ·»åŠ ç¼ºå¤±çš„ None æ£€æŸ¥
    if self.rules is None:
        return False

    # å…¶ä»–ä»£ç ä¿æŒä¸å˜
    return self._check_rules(mode)
```

#### âŒ åçš„ä¾‹å­
```python
# è¿‡åº¦ä¿®æ”¹ï¼šé¡ºä¾¿é‡æ„äº†æ•´ä¸ªæ–¹æ³•
def evaluate_policy(self, mode: str) -> bool:
    # å¼•å…¥æ–°çš„è®¾è®¡æ¨¡å¼
    strategy = self._get_evaluation_strategy(mode)
    return strategy.evaluate()  # æ”¹å˜äº†æ•´ä¸ªå®ç°æ–¹å¼
```

### 4.2 å‘åå…¼å®¹

**åŸåˆ™**: ä¿®å¤ä¸åº”ç ´åç°æœ‰ç”¨æˆ·ä»£ç ã€‚

#### âœ… å¥½çš„ä¾‹å­
```python
# ä¿®å¤å‰
def load_policy(self, path: str) -> Policy:
    return self._load_from_file(path)

# ä¿®å¤åï¼šä¿æŒç­¾åä¸å˜
def load_policy(self, path: str) -> Policy:
    # æ·»åŠ éªŒè¯ï¼Œä½†ä¸æ”¹å˜ç­¾å
    if not os.path.exists(path):
        raise PolicyNotFoundError(f"Policy file not found: {path}")
    return self._load_from_file(path)
```

#### âŒ åçš„ä¾‹å­
```python
# ä¿®å¤å‰
def load_policy(self, path: str) -> Policy:
    return self._load_from_file(path)

# ä¿®å¤åï¼šæ”¹å˜äº†ç­¾åï¼ˆç ´åæ€§å˜æ›´ï¼‰
def load_policy(self, path: str, validate: bool = True) -> Policy:
    # æ·»åŠ äº†æ–°å‚æ•°ï¼Œå¯èƒ½ç ´åç°æœ‰è°ƒç”¨
    if validate:
        self._validate_policy_file(path)
    return self._load_from_file(path)
```

### 4.3 å®Œæ•´æµ‹è¯•

**åŸåˆ™**: æ¯ä¸ª Bug ä¿®å¤å¿…é¡»æœ‰å¯¹åº”çš„å›å½’æµ‹è¯•ã€‚

#### æµ‹è¯•ç±»å‹

**1. å›å½’æµ‹è¯•**ï¼ˆå¿…é¡»ï¼‰
```python
def test_bug_123_policy_crash_with_none_rules():
    """
    å›å½’æµ‹è¯•ï¼šIssue #123
    ç¡®ä¿ä¿®å¤åä¸ä¼šå†æ¬¡å‡ºç°ç›¸åŒé—®é¢˜
    """
    policy = ModePolicy(rules=None)
    result = policy.evaluate_policy("read")
    assert result == False  # ä¸åº”è¯¥å´©æºƒ
```

**2. è¾¹ç•Œæ¡ä»¶æµ‹è¯•**ï¼ˆæ¨èï¼‰
```python
def test_policy_edge_cases():
    """æµ‹è¯•å„ç§è¾¹ç•Œæ¡ä»¶"""
    policy = ModePolicy()

    # ç©ºå­—ç¬¦ä¸²
    assert policy.evaluate_policy("") == False

    # None
    assert policy.evaluate_policy(None) == False

    # è¶…é•¿å­—ç¬¦ä¸²
    assert policy.evaluate_policy("x" * 10000) == False
```

**3. é›†æˆæµ‹è¯•**ï¼ˆP0/P1 å¿…é¡»ï¼‰
```python
def test_mode_policy_integration_after_fix():
    """é›†æˆæµ‹è¯•ï¼šç¡®ä¿ä¿®å¤åœ¨å®é™…åœºæ™¯ä¸­å·¥ä½œ"""
    # æ¨¡æ‹ŸçœŸå®ä½¿ç”¨åœºæ™¯
    task = create_test_task()
    policy = ModePolicy.load_from_config("configs/mode/default_policy.json")

    # æ‰§è¡Œå®Œæ•´æµç¨‹
    can_execute = policy.evaluate_policy(task.mode)
    assert can_execute is not None
```

### 4.4 æ¸…æ™°æ–‡æ¡£

**åŸåˆ™**: è®°å½•ä¿®å¤åŸå› å’Œæ–¹æ¡ˆï¼Œå¸®åŠ©æœªæ¥ç»´æŠ¤ã€‚

#### Commit Message è§„èŒƒ
```bash
# æ ¼å¼ï¼šfix(scope): ç®€çŸ­æè¿° (#issue-number)
#
# è¯¦ç»†è¯´æ˜ï¼š
# - é—®é¢˜åŸå› 
# - ä¿®å¤æ–¹æ¡ˆ
# - å½±å“èŒƒå›´

git commit -m "fix(mode-policy): fix crash when rules is None (#123)

Problem:
- ModePolicy.evaluate_policy() crashes with AttributeError when
  self.rules is None
- This happens when policy config is incomplete or corrupted

Solution:
- Added None check before accessing self.rules
- Return False (deny by default) when rules is None

Impact:
- Fixes P1 crash issue
- No API changes
- Backward compatible
- Added regression test

Closes #123"
```

#### ä»£ç æ³¨é‡Š
```python
def evaluate_policy(self, mode: str) -> bool:
    """
    è¯„ä¼°ç»™å®šæ¨¡å¼æ˜¯å¦è¢«å…è®¸

    Args:
        mode: è¦è¯„ä¼°çš„æ¨¡å¼ï¼ˆå¦‚ "read", "write"ï¼‰

    Returns:
        True å¦‚æœå…è®¸ï¼ŒFalse å¦‚æœæ‹’ç»

    Raises:
        ValueError: å¦‚æœ mode æ ¼å¼æ— æ•ˆ

    Note:
        ä¿®å¤ Issue #123: æ·»åŠ äº† None æ£€æŸ¥ä»¥é¿å…å´©æºƒ
        å½“ rules ä¸º None æ—¶ï¼Œé‡‡ç”¨ deny-by-default ç­–ç•¥
    """
    # Issue #123: æ·»åŠ  None æ£€æŸ¥
    if self.rules is None:
        logger.warning("Policy rules is None, denying by default")
        return False

    # å…¶ä»–é€»è¾‘...
```

### 4.5 æ€§èƒ½è€ƒè™‘

**åŸåˆ™**: Bug ä¿®å¤ä¸åº”æ˜¾è‘—é™ä½æ€§èƒ½ã€‚

#### æ€§èƒ½æµ‹è¯•
```python
import pytest
import time

def test_mode_policy_performance_after_fix():
    """ç¡®ä¿ä¿®å¤ä¸å½±å“æ€§èƒ½"""
    policy = ModePolicy.load_from_config("configs/mode/default_policy.json")

    # åŸºå‡†æµ‹è¯•ï¼šè¯„ä¼° 1000 æ¬¡
    start = time.perf_counter()
    for _ in range(1000):
        policy.evaluate_policy("read")
    duration = time.perf_counter() - start

    # æœŸæœ›ï¼šå¹³å‡æ¯æ¬¡ < 1ms
    avg_duration_ms = (duration / 1000) * 1000
    assert avg_duration_ms < 1.0, f"Performance regression: {avg_duration_ms}ms per call"
```

---

## 5. è´¨é‡ä¿è¯

### 5.1 ä¿®å¤å‰æ£€æŸ¥æ¸…å•

- [ ] å·²å……åˆ†ç†è§£ Bug åŸå› 
- [ ] å·²è¯„ä¼°å½±å“èŒƒå›´
- [ ] å·²é€‰æ‹©æœ€å°åŒ–ä¿®å¤æ–¹æ¡ˆ
- [ ] å·²ç¡®è®¤ç¬¦åˆå†»ç»“è§„èŒƒ
- [ ] å·²å‡†å¤‡å›å½’æµ‹è¯•

### 5.2 ä¿®å¤åæ£€æŸ¥æ¸…å•

- [ ] æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] æ‰€æœ‰é›†æˆæµ‹è¯•é€šè¿‡
- [ ] å›å½’æµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½æµ‹è¯•é€šè¿‡ï¼ˆP0/P1ï¼‰
- [ ] ä»£ç å®¡æŸ¥å®Œæˆï¼ˆè‡³å°‘ 2 äººï¼‰
- [ ] æ–‡æ¡£å·²æ›´æ–°
- [ ] CHANGELOG å·²æ›´æ–°

### 5.3 å‘å¸ƒå‰æ£€æŸ¥æ¸…å•

- [ ] ç‰ˆæœ¬å·å·²æ›´æ–°
- [ ] Git Tag å·²åˆ›å»º
- [ ] Release Notes å·²å‡†å¤‡
- [ ] å›æ»šæ–¹æ¡ˆå·²å‡†å¤‡
- [ ] ç›‘æ§å‘Šè­¦å·²é…ç½®

### 5.4 å‘å¸ƒåè·Ÿè¸ª

#### 1 å‘¨å†…ç›‘æ§æŒ‡æ ‡
- **é”™è¯¯ç‡**: åº”æ— æ–°å¢é”™è¯¯
- **æ€§èƒ½**: åº”æ— æ€§èƒ½é€€åŒ–
- **ç”¨æˆ·åé¦ˆ**: æ”¶é›†ç”¨æˆ·åé¦ˆ
- **Rollback Rate**: ç›‘æ§å›æ»šç‡

#### æŠ¥å‘Šæ¨¡æ¿
```markdown
## Bug ä¿®å¤æ•ˆæœæŠ¥å‘Š

**Bug**: #123 - Mode policy crash when rules is None
**ä¿®å¤ç‰ˆæœ¬**: v1.0.1
**å‘å¸ƒæ—¥æœŸ**: 2026-01-30
**ç›‘æ§å‘¨æœŸ**: 2026-01-30 ~ 2026-02-06

### æ•ˆæœè¯„ä¼°

#### é—®é¢˜è§£å†³æƒ…å†µ
- âœ… åŸé—®é¢˜å·²è§£å†³
- âœ… æ— æ–°å¢ç›¸å…³é—®é¢˜
- âœ… æ— ç”¨æˆ·æŠ•è¯‰

#### æ€§èƒ½å½±å“
- å¹³å‡å“åº”æ—¶é—´: æ— å˜åŒ–ï¼ˆ95ms â†’ 96msï¼‰
- é”™è¯¯ç‡: ä¸‹é™ï¼ˆ0.1% â†’ 0.0%ï¼‰
- CPU ä½¿ç”¨ç‡: æ— å˜åŒ–

#### ç”¨æˆ·åé¦ˆ
- æ”¶åˆ° 3 æ¡æ­£é¢åé¦ˆ
- æ— è´Ÿé¢åé¦ˆ

### ç»“è®º
ä¿®å¤æ•ˆæœè‰¯å¥½ï¼Œè¾¾åˆ°é¢„æœŸç›®æ ‡ï¼Œå»ºè®®å…³é—­ Issueã€‚
```

---

## 6. é™„å½•

### 6.1 ç›¸å…³æ–‡æ¡£

- [MODE_FREEZE_SPECIFICATION.md](./MODE_FREEZE_SPECIFICATION.md) - Mode å†»ç»“è§„èŒƒ
- [MODE_EXCEPTION_REQUEST_TEMPLATE.md](./MODE_EXCEPTION_REQUEST_TEMPLATE.md) - ä¾‹å¤–ç”³è¯·æ¨¡æ¿
- [MODE_FREEZE_LOG.md](./MODE_FREEZE_LOG.md) - å†»ç»“æ—¥å¿—

### 6.2 å¸¸è§é—®é¢˜

**Q1: å¦‚ä½•åˆ¤æ–­æ˜¯ Bug è¿˜æ˜¯åŠŸèƒ½è¯·æ±‚ï¼Ÿ**
A: å¦‚æœç°æœ‰åŠŸèƒ½ä¸æŒ‰è®¾è®¡å·¥ä½œï¼Œåˆ™æ˜¯ Bugï¼›å¦‚æœæ˜¯è¦æ±‚æ–°åŠŸèƒ½ï¼Œåˆ™æ˜¯åŠŸèƒ½è¯·æ±‚ã€‚

**Q2: P2/P3 çº§åˆ«çš„ Bug ä½•æ—¶ä¿®å¤ï¼Ÿ**
A: P2 åœ¨ 2 å‘¨å†…ä¿®å¤ï¼ŒP3 åœ¨ä¸‹ä¸ªç‰ˆæœ¬ä¿®å¤ã€‚éƒ½ä¼šåœ¨å†»ç»“æœŸç»“æŸåå¤„ç†ã€‚

**Q3: å¦‚æœ Bug ä¿®å¤éœ€è¦ API å˜æ›´æ€ä¹ˆåŠï¼Ÿ**
A: æäº¤ä¾‹å¤–ç”³è¯·ï¼Œå¿…é¡»æœ‰å……åˆ†ç†ç”±ï¼Œä¸”éœ€è¦æ¶æ„å§”å‘˜ä¼šæ‰¹å‡†ã€‚

**Q4: å¦‚ä½•å¤„ç†ç¬¬ä¸‰æ–¹ä¾èµ–å¯¼è‡´çš„ Bugï¼Ÿ**
A: ä¼˜å…ˆå‡çº§ä¾èµ–ç‰ˆæœ¬ï¼›å¦‚éœ€ä¿®æ”¹ Mode ä»£ç ï¼ŒæŒ‰æ­£å¸¸æµç¨‹å¤„ç†ã€‚

### 6.3 å·¥å…·å’Œè„šæœ¬

#### Bug ä¿®å¤åˆ†æ”¯åˆ›å»ºè„šæœ¬
```bash
#!/bin/bash
# scripts/create_bugfix_branch.sh

ISSUE_NUMBER=$1
SHORT_DESC=$2

if [ -z "$ISSUE_NUMBER" ] || [ -z "$SHORT_DESC" ]; then
    echo "Usage: $0 <issue-number> <short-description>"
    echo "Example: $0 123 policy-crash"
    exit 1
fi

BRANCH_NAME="fix/mode-${ISSUE_NUMBER}-${SHORT_DESC}"

git checkout master
git pull origin master
git checkout -b "$BRANCH_NAME"

echo "Created branch: $BRANCH_NAME"
echo "Don't forget to:"
echo "  1. Write minimal fix code"
echo "  2. Add regression tests"
echo "  3. Run all tests"
echo "  4. Create PR with at least 2 reviewers"
```

#### æµ‹è¯•è¿è¡Œè„šæœ¬
```bash
#!/bin/bash
# scripts/run_mode_tests.sh

echo "Running Mode system tests..."

# å•å…ƒæµ‹è¯•
echo "1. Running unit tests..."
pytest tests/unit/mode/ -v --cov=agentos/core/mode --cov-report=term-missing

# é›†æˆæµ‹è¯•
echo "2. Running integration tests..."
pytest tests/integration/mode/ -v

# æ€§èƒ½æµ‹è¯•
echo "3. Running performance tests..."
pytest tests/performance/mode/ -v

# ä»£ç è´¨é‡
echo "4. Checking code quality..."
flake8 agentos/core/mode/
mypy agentos/core/mode/

echo "All tests completed!"
```

### 6.4 è”ç³»æ–¹å¼

- **Bug æŠ¥å‘Š**: GitHub Issues
- **ç´§æ€¥ Bug**: mode-emergency@company.com
- **æŠ€æœ¯æ”¯æŒ**: mode-support@company.com

---

**æ–‡æ¡£çŠ¶æ€**: âœ… Active
**æœ€åæ›´æ–°**: 2026-01-30
**ä¸‹æ¬¡è¯„å®¡**: 2026-02-28
