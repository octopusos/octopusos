# Bug 修复模板集合

**版本**: 1.0.0
**生效日期**: 2026-01-30
**适用范围**: Mode 系统 Bug 修复
**状态**: Active

---

## 目录

1. [Bug 报告模板](#1-bug-报告模板)
2. [修复方案模板](#2-修复方案模板)
3. [Code Review 检查清单](#3-code-review-检查清单)
4. [测试计划模板](#4-测试计划模板)
5. [发布说明模板](#5-发布说明模板)
6. [回滚方案模板](#6-回滚方案模板)
7. [事后分析模板](#7-事后分析模板postmortem)

---

## 1. Bug 报告模板

### 1.1 标准 Bug 报告

```markdown
# Bug 报告: [简短描述]

## 基本信息

| 字段 | 内容 |
|------|------|
| **报告人** | [姓名/用户名] |
| **报告日期** | [YYYY-MM-DD] |
| **版本** | [AgentOS 版本号] |
| **环境** | [生产/预发布/测试/开发] |
| **严重级别** | [P0/P1/P2/P3] - 初步评估 |
| **Issue 编号** | #[自动生成] |

## 问题描述

### 简要描述
[用一句话描述问题的核心]

### 详细描述
[详细说明问题现象、影响范围、重现率等]

影响的模块: `agentos/core/mode/[具体文件]`

### 预期行为
[描述正确的行为应该是什么]

示例:
```
当调用 ModePolicy.evaluate("read") 时，应该返回 True 允许读操作
```

### 实际行为
[描述实际观察到的错误行为]

示例:
```
调用 ModePolicy.evaluate("read") 时抛出 AttributeError: 'NoneType' object has no attribute 'rules'
导致整个系统崩溃
```

## 重现步骤

1. [第一步操作]
2. [第二步操作]
3. [第三步操作]
4. [观察到的错误]

**重现率**: [100% / 经常(>50%) / 偶尔(10-50%) / 罕见(<10%)]

**最小重现代码**:
```python
# 粘贴最小化的重现代码
from agentos.core.mode import ModePolicy

policy = ModePolicy(rules=None)  # 模拟配置加载失败
result = policy.evaluate("read")  # 这里会崩溃
```

## 环境信息

| 环境项 | 详情 |
|--------|------|
| **操作系统** | [Linux/macOS/Windows + 版本] |
| **Python 版本** | [3.x.x] |
| **AgentOS 版本** | [x.x.x] |
| **Mode 配置** | [default/dev/strict/custom] |
| **依赖版本** | [列出关键依赖的版本] |

## 日志和截图

### 错误日志
```
[粘贴完整的错误日志和堆栈跟踪]

Traceback (most recent call last):
  File "agentos/core/mode/mode_policy.py", line 123, in evaluate
    return self.rules.check(mode)
AttributeError: 'NoneType' object has no attribute 'check'
```

### 截图
[如果适用，添加截图或 GIF 动画]

### 相关配置文件
```json
{
  "mode_policy": {
    "enabled": true,
    "rules": null  // 注意：这里是 null
  }
}
```

## 影响范围

| 影响维度 | 评估 |
|----------|------|
| **影响的功能** | [核心功能/辅助功能/边缘功能] |
| **影响的用户** | [全部 / 部分(估计XX%) / 少数] |
| **影响的环境** | [生产/预发布/测试/开发] |
| **数据影响** | [数据丢失/数据损坏/数据不一致/无影响] |
| **安全影响** | [有/无 - 如有，描述CVE] |

### 业务影响评估
[描述对业务的具体影响]

- 是否阻塞用户工作流？
- 是否有财务影响？
- 是否影响 SLA？

## 可能的原因

[如果有初步分析，请提供可能的根本原因]

初步分析:
- [ ] 代码逻辑错误
- [ ] 配置问题
- [ ] 依赖问题
- [ ] 环境问题
- [ ] 数据问题

具体推测:
```
看起来是在 mode_policy.py 中缺少对 self.rules 为 None 的情况的检查。
当配置文件加载失败或配置为空时，rules 会是 None，导致访问 .check() 方法时崩溃。
```

## 临时缓解措施

[如果找到了临时规避方法，请说明]

**当前缓解措施**:
```bash
# 选项1: 禁用 Mode policy
export AGENTOS_MODE_POLICY_ENABLED=false

# 选项2: 使用默认配置
cp configs/mode/default_policy.json ~/.agentos/mode_policy.json

# 选项3: 降级到上一个版本
pip install agentos==1.0.0
```

**缓解措施的限制**:
- 选项1 会禁用所有策略检查，降低安全性
- 选项2 可能不适用于所有环境
- 选项3 会失去新版本的其他功能

## 相关信息

- **相关 Issue**: #[编号] - [描述]
- **相关 PR**: #[编号] - [描述]
- **相关文档**: [链接]
- **讨论记录**: [链接]

## 优先级建议

基于以上信息，建议优先级为: **[P0/P1/P2/P3]**

**理由**:
- [列出确定优先级的关键因素]
- [影响范围]
- [严重程度]
- [是否有缓解措施]

---

## 检查清单

提交前请确认:

- [ ] 问题描述清晰明确
- [ ] 提供了完整的重现步骤
- [ ] 粘贴了完整的错误日志
- [ ] 说明了环境信息
- [ ] 评估了影响范围
- [ ] 提供了临时缓解措施（如有）
- [ ] 添加了适当的标签
- [ ] 通知了相关人员
```

### 1.2 紧急 Bug 报告 (P0)

```markdown
# 🚨 紧急 Bug 报告: [简短描述]

**⚠️ 这是 P0 Critical Bug，需要立即响应！**

## 紧急信息

| 字段 | 内容 |
|------|------|
| **报告时间** | [YYYY-MM-DD HH:MM:SS] |
| **报告人** | [姓名] + [联系方式] |
| **当前状态** | 🔴 系统不可用 / 🟠 严重故障 |
| **影响用户数** | [估计数量或百分比] |
| **环境** | [生产/预发布] |

## 问题现象

[用1-2句话描述核心问题]

**严重性**:
- [ ] 系统完全崩溃
- [ ] 数据丢失/损坏
- [ ] 严重安全漏洞
- [ ] 核心功能不可用

## 立即影响

- **用户影响**: [描述]
- **数据影响**: [描述]
- **财务影响**: [描述]
- **SLA 影响**: [描述]

## 快速重现

```bash
# 最简单的重现步骤
[粘贴 1-3 行命令]
```

## 错误日志摘要

```
[粘贴关键错误信息，不超过 20 行]
```

## 临时缓解措施

**当前已采取的措施**:
- [列出已经采取的临时措施]

**建议的紧急措施**:
- [列出建议的紧急响应措施]

## 联系方式

- **报告人手机**: [电话]
- **报告人邮箱**: [邮箱]
- **当前在线**: ✅ 是 / ❌ 否

---

**🔔 已通知**: @on-call-engineer @tech-lead

**⏱️ SLA**: 1 小时内响应，24 小时内修复
```

---

## 2. 修复方案模板

### 2.1 修复方案文档

```markdown
# Bug 修复方案: [Bug 简短描述]

**Bug Issue**: #[编号]
**方案作者**: [姓名]
**方案日期**: [YYYY-MM-DD]
**严重级别**: [P0/P1/P2/P3]

---

## 1. 根因分析

### 1.1 问题根本原因

[详细说明问题的根本原因]

**根因类型**:
- [ ] 代码逻辑错误
- [ ] 边界条件未处理
- [ ] 竞态条件
- [ ] 配置错误
- [ ] 依赖问题
- [ ] 环境问题

**详细分析**:
```
在 agentos/core/mode/mode_policy.py 的 evaluate() 方法中，
当 self.rules 为 None 时，直接调用 self.rules.check(mode)
会导致 AttributeError。

根本原因是配置加载失败或配置为空时，代码没有检查 rules 是否为 None，
违反了防御性编程原则。
```

### 1.2 问题发生时机

[说明问题在什么情况下会发生]

触发条件:
1. 用户配置文件缺失或格式错误
2. 配置文件中 rules 字段为 null
3. 系统初始化时配置加载失败

### 1.3 影响范围分析

[分析问题的影响范围]

| 模块 | 影响程度 | 说明 |
|------|----------|------|
| `mode_policy.py` | 🔴 高 | 直接受影响的模块 |
| `mode_selector.py` | 🟠 中 | 依赖 policy 的模块 |
| `task_runner.py` | 🟡 低 | 间接受影响 |

---

## 2. 解决方案设计

### 2.1 方案概述

[用 2-3 句话概述解决方案]

```
在 evaluate() 方法开始处添加 None 检查。
当 rules 为 None 时，采用 "deny-by-default" 策略，返回 False 并记录警告日志。
这样既修复了崩溃问题，又保证了安全性。
```

### 2.2 技术方案

#### 方案选择

评估了以下几个方案:

| 方案 | 优点 | 缺点 | 选择 |
|------|------|------|------|
| **方案1**: 添加 None 检查 | 简单，最小化变更 | 需要考虑默认行为 | ✅ |
| **方案2**: 在加载时强制初始化 | 根本上避免 None | 可能掩盖配置问题 | ❌ |
| **方案3**: 抛出更明确的异常 | 错误信息清晰 | 仍然会崩溃 | ❌ |

**选择方案1的理由**:
- 最小化代码变更，符合冻结规范
- 不改变 API 签名
- 向后兼容
- 防御性编程，提高健壮性

#### 代码变更

**修改文件**: `agentos/core/mode/mode_policy.py`

**变更前**:
```python
def evaluate(self, mode: str) -> bool:
    """评估给定模式是否被允许"""
    return self.rules.check(mode)  # 如果 rules 为 None 会崩溃
```

**变更后**:
```python
def evaluate(self, mode: str) -> bool:
    """评估给定模式是否被允许"""
    # 修复 Issue #123: 添加 None 检查
    if self.rules is None:
        logger.warning(
            "Mode policy rules is None, denying by default. "
            "Check your configuration file."
        )
        return False  # deny-by-default 策略

    return self.rules.check(mode)
```

**变更说明**:
- ✅ 只添加了 3 行代码（None 检查和日志）
- ✅ 不改变 API 签名
- ✅ 向后兼容（之前会崩溃，现在返回 False）
- ✅ 添加了有用的日志信息

### 2.3 API 变更评估

- **是否改变 API 签名**: ❌ 否
- **是否改变返回值类型**: ❌ 否
- **是否改变行为**: ⚠️ 是（但是修复，不是破坏性变更）
  - 之前: 崩溃（AttributeError）
  - 之后: 返回 False（拒绝）
- **是否向后兼容**: ✅ 是（更好的行为）

### 2.4 性能影响评估

- **额外开销**: 1 次 None 检查（< 1 纳秒）
- **预期性能变化**: 无显著影响
- **基准测试计划**:
  ```bash
  pytest tests/performance/test_mode_policy_performance.py
  ```

---

## 3. 测试计划

### 3.1 回归测试

**新增测试文件**: `tests/unit/mode/test_mode_policy_bugfix_123.py`

```python
def test_evaluate_with_none_rules():
    """
    回归测试：修复 Issue #123
    当 rules 为 None 时，evaluate 应该返回 False 而不是崩溃
    """
    policy = ModePolicy(rules=None)

    # 修复前：会抛出 AttributeError
    # 修复后：应该返回 False（deny-by-default）
    result = policy.evaluate("read")

    assert result is False
    assert "Mode policy rules is None" in caplog.text  # 检查日志


def test_evaluate_with_empty_mode():
    """测试边界条件：空字符串 mode"""
    policy = ModePolicy(rules=None)

    assert policy.evaluate("") is False
    assert policy.evaluate(None) is False


def test_evaluate_normal_case_still_works():
    """确保修复不影响正常情况"""
    policy = ModePolicy.load_from_config("configs/mode/default_policy.json")

    # 正常情况应该仍然工作
    assert policy.evaluate("read") is True
    assert policy.evaluate("write") is True
```

### 3.2 测试覆盖率目标

- **单元测试**: 100% 覆盖新增代码
- **集成测试**: 覆盖端到端场景
- **边界测试**: 覆盖各种异常输入

### 3.3 测试矩阵

| 测试场景 | 输入 | 预期输出 | 测试类型 |
|---------|------|----------|---------|
| rules 为 None | None | False + 警告日志 | 单元 |
| mode 为空字符串 | "" | False | 单元 |
| mode 为 None | None | False | 单元 |
| 正常的 read | "read" | True | 集成 |
| 正常的 write | "write" | True | 集成 |
| 配置加载失败 | 无效配置 | False | 集成 |

---

## 4. 风险评估

### 4.1 技术风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| 引入新 Bug | 低 | 中 | 完整测试，代码审查 |
| 性能退化 | 极低 | 低 | 性能测试验证 |
| 兼容性问题 | 极低 | 中 | 向后兼容性测试 |

### 4.2 回滚风险

- **回滚难度**: 低（只需回滚一个 commit）
- **回滚时间**: < 10 分钟
- **数据影响**: 无

---

## 5. 实施计划

### 5.1 实施步骤

1. **准备阶段** (30 分钟)
   - [ ] 创建修复分支 `fix/mode-123-policy-crash`
   - [ ] 设置测试环境

2. **开发阶段** (2 小时)
   - [ ] 实施代码修复
   - [ ] 编写回归测试
   - [ ] 运行本地测试

3. **审查阶段** (4 小时)
   - [ ] 提交 PR
   - [ ] 至少 2 人审查
   - [ ] 响应审查反馈

4. **发布阶段** (2 小时)
   - [ ] 合并到 master
   - [ ] 创建 patch 版本
   - [ ] 部署到生产

5. **监控阶段** (24 小时)
   - [ ] 监控关键指标
   - [ ] 收集用户反馈
   - [ ] 验证修复效果

### 5.2 时间线

| 阶段 | 开始时间 | 预计完成 | 负责人 |
|------|---------|---------|--------|
| 准备 | T+0h | T+0.5h | [开发者] |
| 开发 | T+0.5h | T+2.5h | [开发者] |
| 审查 | T+2.5h | T+6.5h | [审查者] |
| 发布 | T+6.5h | T+8.5h | [发布经理] |
| 监控 | T+8.5h | T+32.5h | [团队] |

---

## 6. 验收标准

### 6.1 功能验收

- [ ] Bug 已修复（不再崩溃）
- [ ] 所有现有测试通过
- [ ] 新增回归测试通过
- [ ] 边界条件测试通过

### 6.2 质量验收

- [ ] 代码审查通过（至少 2 人）
- [ ] 代码覆盖率 > 80%
- [ ] 代码风格检查通过
- [ ] 文档已更新

### 6.3 性能验收

- [ ] 性能无退化
- [ ] 响应时间 < 基线 + 5%
- [ ] 内存使用无异常增长

---

## 7. 后续行动

### 7.1 监控计划

- 监控周期: 发布后 1 周
- 关键指标:
  - 错误率
  - 响应时间
  - 用户反馈

### 7.2 文档更新

- [ ] 更新 CHANGELOG.md
- [ ] 更新 API 文档（如需要）
- [ ] 更新故障排除指南

### 7.3 预防措施

为了防止类似问题再次发生:
- [ ] 在 linter 中添加 None 检查规则
- [ ] 改进配置加载的错误处理
- [ ] 添加更多的防御性编程检查

---

## 8. 审批记录

| 角色 | 姓名 | 审批结果 | 日期 | 备注 |
|------|------|---------|------|------|
| 技术负责人 | [姓名] | ✅ 批准 | [日期] | 方案合理 |
| 架构师 | [姓名] | ✅ 批准 | [日期] | 符合冻结规范 |
| 测试负责人 | [姓名] | ✅ 批准 | [日期] | 测试计划完整 |

---

**方案状态**: ✅ 已批准
**预计实施日期**: [YYYY-MM-DD]
```

---

## 3. Code Review 检查清单

### 3.1 功能审查清单

```markdown
# Code Review 检查清单 - 功能审查

**PR 编号**: #[编号]
**审查者**: [姓名]
**审查日期**: [YYYY-MM-DD]

---

## 1. Bug 修复验证

- [ ] **Bug 是否已修复**
  - 检查修复代码是否解决了报告的问题
  - 验证修复逻辑是否正确
  - 确认边界条件都已处理

- [ ] **是否添加了回归测试**
  - 测试是否覆盖了 Bug 场景
  - 测试是否能检测到原始 Bug
  - 测试是否测试了边界条件

- [ ] **是否通过所有现有测试**
  - 单元测试全部通过
  - 集成测试全部通过
  - E2E 测试全部通过

- [ ] **是否有新的 Bug 引入**
  - 检查是否引入了新的边界情况问题
  - 检查是否影响了其他功能
  - 验证错误处理是否完整

---

## 2. 代码质量检查

- [ ] **代码清晰易懂**
  - 变量命名清晰
  - 逻辑流程简洁
  - 无不必要的复杂性

- [ ] **注释充分**
  - 关键逻辑有注释说明
  - 修复原因有文档记录
  - 边界条件有说明

- [ ] **遵循代码规范**
  - 符合项目代码风格
  - 通过 linter 检查
  - 通过类型检查

- [ ] **无安全问题**
  - 无 SQL 注入风险
  - 无 XSS 风险
  - 无路径遍历风险
  - 无敏感信息泄露

---

## 3. 性能检查

- [ ] **无性能退化**
  - 检查是否引入不必要的计算
  - 检查是否有循环嵌套问题
  - 验证性能测试结果

- [ ] **资源使用合理**
  - 无内存泄漏
  - 无文件句柄泄漏
  - 无数据库连接泄漏

---

## 4. 文档检查

- [ ] **文档已更新**
  - CHANGELOG 已更新
  - API 文档已更新（如需要）
  - 内联注释已添加

- [ ] **Commit message 规范**
  - 符合 Conventional Commits 格式
  - 包含 Issue 引用
  - 说明清晰

---

## 审查结果

**总体评价**: [优秀/良好/需改进]

**审查决定**:
- [ ] ✅ 批准 (Approve)
- [ ] 💬 评论 (Comment)
- [ ] ❌ 需要修改 (Request Changes)

**反馈意见**:
[在此处填写详细的反馈意见]

---

**审查者签名**: [姓名]
**审查日期**: [YYYY-MM-DD]
```

### 3.2 冻结规范审查清单

```markdown
# Code Review 检查清单 - 冻结规范审查

**PR 编号**: #[编号]
**审查者**: [姓名]
**审查日期**: [YYYY-MM-DD]

---

## 1. 变更类型检查

- [ ] **变更类型识别**
  - [ ] Bug 修复（不改变 API）
  - [ ] 性能优化（不改变行为）
  - [ ] 安全补丁
  - [ ] 文档更新
  - [ ] 测试增强
  - [ ] ❌ 新功能（禁止）
  - [ ] ❌ API 变更（需例外批准）
  - [ ] ❌ 架构重构（需例外批准）

- [ ] **如果是禁止的变更类型，是否有例外批准**
  - 例外编号: [EXC-YYYYMMDDHHMMSS]
  - 批准文档: [链接]

---

## 2. API 兼容性检查

- [ ] **公共 API 未改变**
  - 函数/方法签名未改变
  - 返回值类型未改变
  - 异常类型未改变

- [ ] **配置格式未改变**
  - 配置文件格式保持兼容
  - 无新增必需字段
  - 默认值合理

- [ ] **向后兼容**
  - 现有用户代码无需修改
  - 现有配置文件仍然有效
  - 无破坏性变更

---

## 3. 最小化变更检查

- [ ] **只修改必要的代码**
  - 未进行不必要的重构
  - 未修改无关代码
  - 变更范围最小化

- [ ] **未引入新依赖**
  - 未添加新的第三方库
  - 如需添加，是否有充分理由

- [ ] **未改变架构**
  - 类继承关系未改变
  - 模块依赖关系未改变
  - 设计模式未改变

---

## 4. 文件修改检查

检查修改的文件是否在冻结列表中:

**核心模块**:
- [ ] `agentos/core/mode/mode_policy.py` - 是否修改？[是/否]
- [ ] `agentos/core/mode/mode_alerts.py` - 是否修改？[是/否]
- [ ] `agentos/core/mode/mode.py` - 是否修改？[是/否]
- [ ] `agentos/core/mode/mode_proposer.py` - 是否修改？[是/否]
- [ ] `agentos/core/mode/mode_selector.py` - 是否修改？[是/否]
- [ ] `agentos/core/mode/pipeline_runner.py` - 是否修改？[是/否]

**API 层**:
- [ ] `agentos/webui/api/mode_monitoring.py` - 是否修改？[是/否]

**前端层**:
- [ ] `agentos/webui/static/js/views/ModeMonitorView.js` - 是否修改？[是/否]

**配置文件**:
- [ ] `configs/mode/*.json` - 是否修改？[是/否]
- [ ] `agentos/core/mode/mode_policy.schema.json` - 是否修改？[是/否]

**如果修改了冻结文件**:
- [ ] 有正当理由（P0/P1 bug、安全补丁等）
- [ ] 已记录到 MODE_FREEZE_LOG.md
- [ ] Commit message 包含适当标记

---

## 5. 冻结规范符合性

- [ ] **符合 SLA 要求**
  - P0: 24 小时内修复
  - P1: 3 天内修复

- [ ] **遵循审批流程**
  - 至少 2 人审查
  - 包含 Mode 系统 Maintainer

- [ ] **测试充分**
  - 回归测试已添加
  - 所有测试通过

---

## 审查结果

**冻结规范符合性**: [✅ 符合 / ❌ 不符合]

**如果不符合，原因**:
[说明不符合的具体原因]

**审查决定**:
- [ ] ✅ 批准 (Approve)
- [ ] ❌ 需要修改 (Request Changes)

---

**审查者签名**: [姓名]
**审查日期**: [YYYY-MM-DD]
```

---

## 4. 测试计划模板

```markdown
# Bug 修复测试计划

**Bug Issue**: #[编号]
**测试负责人**: [姓名]
**测试日期**: [YYYY-MM-DD]

---

## 1. 测试目标

[说明测试的主要目标]

- 验证 Bug 已修复
- 确保无副作用
- 验证性能无退化
- 确保向后兼容

---

## 2. 测试范围

### 2.1 单元测试

**测试文件**: `tests/unit/mode/test_mode_policy_bugfix_123.py`

| 测试用例 | 描述 | 输入 | 预期输出 | 优先级 |
|---------|------|------|----------|--------|
| test_evaluate_with_none_rules | 测试 rules 为 None | None | False + 警告日志 | P0 |
| test_evaluate_with_empty_mode | 测试空 mode | "" | False | P1 |
| test_evaluate_normal_case | 测试正常情况 | "read" | True | P0 |

**执行命令**:
```bash
pytest tests/unit/mode/test_mode_policy_bugfix_123.py -v
```

### 2.2 集成测试

**测试文件**: `tests/integration/mode/test_mode_policy_integration.py`

| 测试用例 | 描述 | 场景 | 预期结果 | 优先级 |
|---------|------|------|----------|--------|
| test_policy_loading_failure | 配置加载失败 | 无效配置文件 | 系统优雅降级 | P0 |
| test_mode_selection_with_null_policy | 空策略下的 mode 选择 | rules=None | 默认拒绝 | P1 |

**执行命令**:
```bash
pytest tests/integration/mode/ -v
```

### 2.3 端到端测试

**测试文件**: `tests/e2e/test_mode_system_e2e.py`

| 测试用例 | 描述 | 场景 | 预期结果 | 优先级 |
|---------|------|------|----------|--------|
| test_full_task_lifecycle_with_policy | 完整任务生命周期 | 带策略的任务 | 正常运行 | P0 |
| test_recovery_from_policy_failure | 策略失败恢复 | 策略加载失败 | 系统恢复 | P1 |

**执行命令**:
```bash
pytest tests/e2e/test_mode_system_e2e.py -v
```

### 2.4 性能测试

**测试文件**: `tests/performance/test_mode_policy_performance.py`

| 测试用例 | 描述 | 基准 | 容差 | 优先级 |
|---------|------|------|------|--------|
| test_evaluate_performance | evaluate() 性能 | < 1ms | +5% | P0 |
| test_throughput | 吞吐量 | 1000 ops/s | -5% | P1 |

**执行命令**:
```bash
pytest tests/performance/test_mode_policy_performance.py -v
```

---

## 3. 测试环境

### 3.1 环境配置

| 环境 | 用途 | 配置 |
|------|------|------|
| 本地开发 | 单元测试 | Python 3.9, pytest |
| CI/CD | 自动化测试 | GitHub Actions |
| 预发布 | 集成测试 | 与生产相同配置 |
| 生产 | 最终验证 | 生产环境 |

### 3.2 测试数据

- 测试配置文件: `tests/fixtures/mode/*.json`
- 测试用例数据: `tests/data/mode_test_cases.json`
- Mock 数据: 使用 pytest fixtures

---

## 4. 测试执行计划

### 4.1 测试阶段

```mermaid
graph LR
    A[单元测试] --> B[集成测试]
    B --> C[E2E测试]
    C --> D[性能测试]
    D --> E[安全扫描]
    E --> F[人工测试]
```

### 4.2 测试时间表

| 阶段 | 开始时间 | 预计时长 | 负责人 |
|------|----------|---------|--------|
| 单元测试 | T+0h | 30min | [开发者] |
| 集成测试 | T+0.5h | 1h | [开发者] |
| E2E 测试 | T+1.5h | 1h | [测试工程师] |
| 性能测试 | T+2.5h | 30min | [测试工程师] |
| 安全扫描 | T+3h | 15min | [自动化] |
| 人工测试 | T+3.25h | 1h | [QA] |

---

## 5. 验收标准

### 5.1 功能验收

- [ ] 所有单元测试通过 (100%)
- [ ] 所有集成测试通过 (100%)
- [ ] 所有 E2E 测试通过 (100%)
- [ ] Bug 场景不再重现
- [ ] 边界条件都已处理

### 5.2 质量验收

- [ ] 代码覆盖率 > 80%
- [ ] 新增代码覆盖率 = 100%
- [ ] 无 Critical/High 安全漏洞
- [ ] 代码风格检查通过

### 5.3 性能验收

- [ ] 响应时间无退化 (< 基线 + 5%)
- [ ] 吞吐量无下降 (> 基线 - 5%)
- [ ] 内存使用无异常增长
- [ ] CPU 使用无异常增长

---

## 6. 风险和缓解

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| 测试不充分 | 中 | 高 | 增加测试用例覆盖 |
| 环境差异 | 低 | 中 | 在多环境测试 |
| 性能退化 | 低 | 中 | 性能基准测试 |

---

## 7. 测试报告

### 7.1 测试结果摘要

**执行日期**: [YYYY-MM-DD]
**测试人员**: [姓名]

| 测试类型 | 总数 | 通过 | 失败 | 跳过 | 通过率 |
|---------|------|------|------|------|--------|
| 单元测试 | [数量] | [数量] | [数量] | [数量] | [百分比] |
| 集成测试 | [数量] | [数量] | [数量] | [数量] | [百分比] |
| E2E 测试 | [数量] | [数量] | [数量] | [数量] | [百分比] |
| 性能测试 | [数量] | [数量] | [数量] | [数量] | [百分比] |

### 7.2 发现的问题

| 问题编号 | 描述 | 严重级别 | 状态 |
|---------|------|---------|------|
| [编号] | [描述] | [P0/P1/P2/P3] | [开放/已修复/延期] |

### 7.3 测试结论

**测试结果**: [✅ 通过 / ❌ 不通过]

**结论说明**:
[详细说明测试结果和建议]

---

**测试负责人签名**: [姓名]
**测试日期**: [YYYY-MM-DD]
```

---

## 5. 发布说明模板

```markdown
# Release Notes: v[版本号]

**发布日期**: [YYYY-MM-DD]
**发布类型**: [Patch / Minor / Major]
**发布原因**: [Bug修复 / 安全补丁 / 性能优化]

---

## 概述

[用 2-3 句话概述本次发布]

本次发布是 v[上一版本] 的 patch 版本，主要修复了 Mode 系统的一个 P1 级别 Bug。

---

## 修复的问题

### Bug 修复

#### #123 - Fix mode policy crash when rules is None

**严重级别**: P1 (High)

**问题描述**:
当 Mode policy 配置文件加载失败或 rules 字段为 null 时，
调用 `ModePolicy.evaluate()` 会导致 `AttributeError` 崩溃。

**影响范围**:
- 影响使用自定义 policy 配置的用户
- 影响约 30% 的用户

**修复内容**:
- 在 `evaluate()` 方法中添加了 None 检查
- 当 rules 为 None 时，采用 "deny-by-default" 策略
- 添加了警告日志提示用户检查配置

**修复文件**:
- `agentos/core/mode/mode_policy.py`

**测试**:
- 添加了回归测试 `test_evaluate_with_none_rules()`
- 所有现有测试通过
- 性能无退化

**向后兼容性**: ✅ 完全兼容

**相关 PR**: #[编号]

---

## 升级指南

### 从 v[上一版本] 升级

```bash
# 使用 pip 升级
pip install --upgrade agentos==[新版本]

# 或使用 conda
conda install agentos==[新版本]
```

**注意事项**:
- ✅ 无需修改代码
- ✅ 无需修改配置
- ✅ 完全向后兼容

### 验证升级

```bash
# 检查版本
python -c "import agentos; print(agentos.__version__)"

# 应输出: [新版本]
```

---

## 完整变更列表

### Fixed
- **mode-policy**: Fix crash when policy rules is None (#123)
  - Added None check in `ModePolicy.evaluate()`
  - Implemented deny-by-default strategy
  - Added warning log for configuration issues

### Changed
- None

### Added
- None

### Deprecated
- None

### Removed
- None

### Security
- None

---

## 已知问题

无新增已知问题。

---

## 后续计划

下一个版本 (v[下一版本]) 计划:
- [功能1]
- [功能2]

预计发布时间: [YYYY-MM-DD]

---

## 致谢

感谢以下贡献者:
- [@用户1] - 报告 Bug
- [@用户2] - 代码审查
- [@用户3] - 测试验证

---

## 联系方式

- **Bug 报告**: https://github.com/your-org/agentos/issues
- **技术支持**: support@company.com
- **文档**: https://docs.agentos.com

---

**发布负责人**: [姓名]
**发布日期**: [YYYY-MM-DD]
```

---

## 6. 回滚方案模板

```markdown
# 回滚方案: v[版本号]

**发布版本**: v[版本号]
**发布日期**: [YYYY-MM-DD]
**方案制定人**: [姓名]
**方案日期**: [YYYY-MM-DD]

---

## 1. 回滚触发条件

满足以下任一条件时，执行回滚:

- [ ] P0 Critical Bug 被引入
- [ ] 系统错误率 > 1%
- [ ] 响应时间 > 基线 + 50%
- [ ] 数据损坏或丢失
- [ ] 大量用户投诉 (> 10 个)
- [ ] 安全漏洞被发现

---

## 2. 回滚前检查

### 2.1 验证问题

- [ ] 确认问题与本次发布相关
- [ ] 确认问题严重性
- [ ] 确认无其他解决方案

### 2.2 通知相关人员

- [ ] 通知技术负责人
- [ ] 通知发布经理
- [ ] 通知 On-call 工程师
- [ ] (可选) 通知用户

---

## 3. 回滚步骤

### 3.1 准备阶段

```bash
# 1. 获取当前版本信息
CURRENT_VERSION=$(python -c "import agentos; print(agentos.__version__)")
echo "当前版本: $CURRENT_VERSION"

# 2. 确定目标版本 (上一个稳定版本)
TARGET_VERSION="[上一版本]"
echo "目标版本: $TARGET_VERSION"

# 3. 备份当前配置
cp -r ~/.agentos ~/.agentos.backup.$(date +%Y%m%d%H%M%S)
echo "配置已备份"
```

### 3.2 回滚代码

```bash
# 4. 回滚 Git 版本
git checkout v${TARGET_VERSION}

# 5. 重新构建
python setup.py build

# 6. 安装旧版本
pip install --force-reinstall agentos==${TARGET_VERSION}

# 7. 验证版本
python -c "import agentos; print(agentos.__version__)"
# 应输出: [上一版本]
```

### 3.3 回滚数据库 (如需要)

```bash
# 8. 备份当前数据库
cp agentos.db agentos.db.backup.$(date +%Y%m%d%H%M%S)

# 9. 如果数据库schema有变更，回滚 migration
# (根据实际情况调整)
# alembic downgrade -1

echo "数据库已回滚"
```

### 3.4 重启服务

```bash
# 10. 重启 AgentOS 服务
sudo systemctl restart agentos

# 11. 检查服务状态
sudo systemctl status agentos

# 12. 查看日志
tail -f /var/log/agentos/agentos.log
```

### 3.5 验证回滚

```bash
# 13. 冒烟测试
pytest tests/smoke/ -v

# 14. 健康检查
curl http://localhost:8000/api/health

# 15. 检查关键指标
# - 错误率
# - 响应时间
# - 系统可用性
```

---

## 4. 回滚后验证

### 4.1 功能验证

- [ ] 核心功能正常
- [ ] Mode 系统正常
- [ ] 任务可以创建和执行
- [ ] API 响应正常

### 4.2 性能验证

- [ ] 响应时间恢复正常
- [ ] 错误率下降
- [ ] 系统稳定性恢复

### 4.3 数据验证

- [ ] 无数据丢失
- [ ] 数据一致性正常
- [ ] 用户数据完整

---

## 5. 回滚后操作

### 5.1 通知

- [ ] 通知技术团队
- [ ] 通知用户 (如需要)
- [ ] 更新状态页面

### 5.2 事后分析

- [ ] 创建 Postmortem 文档
- [ ] 根因分析
- [ ] 制定预防措施
- [ ] 更新发布流程

### 5.3 重新发布计划

- [ ] 修复导致回滚的问题
- [ ] 增加测试覆盖
- [ ] 重新审查
- [ ] 安排新的发布

---

## 6. 回滚时间估计

| 阶段 | 预计时长 |
|------|---------|
| 准备 | 5 分钟 |
| 回滚代码 | 5 分钟 |
| 回滚数据库 | 10 分钟 |
| 重启服务 | 5 分钟 |
| 验证 | 15 分钟 |
| **总计** | **40 分钟** |

---

## 7. 应急联系

| 角色 | 姓名 | 联系方式 |
|------|------|---------|
| 技术负责人 | [姓名] | [电话/邮箱] |
| 发布经理 | [姓名] | [电话/邮箱] |
| On-call | [姓名] | [电话/邮箱] |
| DBA | [姓名] | [电话/邮箱] |

---

## 8. 回滚检查清单

**回滚执行人**: [姓名]
**执行日期**: [YYYY-MM-DD]

- [ ] 准备阶段完成
- [ ] 代码回滚完成
- [ ] 数据库回滚完成 (如需要)
- [ ] 服务重启完成
- [ ] 验证通过
- [ ] 通知已发送
- [ ] 事后分析已安排

**回滚结果**: [成功 / 失败]

**备注**:
[记录回滚过程中的任何问题或特殊情况]

---

**方案制定人签名**: [姓名]
**日期**: [YYYY-MM-DD]
```

---

## 7. 事后分析模板 (Postmortem)

```markdown
# Postmortem: [事件简短描述]

**事件编号**: INC-[YYYYMMDDHHMMSS]
**事件日期**: [YYYY-MM-DD]
**撰写人**: [姓名]
**撰写日期**: [YYYY-MM-DD]
**状态**: [草稿 / 审查中 / 已发布]

---

## 执行摘要

[用 2-3 段简要描述事件、影响和根本原因]

---

## 事件时间线

| 时间 | 事件 | 责任人 |
|------|------|--------|
| [HH:MM] | 发现问题 | [姓名] |
| [HH:MM] | 开始调查 | [姓名] |
| [HH:MM] | 识别根因 | [姓名] |
| [HH:MM] | 开始修复 | [姓名] |
| [HH:MM] | 修复部署 | [姓名] |
| [HH:MM] | 问题解决 | [姓名] |

**事件持续时间**: [X 小时 Y 分钟]

---

## 影响评估

### 用户影响
- **影响用户数**: [数量或百分比]
- **影响时长**: [X 小时 Y 分钟]
- **严重程度**: [Critical / High / Medium / Low]

### 业务影响
- **财务影响**: [估计金额]
- **SLA 影响**: [是否违反 SLA]
- **声誉影响**: [用户投诉数、媒体报道等]

### 技术影响
- **系统可用性**: [停机时间]
- **数据影响**: [数据丢失/损坏情况]
- **性能影响**: [性能退化程度]

---

## 根本原因分析

### 直接原因
[导致事件的直接技术原因]

### 根本原因
[使用 5 Whys 方法深入分析]

1. **为什么发生 X？** 因为 Y
2. **为什么 Y？** 因为 Z
3. **为什么 Z？** 因为 W
4. **为什么 W？** 因为 V
5. **为什么 V？** 因为根本原因

**根本原因**: [最终识别的根本原因]

### 促成因素
[其他促成事件发生或扩大的因素]

- [因素1]
- [因素2]
- [因素3]

---

## 解决方案

### 短期修复
[描述实施的短期修复措施]

### 长期改进
[描述计划的长期改进措施]

---

## 经验教训

### 做得好的地方
- [正面经验1]
- [正面经验2]

### 需要改进的地方
- [改进点1]
- [改进点2]

---

## 行动项

| 行动项 | 负责人 | 截止日期 | 优先级 | 状态 |
|--------|--------|---------|--------|------|
| [行动1] | [姓名] | [日期] | [P0-P3] | [待办/进行中/完成] |
| [行动2] | [姓名] | [日期] | [P0-P3] | [待办/进行中/完成] |

---

## 预防措施

[描述为防止类似事件再次发生而采取的措施]

1. **流程改进**: [描述]
2. **工具改进**: [描述]
3. **监控增强**: [描述]
4. **培训计划**: [描述]

---

## 附录

### 相关链接
- Issue: #[编号]
- PR: #[编号]
- 监控仪表板: [链接]
- 聊天记录: [链接]

### 参考文档
- [文档1]
- [文档2]

---

**审核者**: [姓名]
**审核日期**: [YYYY-MM-DD]
**状态**: ✅ 已批准
```

---

## 相关文档

- [MODE_BUG_FIX_PROCESS.md](../MODE_BUG_FIX_PROCESS.md) - Bug 修复流程
- [MODE_BUG_FIX_WORKFLOW.md](../MODE_BUG_FIX_WORKFLOW.md) - Bug 修复工作流程图
- [MODE_FREEZE_SPECIFICATION.md](../MODE_FREEZE_SPECIFICATION.md) - Mode 冻结规范

---

**文档状态**: ✅ Active
**最后更新**: 2026-01-30
**维护者**: Architecture Committee
