# Semantic Freeze - è¯­ä¹‰å†»ç»“å†³ç­–

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**å†»ç»“æ—¥æœŸ**: 2026-01-29
**ç”Ÿæ•ˆèŒƒå›´**: Phase 2 æ¢å¤ç³»ç»Ÿ
**å†³ç­–ç±»å‹**: æ¶æ„çº¦æŸ (Architectural Constraint)

---

## ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦è¯­ä¹‰å†»ç»“

Phase 2 æ¢å¤ç³»ç»Ÿç»è¿‡ä¸¥æ ¼éªŒè¯ï¼ˆ103/103 æµ‹è¯•é€šè¿‡ï¼‰ï¼Œå·²è¯æ˜æŠ€æœ¯å¯è¡Œæ€§å’Œç”Ÿäº§ç¨³å®šæ€§ã€‚ä¸ºäº†é˜²æ­¢ï¼š
- **è¯­ä¹‰æ¼‚ç§»**: æ ¸å¿ƒæ¦‚å¿µè¢«éšæ„ä¿®æ”¹
- **åŠŸèƒ½è •å˜**: è¿‡æ—©ä¼˜åŒ–å¯¼è‡´å¤æ‚åº¦å¤±æ§
- **å™äº‹æ··ä¹±**: å¯¹å¤–å®£ä¼ ä¸å®é™…èƒ½åŠ›ä¸ç¬¦

æˆ‘ä»¬å¯¹ä»¥ä¸‹ä¸‰ä¸ªæ–¹é¢è¿›è¡Œ**è¯­ä¹‰å†»ç»“**ã€‚

---

## ğŸ”’ å†»ç»“ 1ï¼šæ¢å¤ç³»ç»Ÿçš„æ ¸å¿ƒè¯­ä¹‰

### å†»ç»“çš„è¯­ä¹‰ç»„ä»¶

ä»¥ä¸‹ç»„ä»¶çš„**æ ¸å¿ƒè¯­ä¹‰å’Œæ¥å£**ç°åœ¨è¿›å…¥ Semantic Freeze çŠ¶æ€ï¼š

#### 1. Checkpoint ä¸¤é˜¶æ®µæäº¤

**å†»ç»“è¯­ä¹‰**:
```python
# Phase 1: å£°æ˜æ„å›¾
checkpoint_manager.begin_step(
    task_id="task-001",
    step_name="generate_plan",
    evidence=[...]  # é¢„æœŸäº§ç”Ÿçš„è¯æ®
)

# Phase 2: æäº¤ç»“æœ
checkpoint_manager.commit_step(
    task_id="task-001",
    step_name="generate_plan",
    snapshot_data={...},  # å®é™…äº§ç”Ÿçš„æ•°æ®
    success=True
)
```

**æ‰©å±•è§„åˆ™**:
- âœ… å…è®¸: æ–°å¢ evidence ç±»å‹
- âœ… å…è®¸: æ–°å¢ checkpoint_type
- âœ… å…è®¸: æ–°å¢å¯é€‰å‚æ•° (å¸¦é»˜è®¤å€¼)
- âŒ ç¦æ­¢: ä¿®æ”¹ begin_step / commit_step çš„è¯­ä¹‰
- âŒ ç¦æ­¢: ç§»é™¤ä¸¤é˜¶æ®µæäº¤æ¨¡å¼
- âŒ ç¦æ­¢: ç ´åå·²æœ‰ evidence ç±»å‹çš„éªŒè¯é€»è¾‘

---

#### 2. Evidence ç±»å‹ä¸éªŒè¯è¯­ä¹‰

**å†»ç»“çš„ 4 ç§è¯æ®ç±»å‹**:

| ç±»å‹ | è¯­ä¹‰ | payload å¿…éœ€å­—æ®µ | éªŒè¯æ–¹å¼ |
|------|------|------------------|----------|
| `artifact_exists` | æ–‡ä»¶å­˜åœ¨æ€§ | `path` | æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ |
| `file_sha256` | æ–‡ä»¶å†…å®¹å“ˆå¸Œ | `path`, `expected_hash` | è®¡ç®—å¹¶å¯¹æ¯” SHA256 |
| `command_exit` | å‘½ä»¤é€€å‡ºç  | `command`, `expected_exit_code` | æ£€æŸ¥é€€å‡ºç åŒ¹é… |
| `db_row` | æ•°æ®åº“è¡ŒçŠ¶æ€ | `table`, `where_clause`, `expected_count` | SQL æŸ¥è¯¢éªŒè¯ |

**æ‰©å±•è§„åˆ™**:
- âœ… å…è®¸: æ–°å¢ç¬¬ 5ã€6ã€7... ç§è¯æ®ç±»å‹ (å¦‚ `http_status`, `gpu_available`)
- âœ… å…è®¸: ä¸ºå·²æœ‰ç±»å‹æ–°å¢**å¯é€‰** payload å­—æ®µ
- âŒ ç¦æ­¢: ä¿®æ”¹å·²æœ‰ 4 ç§ç±»å‹çš„æ ¸å¿ƒéªŒè¯é€»è¾‘
- âŒ ç¦æ­¢: ç§»é™¤å·²æœ‰ payload å­—æ®µ
- âŒ ç¦æ­¢: æ”¹å˜ `verified` / `verified_at` çš„è¯­ä¹‰

---

#### 3. AtomicWrite + .ok Marker

**å†»ç»“çš„æ–‡ä»¶å†™å…¥è¯­ä¹‰**:
```python
atomic_write(file_path, content) â†’ metadata

# æ‰§è¡Œæµç¨‹ (ä¸å¯ä¿®æ”¹):
# 1. Write to .tmp
# 2. fsync()
# 3. Rename to target
# 4. Write .ok marker with {"sha256", "size", "timestamp"}
```

**å†»ç»“çš„éªŒè¯è¯­ä¹‰**:
```python
verify_atomic_write(file_path) â†’ bool

# éªŒè¯è§„åˆ™ (ä¸å¯ä¿®æ”¹):
# 1. .ok æ–‡ä»¶å¿…é¡»å­˜åœ¨
# 2. æ–‡ä»¶å“ˆå¸Œå¿…é¡»ä¸ .ok ä¸­çš„ä¸€è‡´
# 3. æ–‡ä»¶å¤§å°å¿…é¡»ä¸ .ok ä¸­çš„ä¸€è‡´
```

**æ‰©å±•è§„åˆ™**:
- âœ… å…è®¸: .ok æ–‡ä»¶ä¸­æ–°å¢å­—æ®µ (å¦‚ `writer_id`, `write_duration_ms`)
- âœ… å…è®¸: æ–°å¢ atomic_write çš„å¯é€‰å‚æ•° (å¦‚ `compression=True`)
- âŒ ç¦æ­¢: ç§»é™¤ .ok æ–‡ä»¶æœºåˆ¶
- âŒ ç¦æ­¢: æ”¹å˜ tmp â†’ rename â†’ .ok çš„é¡ºåº
- âŒ ç¦æ­¢: è·³è¿‡ fsync()

---

#### 4. Lease CAS + Heartbeat

**å†»ç»“çš„ç§Ÿçº¦è¯­ä¹‰**:
```sql
-- Atomic CAS (Compare-and-Swap)
UPDATE work_items
SET
  status = 'in_progress',
  lease_holder = ?,
  lease_expires_at = datetime('now', '+300 seconds')
WHERE work_item_id = ?
  AND (status = 'pending' OR
       (status = 'in_progress' AND lease_expires_at < datetime('now')))
```

**å†»ç»“çš„å¿ƒè·³è¯­ä¹‰**:
```python
# å®šæœŸç»­çº¦ (é»˜è®¤ 30 ç§’)
heartbeat_thread.renew_lease(work_item_id)
# â†’ UPDATE lease_expires_at, heartbeat_at
```

**æ‰©å±•è§„åˆ™**:
- âœ… å…è®¸: åŠ¨æ€ç§Ÿçº¦æ—¶é•¿ (åŸºäºå†å²æ‰§è¡Œæ—¶é—´)
- âœ… å…è®¸: å¿ƒè·³é—´éš”å¯é…ç½®
- âœ… å…è®¸: æ–°å¢ work_item çŠ¶æ€ (å¦‚ `paused`, `cancelled`)
- âŒ ç¦æ­¢: ç§»é™¤ CAS çš„åŸå­æ€§ä¿è¯
- âŒ ç¦æ­¢: å…è®¸å¤šä¸ª worker åŒæ—¶æŒæœ‰åŒä¸€ç§Ÿçº¦
- âŒ ç¦æ­¢: ç§»é™¤ lease_expires_at è¶…æ—¶æœºåˆ¶

---

#### 5. "ç‹¬ç«‹ DB per Process" æ¶æ„

**å†»ç»“çš„å¤šè¿›ç¨‹ç­–ç•¥**:
```python
# Chaos æµ‹è¯•æˆ–å¤šè¿›ç¨‹åœºæ™¯
def worker_process(worker_id: int, tmpdir: str):
    # æ¯ä¸ªè¿›ç¨‹ä½¿ç”¨ç‹¬ç«‹çš„ SQLite æ•°æ®åº“
    db_path = Path(tmpdir) / f"worker_{worker_id}.db"
    init_connection_factory(str(db_path))
    # ... æ‰§è¡Œå·¥ä½œ ...
```

**ä¸ºä»€ä¹ˆå†»ç»“è¿™ä¸ªé€‰æ‹©**:
- SQLite çš„ WAL æ¨¡å¼åœ¨å¤šè¿›ç¨‹å†™å…¥æ—¶ä»æœ‰ç«äº‰
- ç‹¬ç«‹ DB ç­–ç•¥é¿å…äº† `database is locked` é”™è¯¯
- æ¢å¤æ—¶å¯ä»¥åˆå¹¶å¤šä¸ª DB çš„ç»“æœ

**æ‰©å±•è§„åˆ™**:
- âœ… å…è®¸: Phase 3 è¿ç§»åˆ° PostgreSQL (æ”¯æŒçœŸæ­£çš„å¤šè¿›ç¨‹å¹¶å‘)
- âœ… å…è®¸: è¿›ç¨‹é—´é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—åè°ƒ (RabbitMQ, Redis)
- âœ… å…è®¸: ä¸»è¿›ç¨‹æ±‡æ€»å­è¿›ç¨‹çš„ DB ç»“æœ
- âŒ ç¦æ­¢: åœ¨ SQLite ä¸Šå¼ºè¡Œå®ç°å¤šè¿›ç¨‹å…±äº«å†™å…¥
- âŒ ç¦æ­¢: ç§»é™¤è¿›ç¨‹éš”ç¦»ä¿æŠ¤

---

### å¦‚ä½•æ‰©å±•å†»ç»“çš„è¯­ä¹‰

**æ­£ç¡®çš„æ‰©å±•æ–¹å¼** (âœ…):
1. **æ–°å¢ Evidence ç±»å‹**:
   ```python
   # æ–°å¢ä¸€ä¸ª http_status è¯æ®ç±»å‹
   class EvidenceVerifier:
       def verify_http_status(self, evidence: Evidence) -> Evidence:
           url = evidence.payload["url"]
           expected_status = evidence.payload["expected_status"]
           # ... éªŒè¯é€»è¾‘ ...
   ```

2. **ä¸º AtomicWrite æ–°å¢å¯é€‰åŠŸèƒ½**:
   ```python
   # æ–°å¢å‹ç¼©åŠŸèƒ½,ä¸ç ´åç°æœ‰è¯­ä¹‰
   def atomic_write(file_path, content, compress=False):
       if compress:
           content = gzip.compress(content.encode())
       # ... åŸæœ‰çš„ tmp â†’ fsync â†’ rename â†’ .ok æµç¨‹ä¿æŒä¸å˜ ...
   ```

3. **æ–°å¢ Checkpoint ç±»å‹**:
   ```python
   # æ–°å¢ "partial_checkpoint" ç±»å‹
   checkpoint_manager.begin_step(
       task_id="task-001",
       step_name="incremental_update",
       checkpoint_type="partial_checkpoint",  # æ–°ç±»å‹
       evidence=[...]
   )
   ```

**é”™è¯¯çš„æ‰©å±•æ–¹å¼** (âŒ):
1. ~~å°†ä¸¤é˜¶æ®µæäº¤æ”¹ä¸ºä¸€é˜¶æ®µ~~ â†’ ç ´åæ ¸å¿ƒè¯­ä¹‰
2. ~~ç§»é™¤ Evidence éªŒè¯,åªè®°å½• checkpoint~~ â†’ ä¸§å¤±å¯éªŒè¯æ€§
3. ~~è·³è¿‡ .ok æ–‡ä»¶,ç›´æ¥å†™ç›®æ ‡æ–‡ä»¶~~ â†’ æ— æ³•åˆ¤æ–­å†™å…¥å®Œæ•´æ€§
4. ~~å…è®¸å¤šä¸ª worker åŒæ—¶æŒæœ‰ç§Ÿçº¦~~ â†’ ç ´åäº’æ–¥ä¿è¯
5. ~~SQLite ä¸Šå®ç°å¤šè¿›ç¨‹å…±äº«å†™å…¥~~ â†’ å¼•å…¥å¹¶å‘ bug

---

## ğŸ”’ å†»ç»“ 2ï¼šå¯¹å¤–å™äº‹ - "å››å¯"å®šä½

### æ—§å™äº‹ (âŒ åœæ­¢ä½¿ç”¨)

> "AgentOS æ˜¯ä¸€ä¸ª AI è‡ªä¸»æ‰§è¡Œç³»ç»Ÿ,æ”¯æŒå…¨è‡ªåŠ¨åŒ–çš„å¤š agent ååŒ,æ— éœ€äººå·¥å¹²é¢„ã€‚"

**é—®é¢˜**:
- "è‡ªä¸»æ‰§è¡Œ" å’Œ "å…¨è‡ªåŠ¨" æ˜¯**ç©ºæ³›æ‰¿è¯º**,æ— æ³•éªŒè¯
- å¼ºè°ƒ"æ— éœ€äººå·¥å¹²é¢„"ä¼šè®©ç”¨æˆ·æ‹…å¿ƒå¤±æ§
- æ²¡æœ‰çªå‡º AgentOS çš„**æ ¸å¿ƒå·®å¼‚åŒ–èƒ½åŠ›**

---

### æ–°å™äº‹ (âœ… å¼ºåˆ¶ä½¿ç”¨)

> **AgentOS æ˜¯ä¸€ä¸ªå¯ä¸­æ–­ã€å¯æ¢å¤ã€å¯éªŒè¯ã€å¯å®¡è®¡çš„ AI æ‰§è¡Œç³»ç»Ÿã€‚**

#### "å››å¯" çš„æŠ€æœ¯æ”¯æ’‘

| å™äº‹ | æŠ€æœ¯å®ç° | éªŒè¯æ–¹å¼ |
|------|----------|----------|
| **å¯ä¸­æ–­** | Checkpoint ä¸¤é˜¶æ®µæäº¤ | kill -9 ä¸ä¸¢æ•°æ® (Chaos Scenario 1-7) |
| **å¯æ¢å¤** | Evidence-based æ¢å¤ | ä»æœ€åéªŒè¯çš„ checkpoint ç»§ç»­ |
| **å¯éªŒè¯** | 4 ç§ Evidence ç±»å‹ | æ¯ä¸ª checkpoint éƒ½æœ‰è¯æ®é“¾ |
| **å¯å®¡è®¡** | å®Œæ•´æ“ä½œæ—¥å¿— | æ‰€æœ‰ work_items / checkpoints å¯è¿½æº¯ |

#### å¯¹å¤–å®£ä¼ çš„æ ‡å‡†è¯æœ¯

**30 ç§’ç”µæ¢¯æ¼”è®²**:
> "AgentOS ä¸ä»…è®© AI è‡ªåŠ¨æ‰§è¡Œä»»åŠ¡,æ›´é‡è¦çš„æ˜¯,å®ƒè®© AI çš„æ‰§è¡Œè¿‡ç¨‹**å¯ä¸­æ–­ã€å¯æ¢å¤ã€å¯éªŒè¯ã€å¯å®¡è®¡**ã€‚å³ä½¿ç³»ç»Ÿå´©æºƒ (kill -9),ä¹Ÿèƒ½ä»ä¸Šæ¬¡éªŒè¯çš„æ£€æŸ¥ç‚¹æ¢å¤,ä¸ä¼šé‡è·‘å·²å®Œæˆçš„å·¥ä½œ,ä¹Ÿä¸ä¼šä¸¢å¤±è¿›åº¦ã€‚æ¯ä¸ªæ‰§è¡Œæ­¥éª¤éƒ½æœ‰è¯æ®é“¾,å¯ä»¥è¿½æº¯å’Œå®¡è®¡ã€‚"

**æŠ€æœ¯åšå®¢æ ‡é¢˜æ¨¡æ¿**:
- âŒ "å¦‚ä½•æ„å»ºå…¨è‡ªåŠ¨ AI Agent ç³»ç»Ÿ"
- âœ… "å¦‚ä½•è®© AI æ‰§è¡Œå¯æ¢å¤: åŸºäº Evidence çš„ Checkpoint è®¾è®¡"
- âœ… "Kill -9 ä¸æ€•: æ„å»ºå¯ä¸­æ–­çš„ AI æ‰§è¡Œç³»ç»Ÿ"
- âœ… "ä» Token æµªè´¹åˆ°æˆæœ¬ä¼˜åŒ–: LLM Cache çš„å¹‚ç­‰æ€§è®¾è®¡"

**å¯¹å¤–æ–‡æ¡£çš„ç¬¬ä¸€æ®µ** (å†»ç»“æ¨¡æ¿):
```markdown
AgentOS æ˜¯ä¸€ä¸ª**å¯ä¸­æ–­ã€å¯æ¢å¤ã€å¯éªŒè¯ã€å¯å®¡è®¡**çš„ AI æ‰§è¡Œç³»ç»Ÿã€‚

ä¸ä¼ ç»Ÿçš„"å…¨è‡ªåŠ¨ AI Agent"ä¸åŒ,AgentOS å¼ºè°ƒ**æ‰§è¡Œè¿‡ç¨‹çš„å¯æ§æ€§**:
- å¯ä¸­æ–­: ç³»ç»Ÿå´©æºƒ (kill -9) ä¸ä¸¢æ•°æ®
- å¯æ¢å¤: ä»æœ€åéªŒè¯çš„æ£€æŸ¥ç‚¹ç»§ç»­,ä¸é‡è·‘
- å¯éªŒè¯: æ¯ä¸ªæ­¥éª¤éƒ½æœ‰è¯æ®é“¾ (æ–‡ä»¶å“ˆå¸Œã€å‘½ä»¤é€€å‡ºç ã€æ•°æ®åº“çŠ¶æ€)
- å¯å®¡è®¡: æ‰€æœ‰æ“ä½œå¯è¿½æº¯,ç¬¦åˆä¼ä¸šçº§å®¡è®¡è¦æ±‚

è¿™è®© AgentOS ç‰¹åˆ«é€‚åˆéœ€è¦**é•¿æ—¶é—´è¿è¡Œã€é«˜å¯é æ€§ã€å¯è¿½æº¯**çš„ AI ä»»åŠ¡åœºæ™¯ã€‚
```

---

### ä¸ºä»€ä¹ˆè¦å†»ç»“å™äº‹

**åŸå›  1: å™äº‹å³æ‰¿è¯º**
- è¯´"å…¨è‡ªåŠ¨"å°±æ˜¯æ‰¿è¯ºæ°¸è¿œä¸ä¼šå¡ä½ â†’ åšä¸åˆ°
- è¯´"å¯æ¢å¤"å°±æ˜¯æ‰¿è¯ºå´©æºƒåèƒ½ç»§ç»­ â†’ èƒ½éªŒè¯ (Chaos æµ‹è¯•)

**åŸå›  2: å·®å¼‚åŒ–å®šä½**
- å¸‚åœºä¸Š"AI Agent è‡ªåŠ¨åŒ–"äº§å“å¾ˆå¤š
- ä½†å¼ºè°ƒ"å¯ä¸­æ–­ã€å¯æ¢å¤ã€å¯éªŒè¯ã€å¯å®¡è®¡"çš„å¾ˆå°‘
- è¿™æ˜¯ AgentOS çš„**çœŸæ­£æŠ¤åŸæ²³**

**åŸå›  3: é¿å…è¿‡åº¦æ‰¿è¯º**
- "å…¨è‡ªåŠ¨"ä¼šè®©äººæœŸæœ› 100% æˆåŠŸç‡ â†’ ä¸ç°å®
- "å¯æ¢å¤"åªæ‰¿è¯ºå´©æºƒåèƒ½ç»§ç»­ â†’ å¯å®ç°

---

## ğŸ”’ å†»ç»“ 3ï¼šæš‚åœå¹¶è¡ŒåŒ– work_items

### å†³ç­–: åœ¨ Phase 3 ä¹‹å‰,ä¸å®ç°å¹¶è¡Œ work_items

**å½“å‰çŠ¶æ€**:
- work_items æŒ‰é¡ºåºæ‰§è¡Œ (ä¸²è¡Œ)
- ä¸€æ¬¡åªæœ‰ä¸€ä¸ª work_item è¢«ç§Ÿçº¦æŒæœ‰
- æ‰§è¡Œé¡ºåºå®Œå…¨å¯é¢„æµ‹

**è¯±æƒ‘** (âŒ ç°åœ¨ä¸åš):
```python
# è¯±æƒ‘: åŒæ—¶æ‰§è¡Œå¤šä¸ª work_items
lease1 = manager.acquire_lease()  # work-item-1
lease2 = manager.acquire_lease()  # work-item-2
lease3 = manager.acquire_lease()  # work-item-3

# å¹¶è¡Œæ‰§è¡Œ
with ThreadPoolExecutor(max_workers=3) as executor:
    executor.map(execute_work_item, [lease1, lease2, lease3])
```

---

### ä¸ºä»€ä¹ˆç°åœ¨ä¸åšå¹¶è¡ŒåŒ–

#### åŸå›  1: å½“å‰çš„ä¸²è¡Œæ‰§è¡Œæ˜¯**ä¼˜åŠ¿**,ä¸æ˜¯åŠ£åŠ¿

| èƒ½åŠ› | ä¸²è¡Œæ‰§è¡Œ | å¹¶è¡Œæ‰§è¡Œ |
|------|----------|----------|
| **è¡Œä¸ºå¯è§£é‡Š** | âœ… é¡ºåºç¡®å®š | âŒ äº¤é”™æ‰§è¡Œ,éš¾è¿½è¸ª |
| **å¤±è´¥å¯å®šä½** | âœ… å•ç‚¹å¤±è´¥ | âŒ ç«äº‰æ¡ä»¶,éš¾å¤ç° |
| **æ¢å¤å¯éªŒè¯** | âœ… çº¿æ€§æ¢å¤ | âŒ éƒ¨åˆ†æˆåŠŸ,éœ€åˆå¹¶ |
| **Chaos æµ‹è¯•** | âœ… 7/7 é€šè¿‡ | âŒ éœ€é‡æ–°è®¾è®¡ |
| **è°ƒè¯•ä½“éªŒ** | âœ… æ—¥å¿—çº¿æ€§ | âŒ æ—¥å¿—äº¤é”™ |

**ç»“è®º**: åœ¨ä¼ä¸šçº§ AI æ‰§è¡Œåœºæ™¯,"å¯è§£é‡Š + å¯è¿½æº¯" æ¯” "é€Ÿåº¦å¿«" æ›´é‡è¦ã€‚

---

#### åŸå›  2: å¹¶è¡ŒåŒ–ä¼šå¼•å…¥æ–°çš„å¤æ‚åº¦

**æ–°å¢çš„é—®é¢˜**:
1. **ç«äº‰æ¡ä»¶**:
   - ä¸¤ä¸ª work_items åŒæ—¶å†™åŒä¸€ä¸ªæ–‡ä»¶
   - ä¸¤ä¸ª work_items åŒæ—¶ä¿®æ”¹æ•°æ®åº“åŒä¸€è¡Œ

2. **æ­»é”é£é™©**:
   - Work Item A ç­‰å¾… Work Item B çš„ç»“æœ
   - Work Item B ç­‰å¾… Work Item A çš„èµ„æº

3. **éƒ¨åˆ†å¤±è´¥**:
   - 3 ä¸ªå¹¶è¡Œ work_items,1 ä¸ªå¤±è´¥ 2 ä¸ªæˆåŠŸ
   - å¦‚ä½•å›æ»š? å¦‚ä½•æ¢å¤?

4. **è¯æ®éªŒè¯å¤æ‚åŒ–**:
   - æ–‡ä»¶ hash åœ¨å“ªä¸ªæ—¶é—´ç‚¹è®¡ç®—? (å¹¶è¡Œå†™å…¥ä¸­)
   - æ•°æ®åº“è¡ŒçŠ¶æ€å¦‚ä½•éªŒè¯? (å¹¶å‘ä¿®æ”¹ä¸­)

5. **Chaos æµ‹è¯•å¤±æ•ˆ**:
   - å½“å‰ 7 ä¸ª Chaos åœºæ™¯éƒ½å‡è®¾ä¸²è¡Œæ‰§è¡Œ
   - å¹¶è¡ŒåŒ–åéœ€è¦è®¾è®¡ **C(n,2) + C(n,3) + ...** ç§ç»„åˆåœºæ™¯

**ä¼°ç®—çš„å·¥ä½œé‡**:
- æ–°å¢å¹¶å‘æ§åˆ¶æœºåˆ¶: 2-3 å‘¨
- é‡æ–°è®¾è®¡ Evidence éªŒè¯: 1-2 å‘¨
- é‡æ–°è®¾è®¡ Chaos Matrix: 2 å‘¨
- **æ€»è®¡: 5-7 å‘¨**

---

#### åŸå›  3: å¹¶è¡ŒåŒ–åº”è¯¥åœ¨ Phase 3 (åˆ†å¸ƒå¼) ä¸€èµ·åš

**Phase 3 çš„æ­£ç¡®æ—¶æœº**:
```
Phase 3: åˆ†å¸ƒå¼ Worker Pool
â”œâ”€â”€ å¤šå°æœºå™¨å¹¶è¡Œæ‰§è¡Œ
â”œâ”€â”€ ä¸­å¿ƒåŒ– Coordinator (å¦‚ Redis, etcd)
â”œâ”€â”€ å…¨å±€ç§Ÿçº¦ç®¡ç† (è·¨æœºå™¨)
â”œâ”€â”€ åˆ†å¸ƒå¼ Checkpoint å­˜å‚¨ (PostgreSQL)
â””â”€â”€ é‡æ–°è®¾è®¡ Chaos Matrix (ç½‘ç»œåˆ†åŒºã€æ—¶é’Ÿåç§»)
```

**ä¸ºä»€ä¹ˆè¦ç­‰åˆ° Phase 3**:
- å¹¶è¡ŒåŒ–åœ¨**å•æœº**å’Œ**åˆ†å¸ƒå¼**çš„è®¾è®¡å®Œå…¨ä¸åŒ
- å•æœºå¹¶è¡Œç”¨ ThreadPoolExecutor,åˆ†å¸ƒå¼ç”¨ Celery/RabbitMQ
- å•æœºçš„å¹¶è¡ŒåŒ–è®¾è®¡ä¼šæˆä¸ºåˆ†å¸ƒå¼çš„**æŠ€æœ¯å€º**
- ä¸å¦‚ç›´æ¥è·³åˆ°åˆ†å¸ƒå¼,ä¸€æ¬¡æ€§è§£å†³å¹¶è¡Œ+å®¹é”™

---

### å¦‚ä½•æŠµåˆ¶å¹¶è¡ŒåŒ–çš„è¯±æƒ‘

**é”™è¯¯çš„è®ºæ®** (âŒ):
- "ç”¨æˆ·åé¦ˆä»»åŠ¡æ‰§è¡Œå¤ªæ…¢,éœ€è¦å¹¶è¡ŒåŠ é€Ÿ"
  â†’ åé©³: å…ˆåšæ€§èƒ½åˆ†æ,ç“¶é¢ˆå¯èƒ½æ˜¯ LLM API,ä¸æ˜¯ä¸²è¡Œæ‰§è¡Œ

- "ç«äº‰å¯¹æ‰‹éƒ½æ”¯æŒå¹¶è¡Œæ‰§è¡Œ"
  â†’ åé©³: æˆ‘ä»¬çš„ä¼˜åŠ¿æ˜¯**å¯è§£é‡Š+å¯å®¡è®¡**,ä¸æ˜¯é€Ÿåº¦

- "å¹¶è¡ŒåŒ–åªæ˜¯åŠ ä¸ª ThreadPoolExecutor,å¾ˆç®€å•"
  â†’ åé©³: ç«äº‰æ¡ä»¶ã€æ­»é”ã€éƒ¨åˆ†å¤±è´¥éƒ½æ˜¯å¤æ‚é—®é¢˜

**æ­£ç¡®çš„å›åº”** (âœ…):
- "æˆ‘ä»¬åœ¨ Phase 3 ä¼šæ”¯æŒ**åˆ†å¸ƒå¼å¹¶è¡Œ**,ä¼šæ¯”å•æœºå¹¶è¡Œæ›´å¼ºå¤§"
- "å½“å‰çš„ä¸²è¡Œæ‰§è¡Œä¿è¯äº†**100% å¯è¿½æº¯**,è¿™æ˜¯æˆ‘ä»¬çš„æŠ¤åŸæ²³"
- "å¦‚æœç”¨æˆ·éœ€è¦åŠ é€Ÿ,å¯ä»¥ç”¨ LLM Cache (81% æˆæœ¬èŠ‚çœ) å’Œ Tool Replay (98% é‡æ”¾ç‡)"

---

### ä½•æ—¶å¯ä»¥è§£é™¤å†»ç»“

**è§£é™¤å†»ç»“çš„å‰ç½®æ¡ä»¶**:
1. âœ… Phase 3 åˆ†å¸ƒå¼æ¶æ„è®¾è®¡å®Œæˆ
2. âœ… é€‰æ‹©äº†ä¸­å¿ƒåŒ– Coordinator (Redis / etcd / PostgreSQL)
3. âœ… è®¾è®¡äº†å…¨å±€ç§Ÿçº¦ç®¡ç†åè®®
4. âœ… é‡æ–°è®¾è®¡ Chaos Matrix (åŒ…å«å¹¶å‘åœºæ™¯)
5. âœ… å®ç°äº†åˆ†å¸ƒå¼ Checkpoint å­˜å‚¨
6. âœ… é€šè¿‡äº†æ–°çš„ Chaos æµ‹è¯• (20+ åœºæ™¯)

**è§£é™¤å†»ç»“çš„å®¡æ‰¹æµç¨‹**:
1. æäº¤ ADR (Architecture Decision Record)
2. è¯´æ˜ä¸ºä»€ä¹ˆéœ€è¦å¹¶è¡ŒåŒ– (ä¸šåŠ¡é©±åŠ¨,ä¸æ˜¯æŠ€æœ¯é©±åŠ¨)
3. è¯„ä¼°å¹¶è¡ŒåŒ–çš„é£é™©å’Œæˆæœ¬
4. å›¢é˜Ÿå®¡æŸ¥é€šè¿‡åæ‰èƒ½å®æ–½

---

## ğŸ“‹ å†»ç»“å†³ç­–çš„ç”Ÿæ•ˆæœºåˆ¶

### 1. ä»£ç å®¡æŸ¥å¼ºåˆ¶æ£€æŸ¥

**PR Review Checklist** (æ–°å¢):
```markdown
- [ ] æ˜¯å¦ä¿®æ”¹äº† Checkpoint ä¸¤é˜¶æ®µæäº¤çš„è¯­ä¹‰?
- [ ] æ˜¯å¦ä¿®æ”¹äº† 4 ç§ Evidence ç±»å‹çš„éªŒè¯é€»è¾‘?
- [ ] æ˜¯å¦ç§»é™¤äº† .ok marker æœºåˆ¶?
- [ ] æ˜¯å¦å…è®¸å¤šä¸ª worker åŒæ—¶æŒæœ‰ç§Ÿçº¦?
- [ ] æ˜¯å¦åœ¨ SQLite ä¸Šå®ç°å¤šè¿›ç¨‹å…±äº«å†™å…¥?
- [ ] æ˜¯å¦å®ç°äº† work_items å¹¶è¡ŒåŒ–?

**å¦‚æœä»¥ä¸Šä»»ä½•ä¸€é¡¹ä¸º "æ˜¯",åˆ™éœ€è¦**:
1. æäº¤ ADR è¯´æ˜ç†ç”±
2. æ›´æ–° SEMANTIC_FREEZE.md
3. å›¢é˜Ÿå®¡æŸ¥é€šè¿‡
```

---

### 2. æ–‡æ¡£æ›´æ–°è§„åˆ™

**å¯¹å¤–æ–‡æ¡£çš„ç¬¬ä¸€æ®µå¿…é¡»åŒ…å«**:
> "AgentOS æ˜¯ä¸€ä¸ª**å¯ä¸­æ–­ã€å¯æ¢å¤ã€å¯éªŒè¯ã€å¯å®¡è®¡**çš„ AI æ‰§è¡Œç³»ç»Ÿã€‚"

**ç¦æ­¢ä½¿ç”¨çš„è¯´æ³•**:
- âŒ "å…¨è‡ªåŠ¨ AI Agent"
- âŒ "æ— éœ€äººå·¥å¹²é¢„"
- âŒ "100% è‡ªä¸»æ‰§è¡Œ"
- âŒ "å®Œå…¨è‡ªåŠ¨åŒ–"

**æ¨èä½¿ç”¨çš„è¯´æ³•**:
- âœ… "å¯ä¸­æ–­çš„ AI æ‰§è¡Œ"
- âœ… "å¯æ¢å¤çš„ä»»åŠ¡ç³»ç»Ÿ"
- âœ… "è¯æ®å‹æ£€æŸ¥ç‚¹"
- âœ… "å¯è¿½æº¯çš„æ‰§è¡Œå†å²"

---

### 3. ä¸ ADR ä½“ç³»çš„å…³è”

æœ¬ Semantic Freeze å†³ç­–åº”å…³è”åˆ°ä»¥ä¸‹ ADR:

| ADR | å…³è”çš„å†»ç»“å†³ç­– |
|-----|---------------|
| ADR-004 (Database Write Serialization) | å†»ç»“ 1: ç‹¬ç«‹ DB per process |
| ADR-007 (Checkpoint Two-Phase Commit) | å†»ç»“ 1: Checkpoint è¯­ä¹‰ |
| å¾…åˆ›å»º: ADR-008 (Evidence Types) | å†»ç»“ 1: Evidence è¯­ä¹‰ |
| å¾…åˆ›å»º: ADR-009 (Narrative Positioning) | å†»ç»“ 2: å››å¯å®šä½ |
| å¾…åˆ›å»º: ADR-010 (No Premature Parallelization) | å†»ç»“ 3: æš‚åœå¹¶è¡ŒåŒ– |

**åˆ›å»º ADR çš„è§¦å‘æ¡ä»¶**:
- ä»»ä½•æƒ³è¦ä¿®æ”¹å†»ç»“è¯­ä¹‰çš„ PR
- ä»»ä½•æƒ³è¦å®ç°å¹¶è¡ŒåŒ–çš„ææ¡ˆ
- ä»»ä½•æƒ³è¦æ”¹å˜å¯¹å¤–å™äº‹çš„æ–‡æ¡£æ›´æ–°

---

## ğŸ” åˆè§„æ€§æ£€æŸ¥

### è‡ªåŠ¨åŒ–æ£€æŸ¥ (CI/CD)

**æ–°å¢ CI æ£€æŸ¥é¡¹**:
```bash
# 1. æ£€æŸ¥æ˜¯å¦ä¿®æ”¹äº†æ ¸å¿ƒè¯­ä¹‰
./scripts/check_semantic_freeze.sh

# 2. æ£€æŸ¥æ–‡æ¡£æ˜¯å¦ä½¿ç”¨äº†ç¦æ­¢çš„è¯´æ³•
grep -r "å…¨è‡ªåŠ¨" docs/ && exit 1
grep -r "æ— éœ€äººå·¥å¹²é¢„" docs/ && exit 1

# 3. æ£€æŸ¥æ˜¯å¦å®ç°äº†å¹¶è¡ŒåŒ–
grep -r "ThreadPoolExecutor.*work_item" agentos/ && exit 1
grep -r "ProcessPoolExecutor.*work_item" agentos/ && exit 1
```

---

### äººå·¥å®¡æŸ¥æ¸…å•

**æ¯ä¸ª PR å¿…é¡»å›ç­”**:
1. æ˜¯å¦ä¿®æ”¹äº† Checkpoint / Evidence / AtomicWrite / Lease çš„æ ¸å¿ƒè¯­ä¹‰?
2. æ˜¯å¦åœ¨å¯¹å¤–æ–‡æ¡£ä¸­ä½¿ç”¨äº†"å…¨è‡ªåŠ¨"ç­‰ç¦æ­¢è¯´æ³•?
3. æ˜¯å¦å®ç°äº† work_items å¹¶è¡Œæ‰§è¡Œ?

**å¦‚æœä»»ä½•ä¸€é¡¹ä¸º "æ˜¯"**:
â†’ å¿…é¡»æäº¤ ADR å¹¶ç­‰å¾…å›¢é˜Ÿå®¡æŸ¥

---

## ğŸ“… å®šæœŸå®¡æŸ¥

**æ¯å­£åº¦å®¡æŸ¥ä¸€æ¬¡**:
- è¯„ä¼°å†»ç»“å†³ç­–æ˜¯å¦ä»ç„¶æœ‰æ•ˆ
- æ˜¯å¦æœ‰æ–°çš„ä¸šåŠ¡éœ€æ±‚éœ€è¦è§£é™¤å†»ç»“
- æ˜¯å¦éœ€è¦æ–°å¢å†»ç»“é¡¹

**å®¡æŸ¥è¾“å‡º**:
- æ›´æ–° SEMANTIC_FREEZE.md
- å‘å¸ƒ Release Notes è¯´æ˜ä»»ä½•å˜æ›´

---

## ğŸ“ æ•™è‚²å’Œä¼ æ’­

### æ–°æˆå‘˜ Onboarding

**å¿…è¯»æ–‡æ¡£**:
1. README.md (åŒ…å«å››å¯å®šä½)
2. SEMANTIC_FREEZE.md (æœ¬æ–‡æ¡£)
3. ADR-004, ADR-007 (æ ¸å¿ƒæ¶æ„å†³ç­–)
4. CHAOS_MATRIX.md (éªŒè¯æ–¹å¼)

**åŸ¹è®­è¦ç‚¹**:
- ä¸ºä»€ä¹ˆè¦å†»ç»“è¯­ä¹‰
- å¦‚ä½•æ­£ç¡®æ‰©å±•å†»ç»“çš„ç»„ä»¶
- å¦‚ä½•ä½¿ç”¨"å››å¯"å™äº‹å¯¹å¤–å®£ä¼ 

---

### å¯¹å¤–å®£ä¼ ç»Ÿä¸€å£å¾„

**åšå®¢ã€æ¼”è®²ã€å®£ä¼ ææ–™å¿…é¡»å¼ºè°ƒ**:
1. "å¯ä¸­æ–­ã€å¯æ¢å¤ã€å¯éªŒè¯ã€å¯å®¡è®¡" (å››å¯)
2. Checkpoint ä¸¤é˜¶æ®µæäº¤çš„åˆ›æ–°æ€§
3. Evidence-based æ¢å¤çš„å¯é æ€§
4. Chaos æµ‹è¯•éªŒè¯çš„ä¸¥æ ¼æ€§

**ç¦æ­¢å®£ä¼ **:
- "å…¨è‡ªåŠ¨åŒ–"
- "æ— éœ€äººå·¥å¹²é¢„"
- "100% æˆåŠŸç‡"

---

## âœ… æ€»ç»“

### Semantic Freeze ä¸‰åŸåˆ™

1. **æ ¸å¿ƒè¯­ä¹‰ä¸å¯æ›¿æ¢,åªèƒ½æ‰©å±•**
   - Checkpoint, Evidence, AtomicWrite, Lease çš„è¯­ä¹‰å·²å†»ç»“
   - æœªæ¥æ”¹è¿›å¿…é¡»å‘åå…¼å®¹

2. **å™äº‹å®šä½ = æŠ€æœ¯èƒ½åŠ›**
   - "å››å¯" (å¯ä¸­æ–­ã€å¯æ¢å¤ã€å¯éªŒè¯ã€å¯å®¡è®¡) æ˜¯å¯¹å¤–å”¯ä¸€å™äº‹
   - ç¦æ­¢ä½¿ç”¨"å…¨è‡ªåŠ¨"ç­‰ç©ºæ³›æ‰¿è¯º

3. **å½“å‰ä¼˜åŠ¿ > æœªæ¥ä¼˜åŒ–**
   - ä¸²è¡Œæ‰§è¡Œæ˜¯ä¼˜åŠ¿ (å¯è§£é‡Šã€å¯è¿½æº¯)
   - å¹¶è¡ŒåŒ–å¿…é¡»ç­‰åˆ° Phase 3 åˆ†å¸ƒå¼

---

### å¦‚ä½•åº”å¯¹æŒ‘æˆ˜

**æŒ‘æˆ˜ 1**: "ç”¨æˆ·è¦æ±‚æ›´å¿«çš„æ‰§è¡Œé€Ÿåº¦"
- **å›åº”**: ç”¨ LLM Cache (81% æˆæœ¬èŠ‚çœ) å’Œ Tool Replay (98% é‡æ”¾ç‡) ä¼˜åŒ–,ä¸æ˜¯å¹¶è¡ŒåŒ–

**æŒ‘æˆ˜ 2**: "ç«äº‰å¯¹æ‰‹éƒ½æ”¯æŒå¹¶è¡Œ"
- **å›åº”**: æˆ‘ä»¬çš„å·®å¼‚åŒ–æ˜¯**å¯è¿½æº¯+å¯å®¡è®¡**,ä¸æ˜¯é€Ÿåº¦

**æŒ‘æˆ˜ 3**: "å®¢æˆ·è¦æ±‚ 100% è‡ªåŠ¨åŒ–"
- **å›åº”**: æˆ‘ä»¬æä¾›**å¯ä¸­æ–­çš„è‡ªåŠ¨åŒ–**,å®¢æˆ·å¯ä»¥éšæ—¶ä»‹å…¥,æ›´å®‰å…¨

---

**å†»ç»“å†³ç­–çš„æœ€ç»ˆç›®æ ‡**:
> ä¿æŠ¤ Phase 2 çš„æ ¸å¿ƒä»·å€¼,é¿å…åŠŸèƒ½è •å˜,ç¡®ä¿ AgentOS çš„**å¯è§£é‡Šæ€§ã€å¯è¿½æº¯æ€§ã€å¯é æ€§**ä¸è¢«ç ´åã€‚

---

**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å†»ç»“
**ä¸‹æ¬¡å®¡æŸ¥**: 2026-04-29 (3 ä¸ªæœˆå)
**è´Ÿè´£äºº**: æ¶æ„å§”å‘˜ä¼š
