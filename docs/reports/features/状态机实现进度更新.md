# âš ï¸ çŠ¶æ€æœºå®ç°è¿›åº¦æ›´æ–°æŠ¥å‘Š (ä»£ç è¯æ®ç‰ˆ)

**ä»£ç è·¯å¾„**: `/agentos/core/task/`
**è¯„ä¼°æ—¶é—´**: 2026-01-29
**æ•´ä½“å®Œæˆåº¦**: **70%** (ä»55%æå‡)

---

## ğŸ¯ 5ç»´åº¦å®Œæˆåº¦åˆ†æ (åŸºäºä»£ç è¯æ®)

### âœ… 1. æ ¸å¿ƒä»£ç  (18/20%) - æå‡3%
**è¯æ®ä½ç½®**:
- `agentos/core/task/states.py`: å®Œæ•´çŠ¶æ€æšä¸¾ (DRAFTâ†’QUEUEDâ†’RUNNINGâ†’VERIFYINGâ†’DONE)
- `agentos/core/task/state_machine.py:30-64`: å®Œæ•´è½¬æ¢è¡¨ (åŒ…æ‹¬ retry è·¯å¾„)
- `agentos/core/task/service.py:592-622`: retry_failed_task() æ–¹æ³•
- `agentos/core/task/rollback.py:111-280`: å®Œæ•´ cancel è¯­ä¹‰å®ç°
- `agentos/core/runner/task_runner.py:107-112`: max_iterations æœºåˆ¶
- `agentos/core/gates/done_gate.py:469`: timeout_seconds å‚æ•°

**å·²å®ç°**:
- âœ… çŠ¶æ€æœºå®šä¹‰ (10ä¸ªçŠ¶æ€ + è½¬æ¢è¡¨)
- âœ… åå°å¼‚æ­¥æ‰§è¡Œ (TaskRunner.run_task)
- âœ… çŠ¶æ€è½¬æ¢è¿½è¸ª (audit log)
- âœ… åŸºç¡€å›æ»šæ”¯æŒ (cancel_draft/cancel_approved/cancel_queued)
- âœ… Gateå¤±è´¥è‡ªåŠ¨retryè·¯å¾„ (VERIFYINGâ†’QUEUED)
- âœ… Serviceå±‚retryæ–¹æ³• (retry_failed_task)

**ç¼ºå¤±**:
- â³ **Taskçº§åˆ«çš„retryç­–ç•¥é…ç½®** (å¦‚ metadata.max_retries)
- â³ **Retryè®¡æ•°å™¨å’Œé™åˆ¶** (é˜²æ­¢æ— é™retry)
- â³ **åŸºäºæ—¶é—´çš„Timeoutæœºåˆ¶** (å½“å‰åªæœ‰max_iterations)
- â³ **RunningçŠ¶æ€çš„Cancelå®ç°** (çŠ¶æ€æœºæ”¯æŒä½†Runnerç¼ºå¤±)

---

### âš ï¸ 2. æµ‹è¯•è¦†ç›– (12/20%) - é™ä½3%
**è¯æ®ä½ç½®**:
- `tests/unit/task/test_task_api_enforces_state_machine.py`: 200è¡Œ (çŠ¶æ€è½¬æ¢æµ‹è¯•)
- `tests/unit/task/test_task_rollback_rules.py`: Cancelæµ‹è¯•

**å·²å®ç°**:
- âœ… çŠ¶æ€è½¬æ¢å•å…ƒæµ‹è¯• (æ‰€æœ‰åŸºæœ¬è½¬æ¢è·¯å¾„)
- âœ… å®¡è®¡æ—¥å¿—æµ‹è¯•
- âœ… Cancelæ“ä½œæµ‹è¯•

**ç¼ºå¤±**:
- â³ **Retryç­–ç•¥æµ‹è¯•** (å¦‚å¤šæ¬¡å¤±è´¥åçš„è¡Œä¸º)
- â³ **Timeoutåœºæ™¯æµ‹è¯•** (è¶…æ—¶åçš„è‡ªåŠ¨å¤„ç†)
- â³ **å¹¶å‘Cancelæµ‹è¯•** (å¤šworkerå–æ¶ˆåŒä¸€ä»»åŠ¡)
- â³ **æ­»é”åœºæ™¯éªŒè¯** (retryå¾ªç¯æ£€æµ‹)

---

### âš ï¸ 3. æ–‡æ¡£ (10/20%) - ä¿æŒ
**è¯æ®ä½ç½®**:
- æ‰€æœ‰æ ¸å¿ƒæ–‡ä»¶éƒ½æœ‰è¯¦ç»†çš„ docstring
- `agentos/core/task/service.py:1-15`: æ¨¡å—çº§æ–‡æ¡£
- `agentos/core/task/rollback.py:1-21`: å®‰å…¨åŸåˆ™æ–‡æ¡£

**å·²å®ç°**:
- âœ… ä»£ç å†…åµŒdocstring (100%è¦†ç›–)
- âœ… æ¨¡å—çº§è®¾è®¡è¯´æ˜
- âœ… å…³é”®æ–¹æ³•çš„å‚æ•°å’Œè¿”å›å€¼æ–‡æ¡£

**ç¼ºå¤±**:
- â³ **ç‹¬ç«‹è¿ç»´æ‰‹å†Œ** (å¦‚ä½•é…ç½®retry/timeout)
- â³ **æ•…éšœæ’æŸ¥æŒ‡å—** (retryå¤±è´¥/timeoutè¯Šæ–­)
- â³ **æœ€ä½³å®è·µæ–‡æ¡£** (ä½•æ—¶ä½¿ç”¨cancel vs retry)

---

### âš ï¸ 4. é›†æˆéªŒè¯ (15/20%) - æå‡5%
**è¯æ®ä½ç½®**:
- `agentos/core/runner/task_runner.py:307-530`: å®Œæ•´æ‰§è¡Œæµç¨‹
- `agentos/core/runner/task_runner.py:519`: Gateå¤±è´¥è¿”å›planning
- `agentos/core/task/service.py:246-330`: create_approve_queue_and_start

**å·²å®ç°**:
- âœ… åŸºç¡€çŠ¶æ€æœºç«¯åˆ°ç«¯ (draftâ†’approvedâ†’queuedâ†’runningâ†’done)
- âœ… Gateå¤±è´¥retryæµç¨‹ (verifyingâ†’planningâ†’executing)
- âœ… å®¡è®¡æ—¥å¿—å®Œæ•´æ€§ (æ‰€æœ‰è½¬æ¢éƒ½æœ‰è®°å½•)

**ç¼ºå¤±**:
- â³ **æ‰‹åŠ¨retryç«¯åˆ°ç«¯æµ‹è¯•** (retry_failed_taskå®Œæ•´æµç¨‹)
- â³ **Timeoutç«¯åˆ°ç«¯æµ‹è¯•** (è¶…æ—¶åçš„è‡ªåŠ¨æ¸…ç†)
- â³ **Cancelè¿è¡Œä¸­ä»»åŠ¡æµ‹è¯•** (RUNNINGâ†’CANCELED)
- â³ **å¤šæ¬¡retryçš„ç«¯åˆ°ç«¯åœºæ™¯** (éªŒè¯retryé™åˆ¶)

---

### âœ… 5. è¿ç»´/è§‚æµ‹ (15/20%) - æå‡10%
**è¯æ®ä½ç½®**:
- `agentos/core/task/state_machine.py:234-265`: çŠ¶æ€è½¬æ¢å®¡è®¡
- `agentos/core/task/service.py:720-728`: add_auditæ–¹æ³•
- `agentos/core/task/manager.py:433-470`: exit_reasonè¿½è¸ª
- `agentos/core/runner/task_runner.py:532-542`: _log_auditæ–¹æ³•

**å·²å®ç°**:
- âœ… çŠ¶æ€å˜æ›´å®¡è®¡æ—¥å¿— (æ¯æ¬¡è½¬æ¢éƒ½è®°å½•actor/reason/metadata)
- âœ… exit_reasonå­—æ®µ (done/max_iterations/blocked/fatal_error/user_cancelled)
- âœ… è½¬æ¢å†å²æŸ¥è¯¢ (get_transition_history)
- âœ… å¤±è´¥è·¯å¾„é”™è¯¯ç  (exit_reasonæšä¸¾)

**ç¼ºå¤±**:
- â³ **Retryæ¬¡æ•°ç»Ÿè®¡** (metadataä¸­æ— retry_count)
- â³ **Timeoutå‘Šè­¦** (è¶…æ—¶åæ— ä¸»åŠ¨é€šçŸ¥)
- â³ **å¤±è´¥æ¨¡å¼åˆ†æ** (æ— retry patternåˆ†æ)

---

## ğŸ“Š å…³é”®å‘ç°

### âœ… è¶…é¢„æœŸå®ç°
1. **å®Œæ•´çš„Cancelè¯­ä¹‰** (`rollback.py`):
   - 3ç§cancelæ–¹æ³• (draft/approved/queued)
   - å®Œæ•´çš„å®¡è®¡è¿½è¸ª
   - å®‰å…¨åŸåˆ™æ–‡æ¡£

2. **Gateå¤±è´¥è‡ªåŠ¨retry** (`task_runner.py:519`):
   - éªŒè¯å¤±è´¥åè‡ªåŠ¨è¿”å›planningçŠ¶æ€
   - å¤±è´¥ä¸Šä¸‹æ–‡æ³¨å…¥metadata

3. **å®Œæ•´çš„çŠ¶æ€è½¬æ¢å®¡è®¡** (`state_machine.py:234-265`):
   - è®°å½•from_state/to_state/actor/reason
   - æ”¯æŒè½¬æ¢å†å²æŸ¥è¯¢

### âš ï¸ å…³é”®ç¼ºå£

#### ğŸ”´ P0 (é˜»å¡Supervisor/Lead Agent)
1. **Taskçº§åˆ«çš„retryç­–ç•¥é…ç½®**:
   ```python
   # ç¼ºå¤±: Task.metadata ä¸­æ— ä»¥ä¸‹é…ç½®
   {
     "retry_policy": {
       "max_retries": 3,
       "retry_count": 0,  # å½“å‰é‡è¯•æ¬¡æ•°
       "backoff_strategy": "exponential"
     }
   }
   ```
   - **å½±å“**: Supervisoræ— æ³•é™åˆ¶task retryæ¬¡æ•°
   - **ä½ç½®**: `agentos/core/task/models.py:28` (metadataå­—æ®µ)

2. **åŸºäºæ—¶é—´çš„Timeoutæœºåˆ¶**:
   ```python
   # ç¼ºå¤±: åŸºäºwallclockæ—¶é—´çš„è¶…æ—¶æ£€æµ‹
   # å½“å‰åªæœ‰ max_iterations (è¿­ä»£æ¬¡æ•°é™åˆ¶)
   ```
   - **å½±å“**: é•¿æ—¶é—´hangä½çš„taskæ— æ³•è‡ªåŠ¨è¶…æ—¶
   - **ä½ç½®**: `agentos/core/runner/task_runner.py:107`

3. **RunningçŠ¶æ€Cancelå®ç°**:
   ```python
   # çŠ¶æ€æœºæ”¯æŒ RUNNINGâ†’CANCELED
   # ä½† TaskRunner ç¼ºå¤±æ£€æµ‹å’Œä¸­æ–­é€»è¾‘
   ```
   - **å½±å“**: æ— æ³•å–æ¶ˆæ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡
   - **ä½ç½®**: `agentos/core/runner/task_runner.py:207-289`

#### ğŸŸ¡ P1 (å¢å¼ºå¯é æ€§)
1. **Retryå¾ªç¯æ£€æµ‹** (é˜²æ­¢æ— é™retry)
2. **Timeoutåçš„è‡ªåŠ¨æ¸…ç†** (é‡Šæ”¾èµ„æº)
3. **å¹¶å‘Cancelå®‰å…¨æ€§** (å¤šworkeråœºæ™¯)

---

## ğŸ¯ æå‡è·¯å¾„ (è¾¾åˆ°95%)

### Phase 1: Retryç­–ç•¥é…ç½® (2å¤©)
**ç›®æ ‡**: Taskçº§åˆ«çš„retryæ§åˆ¶

1. **æ¨¡å‹æ‰©å±•** (`models.py`):
   ```python
   # Task.metadata æ–°å¢å­—æ®µ
   {
     "retry_policy": {
       "max_retries": 3,
       "retry_count": 0,
       "last_retry_at": "2026-01-29T10:00:00Z",
       "backoff_ms": [1000, 2000, 4000]
     }
   }
   ```

2. **Runneré›†æˆ** (`task_runner.py`):
   - åœ¨ retry_failed_task å‰æ£€æŸ¥ retry_count < max_retries
   - æ›´æ–° retry_count å’Œ last_retry_at
   - è®°å½•retry auditäº‹ä»¶

3. **æµ‹è¯•** (`test_retry_strategy.py`):
   - éªŒè¯retryæ¬¡æ•°é™åˆ¶
   - éªŒè¯retry_counté€’å¢
   - éªŒè¯è¶…è¿‡max_retriesåfail

### Phase 2: æ—¶é—´Timeoutæœºåˆ¶ (1å¤©)
**ç›®æ ‡**: åŸºäºwallclockæ—¶é—´çš„è¶…æ—¶

1. **Runneræ”¹é€ ** (`task_runner.py:207`):
   ```python
   start_time = time.time()
   timeout_seconds = task.metadata.get("timeout_seconds", 3600)

   while iteration < max_iterations:
       if time.time() - start_time > timeout_seconds:
           exit_reason = "timeout"
           break
   ```

2. **æµ‹è¯•** (`test_timeout.py`):
   - éªŒè¯è¶…æ—¶æ£€æµ‹
   - éªŒè¯è¶…æ—¶åçŠ¶æ€ä¸ºfailed
   - éªŒè¯exit_reason="timeout"

### Phase 3: Running Cancelå®ç° (2å¤©)
**ç›®æ ‡**: æ”¯æŒå–æ¶ˆè¿è¡Œä¸­çš„ä»»åŠ¡

1. **Runneræ”¹é€ ** (`task_runner.py:210`):
   ```python
   while iteration < max_iterations:
       # æ£€æŸ¥cancelä¿¡å·
       task = self.task_manager.get_task(task_id)
       if task.status == "canceled":
           exit_reason = "user_cancelled"
           break
   ```

2. **Serviceæ–¹æ³•** (`service.py`):
   ```python
   def cancel_running_task(self, task_id, actor, reason):
       # RUNNING â†’ CANCELED
       pass
   ```

3. **æµ‹è¯•** (`test_cancel_running.py`):
   - éªŒè¯runningçŠ¶æ€å¯ä»¥cancel
   - éªŒè¯runneræ£€æµ‹åˆ°cancelåé€€å‡º
   - éªŒè¯auditæ—¥å¿—è®°å½•

---

## ğŸ“‹ éªŒæ”¶æ¸…å• (95%ç›®æ ‡)

### æ ¸å¿ƒä»£ç  (20/20%)
- [x] çŠ¶æ€æœºå®šä¹‰
- [x] åå°å¼‚æ­¥æ‰§è¡Œ
- [x] çŠ¶æ€è½¬æ¢è¿½è¸ª
- [x] åŸºç¡€å›æ»šæ”¯æŒ
- [ ] Taskçº§åˆ«retryç­–ç•¥é…ç½®
- [ ] åŸºäºæ—¶é—´çš„Timeoutæœºåˆ¶
- [ ] RunningçŠ¶æ€Cancelå®ç°

### æµ‹è¯•è¦†ç›– (18/20%)
- [x] çŠ¶æ€è½¬æ¢æµ‹è¯•
- [x] åå°æ‰§è¡Œæµ‹è¯•
- [ ] Retryç­–ç•¥æµ‹è¯•
- [ ] Timeoutåœºæ™¯æµ‹è¯•
- [ ] Cancelæµç¨‹æµ‹è¯•

### æ–‡æ¡£ (18/20%)
- [x] ä»£ç å†…åµŒdocstring
- [ ] Retry/Timeouté…ç½®æŒ‡å—
- [ ] è¿ç»´æ‰‹å†Œ

### é›†æˆéªŒè¯ (19/20%)
- [x] åŸºç¡€çŠ¶æ€æœºç«¯åˆ°ç«¯
- [x] Gateå¤±è´¥retryç«¯åˆ°ç«¯
- [ ] æ‰‹åŠ¨retryç«¯åˆ°ç«¯
- [ ] Timeoutç«¯åˆ°ç«¯
- [ ] Cancel runningç«¯åˆ°ç«¯

### è¿ç»´/è§‚æµ‹ (19/20%)
- [x] çŠ¶æ€å˜æ›´å®¡è®¡æ—¥å¿—
- [x] exit_reasonè¿½è¸ª
- [x] è½¬æ¢å†å²æŸ¥è¯¢
- [ ] Retryæ¬¡æ•°ç»Ÿè®¡
- [ ] Timeoutå‘Šè­¦

---

## ğŸš¨ é˜»å¡æƒ…å†µ

**å½“å‰é˜»å¡**:
- âŒ Supervisoræ— æ³•æ§åˆ¶task retryæ¬¡æ•° (ç¼ºretryç­–ç•¥é…ç½®)
- âŒ Lead Agentæ— æ³•è®¾ç½®taskè¶…æ—¶æ—¶é—´ (ç¼ºtimeoutæœºåˆ¶)

**è§£é”æ—¶é—´**:
- ğŸŸ¢ Phase 1+2: **5å¤©** (è¾¾åˆ°85%, éƒ¨åˆ†è§£é”)
- ğŸŸ¢ Phase 1+2+3: **7å¤©** (è¾¾åˆ°95%, å®Œå…¨è§£é”)

---

## ğŸ“Œ è¯æ®ç´¢å¼•

### çŠ¶æ€æœºå®ç°
- **çŠ¶æ€å®šä¹‰**: `agentos/core/task/states.py:13-127`
- **è½¬æ¢è¡¨**: `agentos/core/task/state_machine.py:30-64`
- **è½¬æ¢æ‰§è¡Œ**: `agentos/core/task/state_machine.py:157-313`

### Retryå®ç°
- **Serviceå±‚**: `agentos/core/task/service.py:592-622`
- **Gateå¤±è´¥retry**: `agentos/core/runner/task_runner.py:519`
- **è½¬æ¢è¡¨æ”¯æŒ**: `agentos/core/task/state_machine.py:59,63`

### Cancelå®ç°
- **Rollback Service**: `agentos/core/task/rollback.py:111-280`
- **è½¬æ¢è¡¨æ”¯æŒ**: `agentos/core/task/state_machine.py:33,40,45,52,60`

### Timeoutå®ç°
- **Max iterations**: `agentos/core/runner/task_runner.py:107-112,284-288`
- **Gate timeout**: `agentos/core/gates/done_gate.py:469`

### æµ‹è¯•è¦†ç›–
- **çŠ¶æ€æœºæµ‹è¯•**: `tests/unit/task/test_task_api_enforces_state_machine.py:1-200+`
- **Rollbackæµ‹è¯•**: `tests/unit/task/test_task_rollback_rules.py`

### å·¥å…·çº§Retry (éTaskçº§)
- **RetryPolicy**: `agentos/ext/tools/retry_policy.py:1-186`
  - æŒ‡æ•°é€€é¿/å›ºå®šå»¶è¿Ÿ/çº¿æ€§é€€é¿
  - **æ³¨æ„**: è¿™æ˜¯å·¥å…·é€‚é…å™¨çº§åˆ«çš„retry,ä¸æ˜¯Taskçº§åˆ«çš„

---

## ğŸ‰ æ€»ç»“

**å®Œæˆåº¦ä» 55% æå‡åˆ° 70%** (åŸºäºä»£ç è¯æ®)

**äº®ç‚¹**:
1. âœ… å®Œæ•´çš„çŠ¶æ€æœºè½¬æ¢è¡¨å’ŒéªŒè¯é€»è¾‘
2. âœ… å®Œå–„çš„Cancelè¯­ä¹‰å’Œå®¡è®¡è¿½è¸ª
3. âœ… Gateå¤±è´¥è‡ªåŠ¨retryæœºåˆ¶

**æ ¸å¿ƒç¼ºå£**:
1. â³ Taskçº§åˆ«çš„retryç­–ç•¥é…ç½®å’Œé™åˆ¶
2. â³ åŸºäºæ—¶é—´çš„Timeoutæœºåˆ¶
3. â³ RunningçŠ¶æ€çš„Cancelå®ç°

**å»ºè®®ä¼˜å…ˆçº§**: Phase 1 (Retryç­–ç•¥) > Phase 2 (Timeout) > Phase 3 (Cancel Running)
